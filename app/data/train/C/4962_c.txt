#include <s3c2440_addr.h>
#include <intirq.h>
#include <stdio.h>

static inline void Timer0_Handle(void);
static inline void Dma0_Handle(void);

void (*isr_handle_array[MAX_IRQ])(void) ;

static void Dummy_isr(void)
{
    printf("Dummy_isr\n\r");
    while(1);
}

void init_irq(void)
{
    int i = 0;
    for (i = 0; i < sizeof(isr_handle_array) / sizeof(isr_handle_array[0]); i++)
    {
        isr_handle_array[i] = Dummy_isr;
    }
    INTMOD = 0x0;	      // ËùÓÐÖÐ¶Ï¶¼ÉèÎªIRQÄ£Ê½
    INTMSK = BIT_ALLMSK;  // ÏÈÆÁ±ÎËùÓÐÖÐ¶Ï
}

int register_interrupt(unsigned int vector_num,void (*vector_handle)(void))
{
    if(vector_num > (MAX_IRQ - 1)){
        printf("Invalid inteerupt vector num.\n");
        return -1;
    }
    isr_handle_array[vector_num] = vector_handle;
    INTMSK &= ~(1 << vector_num);
    return 0;
}

/*
*	C interrupt code entry
*/
void C_IRQ_Handler(int i,int j)
{
	unsigned long oft = INTOFFSET;

	//ÇåÖÐ¶Ï
	if (oft == 4)
        EINTPEND = 1 << 7;    //EINT4-7ºÏÓÃIRQ4£¬×¢ÒâEINTPEND[3:0]±£ÁôÎ´ÓÃ£¬ÏòÕâÐ©Î»Ð´Èë1¿ÉÄÜµ¼ÖÂÎ´Öª½á¹û
	SRCPND = 1 << oft;
	INTPND = INTPND;

    /* µ÷ÓÃÖÐ¶Ï·þÎñ³ÌÐò */
    isr_handle_array[oft]();
}

/*timer0 hanlder*/
static void Timer0_Handle(void)
{
	static int num = 0;
	//every 1s change the led status
	GPBDAT = (num & 0xf) << 5;
	num++;
}
extern int dma_flag;

/*dma0 interrupt handler*/
static void Dma0_Handle(void)
{
     dma_flag = 1;
	/*set beep ring*/
	GPBDAT = 0b1001 << 5;
}
