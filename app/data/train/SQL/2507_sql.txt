CREATE DATABASE IF NOT EXISTS PHPForum;
use PHPForum;

CREATE TABLE `user` (
  userId int NOT NULL,
  username VARCHAR(20) NOT NULL,
  email VARCHAR(20) NOT NULL,
  password VARCHAR(60) NOT NULL,
  isAdmin BOOLEAN NOT NULL
);


CREATE TABLE profilePicture (
  userId int NOT NULL,
  `data` BLOB NOT NULL
);

CREATE TABLE forum (
  forumId int NOT NULL,
  name VARCHAR(20) NOT NULL,
  lastUpdated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE tag (
  tagId int NOT NULL,
  name VARCHAR(15) NOT NULL,
  mainTagId int
);

CREATE TABLE discussion (
  discussionId int NOT NULL,
  forumId int NOT NULL,
  title VARCHAR(20) NOT NULL,
  content TEXT NOT NULL,
  creatorId int NOT NULL,
  dateCreated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  lastUpdated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  isQuestion BOOLEAN,
  isOpen BOOLEAN DEFAULT TRUE
);

CREATE TABLE discussion_tag (
  discussionId int NOT NULL,
  tagId int NOT NULL
);

CREATE TABLE subscribed_discussion (
  discussionId int NOT NULL,
  userId int NOT NULL
);

CREATE TABLE discussionPost (
  postId int NOT NULL,
  creatorId int NOT NULL,
  discussionId int NOT NULL,
  title VARCHAR(50),
  content TEXT NOT NULL,
  dateCreated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


ALTER TABLE `user` ADD CONSTRAINT pk_user PRIMARY KEY (userId);
ALTER TABLE `user` CHANGE userId userId int NOT NULL AUTO_INCREMENT;
ALTER TABLE `user` ADD CONSTRAINT unique_user_name UNIQUE (username);

ALTER TABLE profilePicture ADD CONSTRAINT pk_picture PRIMARY KEY (userId);
ALTER TABLE profilePicture ADD CONSTRAINT fk_picture_user FOREIGN KEY (userId) REFERENCES `user`(userId);

ALTER TABLE forum ADD CONSTRAINT pk_forum PRIMARY KEY (forumId);
ALTER TABLE forum CHANGE forumId forumId int NOT NULL AUTO_INCREMENT;

ALTER TABLE tag ADD CONSTRAINT pk_tag PRIMARY KEY (tagId);
ALTER TABLE tag CHANGE tagId tagId int NOT NULL AUTO_INCREMENT;
ALTER TABLE tag ADD CONSTRAINT fk_tag_tag FOREIGN KEY (mainTagId) REFERENCES tag(tagId);

ALTER TABLE discussion ADD CONSTRAINT pk_discussion PRIMARY KEY (discussionId);
ALTER TABLE discussion ADD CONSTRAINT fk_discussion_forum FOREIGN KEY (forumId) REFERENCES forum(forumId);
ALTER TABLE discussion ADD CONSTRAINT fk_discussion_user FOREIGN KEY (creatorId) REFERENCES `user`(userId);
ALTER TABLE discussion CHANGE discussionId discussionId int NOT NULL AUTO_INCREMENT;

ALTER TABLE discussion_tag ADD CONSTRAINT pk_discussionTag PRIMARY KEY (discussionId, tagId);
ALTER TABLE discussion_tag ADD CONSTRAINT fk_discussionTag_discussion FOREIGN KEY (discussionId) REFERENCES discussion(discussionId);
ALTER TABLE discussion_tag ADD CONSTRAINT fk_discussionTag_tag FOREIGN KEY (tagId) REFERENCES tag(tagId);

ALTER TABLE subscribed_discussion ADD CONSTRAINT pk_subDiscussion PRIMARY KEY (discussionId, userId);
ALTER TABLE subscribed_discussion ADD CONSTRAINT fk_subDiscussion_discussion FOREIGN KEY (discussionId) REFERENCES discussion(discussionId);
ALTER TABLE subscribed_discussion ADD CONSTRAINT fk_subDiscussion_user FOREIGN KEY (userId) REFERENCES `user`(userId);

ALTER TABLE discussionPost ADD CONSTRAINT pk_discussionPost PRIMARY KEY (postId);
ALTER TABLE discussionPost ADD CONSTRAINT fk_discussionPost_user FOREIGN KEY (creatorId) REFERENCES `user`(userId);
ALTER TABLE discussionPost ADD CONSTRAINT fk_discussionPost_discussion FOREIGN KEY (discussionId) REFERENCES discussion(discussionId);