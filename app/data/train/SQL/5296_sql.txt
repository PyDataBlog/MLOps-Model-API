DELIMITER $$
DROP PROCEDURE IF EXISTS `SmartHome`.`FindTasks`$$
CREATE PROCEDURE `FindTasks` (
    IN $Filter           NVARCHAR(1024),
    IN $PointCategorySet NVARCHAR(2048),
    IN $StateSet         NVARCHAR(2048),
    IN $TypeSet          NVARCHAR(2048),
    IN $Page             INT,
    IN $Count            INT,
    OUT $TotalResult     INT
)
BEGIN
    declare lFilter NVARCHAR(1024);
    
    if ($Filter is not null) then
        set lFilter = CONCAT('%', $Filter, '%'); -- дич
    end if;

    if $Count is null or $Count < 1 then
        set $Count = 10;
    end if;
    
    if $PointCategorySet = '' then
        set $PointCategorySet = null;
    end if;

    if $StateSet = '' then
        set $StateSet = null;
    end if;

    if $TypeSet = '' then
        set $TypeSet = null;
    end if;
    
    if $Page is null or $Page > 0 then
        set $Page = ($Page - 1) * $Count;
    end if;

    select SQL_CALC_FOUND_ROWS 
    t.*
    from `Task` as t
    inner join `Point` p on p.PointId = t.PointId 
    where 1 = 1
        and (lFilter is null or (t.Description like lFilter or t.`Name` like lFilter ))
        and ($StateSet is null or FIND_IN_SET(t.StateId, $StateSet))
        and ($PointCategorySet is null or FIND_IN_SET(p.PointCategoryId, $PointCategorySet))
        and ($TypeSet is null or FIND_IN_SET(p.PointTypeId, $TypeSet))
    order by t.TaskId asc
    limit $Count offset $Page;
    
    set $TotalResult = FOUND_ROWS();

END$$
DELIMITER ;