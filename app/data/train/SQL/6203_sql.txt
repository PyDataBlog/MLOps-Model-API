create or replace procedure p_qlfw_houseid_new_fx_dongh as
--½â¾öÒ»¸öhouseid_new¶ÔÓ¦¶à¸özh_dongh£¬»òÕßÍ¬Ò»¸öhouseid_newµÄÊý¾Ý²¿·Ö¶ÔÓ¦zh_donghÎª¿Õ²¿·ÖÓÐÖµ
--houseid_newÓëzh_donghÒ»¶Ô¶à£º·´Ð´Çå¿Õzh_dongh
--houseid_newÓëzh_donghÒ»¶ÔÒ»£¬µ«´æÔÚ²¿·Özh_donghÎªnull£¬·´Ð´²¹³ä
begin
--Ò»¶Ô¶àÇå¿Õ
update tmp_fk_qsdj_qlfw q
   set q.zh_dongh = null, q.zh_source = 12
 where q.houseid_new in
       (select q.houseid_new
          from tmp_fk_qsdj_qlfw q
         where q.houseid_new is not null
         group by q.houseid_new
        having count(distinct zh_dongh) > 1);
commit;
--²¿·Özh_donghÎªnull,²¹³ä
if is_tab_exist('t_houseid_new_fx1') then
  execute immediate 'drop table t_houseid_new_fx1';
end if;
execute immediate '
create table t_houseid_new_fx1 as
select distinct q.houseid_new,q.zh_dongh from tmp_fk_qsdj_qlfw q
 where q.houseid_new in
       (select q.houseid_new
          from tmp_fk_qsdj_qlfw q
         where q.houseid_new is not null
         group by q.houseid_new
        having count(distinct zh_dongh) = 1 and count(distinct nvl(zh_dongh, ''@#$'')) > 1)
        and q.zh_dongh is not null
';
execute immediate '
update tmp_fk_qsdj_qlfw q
   set q.zh_source = 11,
       q.zh_dongh =
       (select t1.zh_dongh
          from t_houseid_new_fx1 t1
         where t1.houseid_new = q.houseid_new)
 where exists (select 1
          from t_houseid_new_fx1 t1
         where t1.houseid_new = q.houseid_new)
   and q.zh_dongh is null
';
commit;

end;
