--
-- PROCEDURE: REGISTER NEW QUEUE
-- Inserts new queue values into main_index
--

DROP PROCEDURE IF EXISTS `new_queue`;

DELIMITER $$

CREATE PROCEDURE `new_queue` (
	p_queue_name VARCHAR(64),
	p_enabled TINYINT(1)
) 
BEGIN 

DECLARE q_queue_name, q_queue_index_table_name, q_queue_year_summarize_table VARCHAR(64);
DECLARE q_last_checked_date INT;
DECLARE q_enabled_queue TINYINT(1);
DECLARE queue_id INT(11);
DECLARE query VARCHAR(333);

SET @q_queue_name = p_queue_name;
SET @q_last_checked_date = '0';
SET @q_enabled_queue = p_enabled;

SET @query = "INSERT INTO `main_index` (queue_name, last_checked_date, enabled_queue) VALUES (?,?,?)";
PREPARE stmt FROM @query;
EXECUTE stmt USING @q_queue_name,  @q_last_checked_date, @q_enabled_queue;
DEALLOCATE PREPARE stmt;

SET @queue_id = 0;
SELECT id INTO @queue_id FROM main_index WHERE queue_name = p_queue_name;

SET @q_queue_year_summarize_table = CONCAT("queue_",@queue_id,"_year_summarize_charts");
SET @q_queue_index_table_name = CONCAT("queue_",@queue_id,"_index");
SET @query = "UPDATE `main_index` SET queue_index_table_name = ?, queue_year_summarize_table = ? WHERE id = ?";
PREPARE stmt FROM @query;
EXECUTE stmt USING @q_queue_index_table_name,@q_queue_year_summarize_table, @queue_id;
DEALLOCATE PREPARE stmt; 

END$$

DELIMITER ;
