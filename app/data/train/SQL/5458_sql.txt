with allclasses as (
    select
        classes.class as class
    from
        classes
), sunks as (
    select
        outcomes.ship as ship, classes.class as sclass
    from
        outcomes inner join classes on (outcomes.ship = classes.class)
    where
        result = 'sunk'
    union
    select
        outcomes.ship as ship, ships.class as sclass
    from
        outcomes inner join ships on (ships.name = outcomes.ship)
    where
        result = 'sunk'
)
select
    allclasses.class, sum(case when ship is null then 0 else 1 end)
from
    allclasses left join sunks on (allclasses.class = sunks.sclass)
group by
    allclasses.class
