--
-- PostgreSQL database dump
--
-- Dumped from database version 9.5.10
-- Dumped by pg_dump version 9.5.5
SET statement_timeout = 0;
SET lock_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SET check_function_bodies = false;
SET client_min_messages = warning;
SET row_security = off;
SET search_path = api, pg_catalog;
--
-- Name: organization_group_member_demote(integer, integer); Type: FUNCTION; Schema: api; Owner: postgres
--
CREATE FUNCTION organization_group_member_demote(p_account_id integer, p_organization_group_member_id integer) RETURNS integer
    LANGUAGE plpgsql
    AS $$
	DECLARE
		v_organization_group_member_id int;
		v_organization_group_id int;
		BEGIN
		/*
			Author: 	Daniel Egli
			Created: 	April 7, 2016
			Description:
				Demotes an existing organization group administrator's privileges to member
			Parameters
				p_account_id: 				the primary key of the account making the database api call (public.account.id)
				p_organization_group_member_id:	the primary key of the organization group member getting demoted from administrator to member
			Success:
				Returns the id of the demoted member
			Failure:
				Returns no value
			Change Log:
				Daniel Egli on April 20, 2016: Added function documentation and clean indentation
		*/
			--Find the organization_group_id for the organization group member getting promoted
			SELECT organization_group_id
			INTO v_organization_group_id
			FROM organization_group_member cgm
			WHERE cgm.id = p_organization_group_member_id;
			--Update the organization group member if the calling account is authorized to demote organization group members
			UPDATE organization_group_member
			SET
				administrator = false,
				update_date = now()
			WHERE
				--check that the calling account is an admin at a organization that is a group admin
				(SELECT * FROM public.is_organization_group_admin(p_account_id, v_organization_group_id))
				--update the organization group member passed into the function
				AND id = p_organization_group_member_id
			RETURNING id INTO v_organization_group_member_id;
			RETURN v_organization_group_member_id;
		END;
		
$$;
ALTER FUNCTION api.organization_group_member_demote(p_account_id integer, p_organization_group_member_id integer) OWNER TO postgres;
--
-- PostgreSQL database dump complete
--
