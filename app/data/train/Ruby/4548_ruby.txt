require 'rails_helper'

RSpec.describe Admin::ExportController do
  let(:plain_user) { create(:user) }
  let(:admin_user) { create(:admin) }

  describe 'GET row Export Positions to Org' do
    it 'runs the RowExportPositionsToOrgsJob class' do
      establish_current_user(admin_user)
      p1 = create(:position, position_code: 'S97956')
      o1 = create(:org_hierarchy, alpha_numeric: 'H30')
      p1.org_hierarchies << o1
      get :row_export_positions_to_org
      expect(response.body).to include('Position,Org Code')
      expect(response.body).to include('S97956,H30')
    end

    it 'requires admin privs' do
      establish_current_user(plain_user)
      # don't actually start the job!
      allow_any_instance_of(RowExportPositionsToOrgsJob).to receive(:perform)
      get :row_export_positions_to_org
      expect(response.status).to eq(403)
    end
  end
end
