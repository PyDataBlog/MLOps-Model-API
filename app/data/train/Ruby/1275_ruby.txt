# This recipe configures the authentication type for the TeamCity server

# Prepare to restart the service if changes are instituted
service "TeamCity" do
  action :nothing
  supports :status => true, :start => true, :stop => true, :restart => true
end

# Set authentication configuration and restart the service
auth_type = node['teamcity']['authentication']['type']
include_recipe "chef-teamcity::_config"

if auth_type == 'default' or auth_type == 'windows'
  template "#{node.run_state['data_folder']}/config/auth-config.xml" do
    source "auth-config.xml.erb"
    variables(
      :default_domain => node['teamcity']['authentication']['default_domain']
    )
    notifies :restart, 'service[TeamCity]', :delayed
  end
else
  raise "Configuring LDAP authentication is not yet supported"
end
