require 'uri'
require 'watchmob/page'

module Watchmob
  class HeurekaSearchPage < Page
    def self.search(phrase)
      encoded_phrase = URI.encode_www_form_component(phrase)
      new("http://mobilni-telefony.heureka.cz/f:q:#{encoded_phrase}", phrase)
    end

    def initialize(uri, phrase = nil)
      super(uri)
      @phrase = phrase
    end

    attr_reader :phrase

    def first_result_uri
      if document.at_css("#product-container")
        found_uri = document.css("#product-container .p").
          map { |search_result| URI.parse(search_result.at_css("h2 a").attr("href")) }.
          first

        return found_uri unless found_uri.nil?
      end

      raise NotFoundError, "There were no smartphones for #{phrase.inspect} on Heureka"
    end
  end
end

