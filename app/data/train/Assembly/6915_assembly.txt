;-------------------------------------------------------------------------
;  By Johnny Starr (c) 2014
;-------------------------------------------------------------------------
; TODO List:

;-------------------------------------------------------------------------
            processor 6502
            include "./libs/macro.h"
            include "./libs/vcs.h"
;-------------------------------------------------------------------------
;  Equates and Variables
;-------------------------------------------------------------------------
            SEG.U   Variables
            ORG     $80
;-------------------------------------------------------------------------
;  Setup
;-------------------------------------------------------------------------
            SEG     Program
            ORG     $F000           ; ROM begins here
Start:
            SEI                     ; disable interrupts
            CLD                     ; clear decimal mode
            LDX     #$FF            ; 256
            TXS                     ; initialize stack
            LDA     #0              ; zero
ClearMem:
            STA     0,X             ; clear zero page, all RAM actually
            DEX                     ; decrease X
            BNE     ClearMem        ; loop
;-------------------------------------------------------------------------
;  Frame
;-------------------------------------------------------------------------
Main:       
            LDA     #%00000010      ; D1 = 1
            STA     VSYNC           ; enable VSYNC
            STA     VBLANK          ; disable video
            STA     WSYNC           ; send WSYNC signal for VSYNC
            STA     WSYNC           ; 2
            STA     WSYNC           ; 3
            LDA     #0              ; zero
            STA     VSYNC           ; turn off VSYNC

            LDA     #46             ; setup timer for vblank #46
            STA     TIM64T          ; 37 scan-lines * 76 / 64 = 44 (46)
             
            ;-------------------------------------------------------------
            ;  begin game logic (vblank)
            ;-------------------------------------------------------------

            ;-------------------------------------------------------------
            ;  end game logic
            ;-------------------------------------------------------------
            
WaitVB:
            LDA     INTIM           ; check Vertical Blank timer
            BNE     WaitVB          ; repeat until zero
        
            
            LDA     #0              ; zero
            STA     VBLANK          ; enable video

            ;-------------------------------------------------------------
            ;  Kernels
            ;------------------------------------------------------------- 

            LDY     #192
Kernel:
            STA     WSYNC
            DEY     
            BNE     Kernel

            ;-------------------------------------------------------------
            ;  end Kernels
            ;-------------------------------------------------------------
            
            LDA     #%01000010      ; get ready to activate VBLANK
            STA     VBLANK          ; disable video
            
            LDA     #35             ; setup timer for overscan #35
            STA     TIM64T          ; 30 scan-lines * 76 / 64 = 35

            ;-------------------------------------------------------------
            ;  begin game logic (overscan)
            ;-------------------------------------------------------------
            
            ;-------------------------------------------------------------
            ;  end game logic
            ;-------------------------------------------------------------
            
WaitOS:     
            LDA     INTIM           ; check Overscan timer
            BNE     WaitOS          ; repeat until zero
            JMP     Main            ; begin next frame
;-------------------------------------------------------------------------
;  Data Tables
;-------------------------------------------------------------------------

;-------------------------------------------------------------------------
;  Vectors
;-------------------------------------------------------------------------
            ORG     $FFFC           ; End of ROM, 4K Total 
            .WORD   Start           ; NMI
            .WORD   Start           ; RESET
