section .text
global EntryPoint

%define RVA(x) x - 0x00400000
%define MiaGetProcAddress dword [MIA_Function1]

EntryPoint:
push dword function2
mov eax, MiaGetProcAddress
xor ax, ax
mov [mia_base], eax
push eax
call MiaGetProcAddress
call eax
mov cl, al
neg cl
and cl, 's'
mov [c], cl
neg al
and al, 'r'-'7'
add al, '7'
mov [b], al
push dword function1
push dword [mia_base]
call MiaGetProcAddress
test eax, eax
jz .return
push dword a
call eax
.return:
ret

function1 db "MiaThisIsWitchCraft", 0
function2 db "MiaCheckInt151Support", 0

section .data
mia_base dd 0
a: db "win"
b: db 0x30
c: db "sp1_gdr"

section .idata

dd 0
dd 0
dd 0
dd RVA(MIA_name)
dd RVA(MIA_imports)

dd 0
MIA_imports:
MIA_Function1:
dd 0x80000025 ; MiaGetProcAddress
dd 0
dd 0
MIA_name db "MIA.DLL", 0
