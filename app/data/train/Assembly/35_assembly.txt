; master library - MS-DOS
;
; Description:
;	¬æ¾(64KÈà)
;
; Functions:
;	unsigned smem_wget( unsigned bytesize ) ;
;
; Returns:
;	smem_wget
;		InsufficientMemory(cy = 1) s«
;		segment           (cy = 0) mÛµ½
;
; Notes:
;	WX^ÍAXÌÝðjóµÜ·B
;	Ü¾ªèÄçêÄ¢È¢êAmem_assign_all()ðÀsµÜ·B
;	smem_wget(0)ÆµÄÄÑo·ÆA»ÝÌöÊuª¾çêÜ·B
;
; Revision History:
;	93/ 3/20 Initial
;	93/ 9/14 [M0.21] `ªÌ¸ð mem_TopHeap -> mem_TopSeg ÉC³
;	95/ 3/23 [M0.22k] BUGFIX assignmÛ³êÄÈ¢Æ«Éc
;

	.MODEL SMALL
	include func.inc
	include super.inc

	.DATA
	EXTRN mem_TopSeg:WORD
	EXTRN mem_TopHeap:WORD
	EXTRN mem_EndMark:WORD

	.CODE
	EXTRN MEM_ASSIGN_ALL:CALLMODEL

retfunc ASSIGNALL
	call	MEM_ASSIGN_ALL
	jc	short W_ERROR2
	; ºÉ±­æ
endfunc
	; unsigned smem_wget( unsigned bytesize ) ;
func SMEM_WGET
	cmp	mem_TopSeg,0	; house keeping
	je	short ASSIGNALL

	push	BX
	mov	BX,SP

	; ø
	byte_size = (RETSIZE+1)*2

	mov	BX,SS:[BX+byte_size]
	add	BX,15		;Øèã°
	rcr	BX,1		;paragraph size
	shr	BX,1
	shr	BX,1
	shr	BX,1

	mov	AX,mem_EndMark
	add	BX,AX
	jc	short W_ERROR	; more safety...

	cmp	mem_TopHeap,BX
	jc	short W_ERROR

	mov	mem_EndMark,BX
	pop	BX
	ret	2
	EVEN

W_ERROR:
	pop	BX
W_ERROR2:
	mov	AX,InsufficientMemory
	ret	2
endfunc

END
