locals
jumps

.model large, WINDOWS PASCAL

; Ïîäêëþ÷àåì ôàéë îïèñàíèÿ êîíñòàíò è ñòðóêòóð API

include windows.inc

; Îïèñûâàåì èñïîëüçóåìûå ôóíêöèè

extrn   BEGINPAINT:PROC
extrn   CREATEWINDOW:PROC
extrn   DEFWINDOWPROC:PROC
extrn   DISPATCHMESSAGE:PROC
extrn   ENDPAINT:PROC
extrn   GETMESSAGE:PROC
extrn   GETSTOCKOBJECT:PROC
extrn   INITAPP:PROC
extrn   INITTASK:PROC
extrn   LOADCURSOR:PROC
extrn   MESSAGEBOX:PROC
extrn   POSTQUITMESSAGE:PROC
extrn   REGISTERCLASS:PROC
extrn   SHOWWINDOW:PROC
extrn   TEXTOUT:PROC
extrn   TRANSLATEMESSAGE:PROC
extrn   UPDATEWINDOW:PROC
extrn   WAITEVENT:PROC


.data

; Äëÿ Windows Task Manager

		db	16 dup(0)

; HINSTANCE íàøåãî ïðèëîæåíèÿ

hInstance	dw	?

; Ïàðàìåòð ïðîñìîòðà îêíà 

cmdShow		dw	?

; Ñòðóêòóðà PAINTSTRUCT

lppaint     PAINTSTRUCT <0>

; Ñòðóêòóðà ñîîáùåíèÿ MSGSTRUCT

msg         MSGSTRUCT   <0>

; Ñòðóêòóðà îïèñàíèÿ îêíà

wc          WNDCLASS    <0>

; Çàãîëîâîê îêíà

lpszTitleName     db 'First Window',0

; Íàçâàíèå êëàññà îêíà

lpszClassName     db 'ASMCLASS',0

; Âûâîäèìàÿ â îêíî ñòðîêà

lpszText	db	'Hello World'

; Äëèíà ñòðîêè lpszText

lpszTextLength	equ	$-lpszText

; Çàãîëîâîê äèàëîãîâîãî îêíà

lpszCaption	db	'Mouse Event',0

; Ñîîáùåíèÿ äèàëîãîâîãî îêíà

lpszLeftMsg	db	'Left button pressed',0
lpszRightMsg	db	'Right button pressed',0

.code
.286

; Êàê ãîâîðèòüÿ â WarLords "Lets The War Begins"

start:

; Èíèöèàëèçèðóåì çàäà÷ó è ïîëó÷àåì âõîäíûå ïàðàìåòðû

	call	INITTASK
	or	ax,ax

; Åñëè èíèöèàëèçàöèÿ ïðîøëà óñïåøíî 

	jnz	@@OK

; Åñëè îøèáêà 

	jmp	@@Fail

@@OK: 

; Ñîõðàíÿåì HINSTANCE

	mov	[hInstance],di

; Ñîõðàíÿåì ïàðàìåòð ïðîñìîòðà îêíà

	mov	[cmdShow],dx

; Èíèöèàëèçèðóåì ïðèëîæåíèå

	call	INITAPP,hInstance
	or	ax,ax
	jnz	@@InitOK

@@Fail:

; Åñëè èíèöèàëèçàöèÿ çàâåðøèëàñü íåóäà÷íî

	mov	ax, 4CFFh
	int	21h          ; terminate program


@@InitOK:

; Çàïîëíÿåì ñòðóêòóðó îïèñàíèÿ îêíà
	
	mov	[wc.clsStyle],0
	mov	word ptr [wc.clsLpfnWndProc],offset WndProc
	mov	word ptr [wc.clsLpfnWndProc+2],seg WndProc
	mov	[wc.clsCbClsExtra],0
	mov	[wc.clsCbWndExtra],0
	mov	ax,[hInstance]
	mov	[wc.clsHInstance],ax
	mov	[wc.clsHIcon],0

; Çàãðóæàåì êóðñîð IDC_ARROW è âñòàâëÿåì åãî â ñòðóêòóðó

	xor	ax,ax
	call   	LOADCURSOR,ax IDC_ARROW
	mov    	[wc.clsHCursor],ax

; Çàãðóæàåì öâåò áåëîãî ôîíà è âñòàâëÿåì åãî â ñòðóêòóðó

	call   	GETSTOCKOBJECT,WHITE_BRUSH
	mov    	[wc.clsHbrBackground],ax

	mov    	word ptr [wc.clsLpszMenuName],0
	mov    	word ptr [wc.clsLpszMenuName+2],0

	mov    	word ptr [wc.clsLpszClassName],offset lpszClassName
	mov    	word ptr [wc.clsLpszClassName+2],ds

; Ðåãèñòðèðóåì ñòðóêòóðó îïèñàíèÿ îêíà

	call   	REGISTERCLASS,ds offset wc

; Ñîçäàåì îêíî

	xor	ax,ax
	mov	bx,CW_USEDEFAULT
	call	CREATEWINDOW,ds offset lpszClassName,ds offset lpszTitleName,\
		             WS_OVERLAPPEDWINDOW,ax,bx,bx,bx,bx,ax,ax,\
			     [hInstance],ax,ax

; Ïîêàçûâàåì îêíî

	push	ax
	call	SHOWWINDOW,ax,cmdShow

; Îáíîâëÿåì îêíî

	pop	ax
	call	UPDATEWINDOW,ax

; Öèêë îáðàáîòêè ñîîáùåíèé

msg_loop:

; Ïîëó÷àåì ñîîáùåíèå

	call	GETMESSAGE,ds offset msg,0,0,0

; Ïðîâåðÿåì íà íàëè÷èå ñîîáùåíèÿ WM_QUIT (AX=0)

	cmp	ax,0
	je	end_loop

; Îáðàáàòûâàåì ñîîáùåíèå

	call	TRANSLATEMESSAGE,ds offset msg

	call	DISPATCHMESSAGE,ds offset msg

; Îáðàáàòûâàåì ñëåäóþùåå ñîîáùåíèå

	jmp	msg_loop

end_loop:

; Âûõîäèì èç ïðîãðàììû

	mov	ax,[msg.msWPARAM]
	mov	ah,4Ch
	int	21h

;
; Ïðîöåäóðà îáðàáîòêè ñîîáùåíèé
;

WndProc		PROC
	ARG	hwnd:WORD,wmsg:WORD,wparam:WORD,lparam:DWORD

	cmp	[wmsg],WM_DESTROY

; Åñëè ïîëó÷èëè ñîîáùåíèå WM_DESTROY (ïîëó÷åíî ñîîáùåíèå "íà âûõîä")

	je	wmdestroy
	cmp	[wmsg],WM_LBUTTONDOWN

; Åñëè ïîëó÷èëè ñîîáùåíèå WM_LBUTTONDOWN (íàæàòà ëåâàÿ êíîïêà ìûøè)

	je	wmlbuttondown
	cmp	[wmsg],WM_CREATE

; Åñëè ïîëó÷èëè ñîîáùåíèå WM_CREATE (ïîëó÷åíî ñîîáùåíèå "ñîçäàòü îêíî")

	je	wmcreate
	cmp	[wmsg],WM_RBUTTONDOWN

; Åñëè ïîëó÷èëè ñîîáùåíèå WM_RBUTTONDOWN (íàæàòà ïðàâàÿ êíîïêà ìûøè) 

	je	wmrbuttondown
	cmp	[wmsg],WM_PAINT

; Åñëè ïîëó÷èëè ñîîáùåíèå WM_PAINT (ïîëó÷åíî ñîîáùåíèå "íàðèñóéñÿ")

	je	wmpaint

; Åñëè ìû íå îáðàáàòûâàåì íè îäíî èç âûøåïåðå÷èñëåííûõ ñîîáùåíèé ïåðåäàåì
; óïðàâëåíèå ñòàíäàðòíîìó îáðàáîò÷èêó

	jmp	defwndproc

; 
; Îáðàáîòêà ñîîáùåíèÿ WM_PAINT
;

wmpaint:

; Íà÷èíàåì ðèñîâàíèå è ïîëó÷àåì óêàçàòåëü íà òåêóùèé DC

	call	BEGINPAINT,hwnd,ds offset lppaint

; AX ñîäåðæèò êîíòåêñò óñòðîéñòâà âûâîäà DC, ïîëó÷åííûé ïîñëå âûçîâà BEGINPAINT

; Âûçûâàåì TEXTOUT äëÿ âûâîäà ñòðîêè lpszText

	call	TEXTOUT,ax,5,5,ds offset lpszText,lpszTextLength

; Çàêàí÷èâàåì ðèñîâàíèå

	call    ENDPAINT,hwnd,ds offset lppaint

; Îáíóëÿåì AX è íà âûõîä

	xor	ax,ax
	jmp	finish

;
; Îáðàáîòêà ñîîáùåíèÿ WM_CREATE
;

wmcreate:

; Îáíóëÿåì AX è íà âûõîä

	xor	ax,ax
	jmp	finish

;
; Âûçîâ ñòàíäàðòíîãî îáðàáîò÷èêà ñîîáùåíèé 
;

defwndproc:

	call	DEFWINDOWPROC,hwnd,wmsg,wparam,lparam
	jmp	finish

;
; Îáðàáîòêà ñîîáùåíèÿ WM_DESTROY
;

wmdestroy:

; Âûçûâàåì POSTQUITMESSAGE

	call	POSTQUITMESSAGE,0

; Îáíóëÿåì AX è íà âûõîä

	xor	ax,ax
	jmp	finish

;
; Îáðàáîòêà ñîîáùåíèÿ WM_LBUTTONDOWN
;

wmlbuttondown:

; Âûâîäèì íà ýêðàí MESSAGEBOX ñ íàäïèñüþ "Left button pressed"

	call	MESSAGEBOX,0,ds offset lpszLeftMsg,ds offset lpszCaption,0

; Îáíóëÿåì AX è íà âûõîä

	xor	ax,ax
	jmp	finish

;
; Îáðàáîòêà ñîîáùåíèÿ WM_RBUTTONDOWN
;

wmrbuttondown:

; Âûâîäèì íà ýêðàí MESSAGEBOX ñ íàäïèñüþ "Right button pressed"

	call	MESSAGEBOX,0,ds offset lpszRightMsg,ds offset lpszCaption,0

; Îáíóëÿåì AX è íà âûõîä

	xor	ax,ax
	jmp	finish

;
; "Ôèíèøíàÿ ïðÿìàÿ"
;

finish:

; Îáíóëÿåì DX è íà âûõîä

	xor	dx,dx
	ret

WndProc         ENDP


end start

