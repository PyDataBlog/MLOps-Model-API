; æÔÌÁïÔðªèµ½Ôð¶ñÉÏ··é
;
; Function:
;	void perform_str( char * buf, unsigned long perform ) ;
;
; Parameters:
;	char; buf		«ÝæB
;	unsigned long perform	perform_stop()Ìßèl
;
; Description:
;	perform_stop()ÉæÁÄ¾½AàÁïÔð¶ñÉÏ··éB
;	bufÉÔðA11¶ÌÀ¶ñÆµÄi[·éB
;	i[·é®ÍAstr_printfÌ "%6ld.%04ld"Ì`B
;	"1.0000"ªP~bð\·B
;
; Prototype:
;	#include "perform.h"
;
; QÆÖ:
;	perform_start()
;	perform_stop()
;
; ÎÛ@í:
;	NEC PC-9801series
;	PC/AT
;
; vª¸x:
;	refer perform_start()
;
; Author:
;	öËºF
;
; Revision History:
;	92/5/18 Initial(perf_str.c)
;	92/5/25 perform_start/stopðperforma.asmÉÚ®
;	92/12/19 perfstr.asm ( master.lib )
;	93/ 5/29 [M0.18] .CONST->.DATA
;	93/12/ 7 [M0.22] add variable perform_Rate
;
	.MODEL SMALL
	include func.inc
	EXTRN _str_printf:CALLMODEL

	.DATA
	EXTRN perform_Rate:WORD
formatstr db '%6ld.%04ld',0

	.CODE

; DXAX / CX = DXAX ... BX
; 92/12/19
	public ASM_LWDIV
ASM_LWDIV	proc near
LLONG:
	xor	BX,BX
	test	DX,DX		; ©±ÌQsðæêÎ4bytes¸éª
	je	short LWORD	; ©»êÍð¯½¢c
	xchg	BX,AX	; BX <- AX ( íÌºÊ )
	xchg	AX,DX	; AX <- DX ( íÌãÊ )
			; DX = 0
	div	CX
	xchg	AX,BX	; BX = ðÌãÊ16bit
LWORD:
	div	CX
	xchg	DX,BX	; BX = ]è
	ret
	EVEN
ASM_LWDIV	endp

func PERFORM_STR
	push	BP
	mov	BP,SP
	push	SI
	; ø
	buf	= (RETSIZE+3)*2
	perform = (RETSIZE+1)*2

	mov	CX,perform_Rate
	shr	CX,1
	mov	AX,[BP+perform]
	mov	DX,[BP+perform+2]

	mov	SI,AX	; DXAXð5{
	mov	BX,DX
	shl	AX,1
	rcl	DX,1
	shl	AX,1
	rcl	DX,1
	add	AX,SI
	adc	DX,BX

	call	ASM_LWDIV	; tim / rate
	push	DX
	mov	SI,AX

	mov	AX,10000	; tim % rate; 10000 / rate
	mul	BX
	call	ASM_LWDIV
	pop	BX
	push	DX
	push	AX
	push	BX
	push	SI

	_push	DS
	mov	AX,offset formatstr
	push	AX
	_push	[BP+buf+2]
	push	[BP+buf]

	call	_str_printf
	add	SP,(4+DATASIZE*2)*2
	pop	SI
	pop	BP
	ret	(2+DATASIZE)*2
endfunc

END
