; Linux64 subroutines for the compiler

[section .data]
    errormsg_fatal:         db "FATAL ERROR: ", 0
    errormsg_out_of_bounds: db "Out of bounds", 0xa, 0
[section .text]
    global puts
    global gets
    global putCString
    global putChar
    global fatalError
    global outOfBoundsError
    global init
    extern malloc
    extern exit

; Prints a single character to the console
; This function will be OS specific, because it performs system calls.
; Modifies:
;     rax, rbx, rcx, rdx
; Arguments:
;     push $1  : Pointer to character
putChar:
    ; Set up registers for syscall
    mov rax, 4          ; Write is syscall #4
    mov rbx, 1          ; Set file-descriptor to write to (stdout)
    mov rcx, [rsp + 4]  ; Pointer to first character
    mov rdx, 1          ; Write only one character from the buffer
    int 0x80
    ret

; Read character into buffer
gets:
    push r9
    mov rax, 3    ; Read is syscall #3
    xor rbx, rbx  ; File descriptor stdin
    mov rcx, r9   ; r9 is the buffer pointer
    int 0x80
    pop r9
    ret

; Print out character from buffer
puts:
    push r9
    mov rax, 4   ; Write is syscall #4
    mov rbx, 1   ; Set file descriptor to stdout
    mov rcx, r9  ; r9 is the buffer pointer
    int 0x80
    pop r9
    ret

; Prints a C-string to the console
; Calls:
;     putChar
; Modifies:
;     rax, rbx, rcx, rdx
; Arguments:
;     1 : Pointer to first character in C-style (null-terminated) string
putCString:
    ; Get the pointer for the first character
    mov rax, qword [rsp + 4]

    ; Beginning of loop
    putCString__loop:
        ; Check that the current character is not null, break if it is
        cmp BYTE [rax], 0
        je putCString__end

        ; Display the character on the console
        push rax
        call putChar
        pop rax

        ; Increment the pointer and loop
        inc rax
        jmp putCString__loop

    ; End of loop
    putCString__end:

    ret  ; Done

fatalError:
    push qword errormsg_fatal
    call putCString
    add rsp, 4
    ret
outOfBoundsError:
    call fatalError
    push qword errormsg_out_of_bounds
    call putCString
    mov rdi, 255
    call exit
init:
    mov rdi, 0x8000
    call malloc
    mov r9, rax
    add r9, 0x4000
    ret
