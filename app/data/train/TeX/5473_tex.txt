\begin{figure}
\smaller[1.0]
\begin{Verbatim}[numbers=left, xleftmargin=3em]
dnspacket = 
{
  id uint16
  qr uint1
  opcode uint4
  aa uint1
  tc uint1
  rd uint1
  ra uint1
  uint3 = 0
  rcode uint4
  @qc uint16
  @ac uint16
  @ns uint16
  @ar uint16
  questions n_of @qc question
  responses n_of @ac answer
  authority n_of @ns answer
  additional n_of @ar answer
}
question = {
  labels compressed_labels
  qtype uint16 | 1..16
  qclass uint16 | [1,255]
}
answer = {
  labels compressed_labels
  rtype uint16 | 1..16
  class uint16 | [1]
  ttl uint32
  @rlength uint16
  rdata n_of @rlength uint8
}
compressed_labels = {
  $decompressed transform dnscompress ($current)
  labels apply $decompressed labels
}
label = { @length uint8 | 1..64
           label n_of @length uint8 }
labels = <many label; uint8 = 0>
\end{Verbatim}
\caption{Nail grammar for DNS packets, used by our prototype DNS server.}
\label{fig:dns-full}
\end{figure}

\begin{figure}
\smaller[1.0]
\input{code/dns-struct}
\caption{Portions of the C data structures defined by Nail for the DNS
  grammar shown in Figure~\ref{fig:dns-full}.}
\label{fig:dns-full-struct}
\end{figure}

\begin{figure}
\smaller[1.0]
\input{code/dns-api}
\caption{The API functions generated by Nail for parsing inputs and
  generating outputs for the DNS grammar shown in Figure~\ref{fig:dns-full}.}
\label{fig:dns-full-api}
\end{figure}

