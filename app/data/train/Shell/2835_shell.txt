#! /bin/bash

set -e

echo "######## postprocess $@"


if [ $# -lt 2 ]; then
    echo "Please input PROJECT_PATH PLATFORM_NO SDK_NO ..."
    exit -1
fi

TOOLS_PATH="$(cd $(dirname $0);pwd)"
PROJECT_PATH=$(cd $1;pwd)
shift

PLATFORM_NO=$1
shift

for ARG in "$@"; do
    case $ARG in
        [0-0][1-9] ) eval "SWITCH_$ARG=ON";;
        * ) echo "SDK $ARG not support"; exit -1;;
    esac
done


ANDROID_DIR=${PROJECT_PATH}/Build/Android/RunningCube
SOURCE_DIR=${ANDROID_DIR}/src/com/cocoachina/runningcube
RES_DIR=${ANDROID_DIR}/res
LIBS_DIR=${ANDROID_DIR}/libs

SDK_PATH=${TOOLS_PATH}/SDK
SDK_PUBLIC_DIR=${SDK_PATH}/public
PUBLIC_FILES_DIR=${SDK_PUBLIC_DIR}/Files

PLATFORM_DIR=${TOOLS_PATH}/Platform/${PLATFORM_NO}
PLATFORM_FILES_DIR=${PLATFORM_DIR}/Files
PLATFORM_RES_DIR=${PLATFORM_DIR}/res

PERMISSION=""
APPLICATION=""
ACTIVITY_ONCREATE=""

##########################################################################################
# IF HAS SDK
if [ $# -gt 0 ]; then
##########################################################################################

mkdir -p "${SOURCE_DIR}"

##########################################################################
# SDK_01
##########
if [ -n "${SWITCH_01}" ]; then
    SDK_01=${SDK_PATH}/01

    cp "${SDK_01}/GameApplication.java" "${SOURCE_DIR}/"

    cp -R "${SDK_01}/SDK/assets"/* "${ANDROID_DIR}/assets/"

    cp -R "${SDK_01}/SDK/res"/* "${RES_DIR}/"

    TMP_DIR=${ANDROID_DIR}/runtime
    if ! [ -d "${TMP_DIR}" ]; then
        mkdir -p "${TMP_DIR}"
    fi
    cp -R "${SDK_01}/SDK/runtime"/* "${ANDROID_DIR}/runtime/"

    cp -R "${SDK_01}/SDK/Unity3D/CMBillingForUnity.jar" "${LIBS_DIR}/"

    cp -R "${SDK_01}/SDK/libs/armeabi"/* "${LIBS_DIR}/armeabi-v7a/"

    cp "${SDK_01}/g_strings.xml" "${RES_DIR}/values/"

    PERMISSION="${PEMISSION}
$(cat ${SDK_01}/permission.xml)"

    APPLICATION="${APPLICATION}
$(cat ${SDK_01}/application.xml)"
fi
##########################################################################

##########################################################################
# SDK_02
##########
if [ -n "${SWITCH_02}" ]; then
	SDK_02=${SDK_PATH}/02
	
	cp "${SDK_02}/SDK_02.java" "${SOURCE_DIR}/"
	
	cp -R "${SDK_02}/SDK/libs"/mmbilling*.jar "${LIBS_DIR}/"
	
	cp -R "${SDK_02}/SDK/libs/armeabi"/* "${LIBS_DIR}/armeabi-v7a/"
	
	
	PERMISSION="${PERMISSION}
$(cat ${SDK_02}/permission.xml)"
	
	APPLICATION="${APPLICATION}
$(cat ${SDK_02}/application.xml)"
fi
##########################################################################

##########################################################################
# SDK_03
##########################################################################
if [ -n "${SWITCH_03}" ]; then
	SDK_03=${SDK_PATH}/03
	
	cp -R "${SDK_03}/SDK/00/assets"/* "${ANDROID_DIR}/assets/"
	
	cp -R "${SDK_03}/SDK/00/libs"/* "${LIBS_DIR}/"
	
	cp "${SDK_03}/feeInfo.dat" "${ANDROID_DIR}/assets/"
	
	cp "${SDK_03}/SDK_03.java" "${SOURCE_DIR}/"
	
	PERMISSION="${PERMISSION}
$(cat ${SDK_03}/permission.xml)"
	
    APPLICATION="${APPLICATION}
$(cat ${SDK_03}/application.xml)"

    ACTIVITY_ONCREATE="${ACTIVITY_ONCREATE}
        SDK_03.Activity_onCreate(this);"
fi
##########################################################################


##########################################################################
# SDK_05
##########
if [ -n "${SWITCH_05}" ]; then
    SDK_05="${SDK_PATH}/05"
    cp "${SDK_05}/SDK/FlurryAnalytics-5.5.0.jar" "${LIBS_DIR}/"

    PERMISSION="${PERMISSION}
$(cat ${SDK_05}/permission.xml)"
fi
##########################################################################


##########################################################################
# SDK_06
##########
if [ -n "${SWITCH_06}" ]; then
    SDK_06="${SDK_PATH}/06"
    cp "${SDK_06}/SDK/CocoAnalyse_V0.1.7.jar" "${LIBS_DIR}/"

    PERMISSION="${PERMISSION}
$(cat ${SDK_06}/permission.xml)"
    APPLICATION="${APPLICATION}
$(cat ${SDK_06}/application.xml)"
fi
##########################################################################


##########################################################################
# SDK_07
##########
SDK_07="${SDK_PATH}/07"
if [ -n "${SWITCH_07}" ]; then
    cp "${SDK_07}/SDK/clientinstallsdk1.4.jar" "${LIBS_DIR}/"
    cp "${SDK_07}/SDK_07.java" "${SOURCE_DIR}/"

    PERMISSION="${PERMISSION}
$(cat ${SDK_07}/permission.xml)"
    ACTIVITY_ONCREATE="${ACTIVITY_ONCREATE}
        SDK_07.Activity_onCreate(this);"
fi
##########################################################################

##########################################################################
# SDK_08
##########
SDK_08="${SDK_PATH}/08"
if [ -n "${SWITCH_08}" ]; then
    cp "${SDK_08}/SDK/lib/CCRedeem.jar" "${LIBS_DIR}/"
    cp "${SDK_08}/SDK_08.java" "${SOURCE_DIR}/"

    PERMISSION="${PERMISSION}
$(cat ${SDK_08}/permission.xml)"
    ACTIVITY_ONCREATE="${ACTIVITY_ONCREATE}
        SDK_08.Activity_onCreate(this);"
fi
##########################################################################

##########################################################################
# SDK_09
##########
SDK_09="${SDK_PATH}/09"
if [ -n "${SWITCH_09}" ]; then
    cp "${SDK_09}/SDK/cocospush_v1.2.4_release.jar" "${LIBS_DIR}/"
    cp -R "${SDK_09}/SDK/res"/* "${RES_DIR}/"
    cp "${SDK_09}/SDK_09.java" "${SOURCE_DIR}/"
    cp "${SDK_09}/CCReceiver.java" "${SOURCE_DIR}/"

    PERMISSION="${PERMISSION}
$(cat ${SDK_09}/permission.xml)"
    APPLICATION="${APPLICATION}
$(cat ${SDK_09}/application.xml)"
    ACTIVITY_ONCREATE="${ACTIVITY_ONCREATE}
        SDK_09.Activity_onCreate(this);"
fi
##########################################################################


##########################################################################
# Activity File
##########
TARGET_FILE=${SOURCE_DIR}/MainActivity.java
if [ -f "${TARGET_FILE}" ]; then
    rm "${TARGET_FILE}"
fi

IFS_BAK="$IFS"
while IFS='' read LINE; do
    if [ $(echo "$LINE" | grep '/\*ONCREATE\*/') ]; then
        echo "${ACTIVITY_ONCREATE}" >> "${TARGET_FILE}"
    else
        echo "${LINE}" >> "${TARGET_FILE}"
    fi
done < "${PUBLIC_FILES_DIR}/MainActivity.java"
IFS="$IFS_BAK"
##########################################################################

##########################################################################################
fi
# IF HAS SDK
##########################################################################################

##########################################################################
# Addition Files
##########
cp "${PUBLIC_FILES_DIR}/Util.java" "${SOURCE_DIR}/"
cp "${PLATFORM_FILES_DIR}/strings.xml" "${RES_DIR}/values/"
##########################################################################

##########################################################################
# Platform Files
##########
TMP=${PLATFORM_FILES_DIR}/permission.xml
if [ -f "${TMP}" ]; then
    PERMISSION="${PERMISSION}
$(cat ${TMP})"
fi
TMP=${PLATFORM_FILES_DIR}/application.xml
if [ -f "${TMP}" ]; then
    APPLICATION="${APPLICATION}
$(cat ${TMP})"
fi

##########################################################################

##########################################################################
# AndroidManifest File
##########
if [ -f "${PLATFORM_FILES_DIR}/AndroidManifest.xml" ]; then
    PERMISSION=$(echo "$PERMISSION" | awk -F'"' '/uses-permission/ && !seen[$2]++ ')
    TARGET_FILE=${ANDROID_DIR}/AndroidManifest.xml
    if [ -f "${TARGET_FILE}" ]; then
        rm "${TARGET_FILE}"
    fi

    IFS_BAK="$IFS"
    while IFS='' read LINE; do
        if [ $(echo "$LINE" | grep '<!--PERMISSION-->') ]; then
            echo "$PERMISSION" >> "${TARGET_FILE}"
        elif [ $(echo "$LINE" | grep '<!--APPLICATION-->') ]; then
            echo "$APPLICATION" >> "${TARGET_FILE}"
        else
            echo "$LINE" >> "${TARGET_FILE}"
        fi
    done < "${PLATFORM_FILES_DIR}/AndroidManifest.xml"
    IFS="$IFS_BAK"
fi
##########################################################################


##########################################################################
# Icon Files
##########
if [ -d "${PLATFORM_RES_DIR}" ]; then
    cp -R "${PLATFORM_RES_DIR}"/ "${RES_DIR}/"
fi
##########################################################################

##########################################################################
# KeyStore
##########

KEYSTORE="
key.store=${PLATFORM_DIR}/KeyStore/runningcube.keystore
key.store.password=Ksesgdetol
key.alias.password=Ksesgdetol
key.alias=runningcube.keystore
"

echo "${KEYSTORE}" > "${ANDROID_DIR}/ant.properties"

##########################################################################
