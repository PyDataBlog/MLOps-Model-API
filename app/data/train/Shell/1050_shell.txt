#!/bin/bash

VER=$1
if [ -z ${VER} ] ; then
    echo "Error, pass the version number you are creating (for example 1.1)";
    exit -1;
fi
STARTDIR=`pwd`;

if [ -d build/Release ]; then
    cd build/Release
    echo "Creating zip file";
    ditto -ck --keepParent  PortKnox.app PortKnox-${VER}.zip 
    LEN=`stat -f %z PortKnox-${VER}.zip `
    SIG=`ruby  ~/Downloads/Sparkle\ 1.5b6/Extras/Signing\ Tools/sign_update.rb  PortKnox-${VER}.zip ~/Dropbox/Documents/application_keys/PortKnox/dsa_priv.pem `
    cd ${STARTDIR}
fi
# After the build, generate a sig

echo "Updating appcast with sha (${SIG}) and len (${LEN})";
PUBDATE=$(LC_TIME=en_US date +"%a, %d %b %G %T %z")


NEWITEM="      <item>
           <title>PortKnox Version ${VER}</title>
           <sparkle:releaseNotesLink>http://neverlight.com/PortKnox/${VER}.html</sparkle:releaseNotesLink>
           <pubDate>${PUBDATE}</pubDate>
           <enclosure url=\"http://neverlight.com/PortKnox/PortKnox-${VER}.zip\" 
               sparkle:version=\"${VER}\"
               sparkle:dsaSignature=\"${SIG}\"
               length=\"${LEN}\"
               type=\"application/octet-stream\" />
      </item>";

#echo "Next item entry is "
#echo  ${NEWITEM}

perl -i.bak -pe "s|<!-- NEXT RELEASE GOES HERE -->|<!-- NEXT RELEASE GOES HERE -->\n${NEWITEM}\n|" appcast.xml