#!/usr/bin/env bash

# $dev is the tunnel device, passed to us by OpenVPN
# adds in hte necessary iptables rules for packet forwarding over a tunnel
# call this in your OVPN config file as below:

# script-security 2
# route-up "/etc/openvpn/scripts/iptables.sh up"
# down "/etc/openvpn/scripts/iptables.sh down"


localInt='eth0'

if [ "$1" = "up" ]
then
/sbin/iptables -t nat -A POSTROUTING -o $dev -j MASQUERADE
/sbin/iptables -A FORWARD -i $dev -o $localInt -m state --state RELATED,ESTABLISHED -j ACCEPT
/sbin/iptables -A FORWARD -i $localInt -o $dev -j ACCEPT
elif [ "$1" = "down" ]
then
/sbin/iptables -t nat -D POSTROUTING -o $dev -j MASQUERADE
/sbin/iptables -D FORWARD -i $dev -o $localInt -m state --state RELATED,ESTABLISHED -j ACCEPT
/sbin/iptables -D FORWARD -i $localInt -o $dev -j ACCEPT
fi
