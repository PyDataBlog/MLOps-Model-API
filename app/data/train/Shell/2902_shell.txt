#!/bin/bash

HOST="http://127.0.0.1:5984"

# Wait until CouchDB ACTUALLY starts
until curl -sSf $HOST/_all_dbs
do
  sleep 0.1
done

# Create the DBs
curl -sSfX PUT $HOST/feeds
curl -sSfX PUT $HOST/articles
curl -sSfX PUT $HOST/images

# Create the views
curl -sSfX PUT -H "Content-Type: application/json" -d @/root/feeds-filter.json $HOST/feeds/_design/filters
curl -sSfX PUT -H "Content-Type: application/json" -d @/root/articles-filter.json $HOST/articles/_design/filters
curl -sSfX PUT -H "Content-Type: application/json" -d @/root/images-filter.json $HOST/images/_design/filters

# Define the feeds
curl -sSfX POST -H "Content-Type: application/json" -d @/root/FEEDS.json $HOST/feeds/_bulk_docs

# Wait for the database to sync to disk
curl -sSfX POST -H "Content-Type: application/json" $HOST/feeds/_ensure_full_commit
curl -sSfX POST -H "Content-Type: application/json" $HOST/articles/_ensure_full_commit
curl -sSfX POST -H "Content-Type: application/json" $HOST/images/_ensure_full_commit
