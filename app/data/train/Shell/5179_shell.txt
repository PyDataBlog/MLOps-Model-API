#!/bin/bash
#Matthew Burns, 2012 mdburns@ucsd,edu
#Installs a BCILAB worker on a fresh Amazon Linux AMI 
#
#This script has to be updated to download the appropriate Matlab MCR Version
#and appropriate BCILAB version.
#
#Comment out "defaults requiretty" from /etc/sudoers, allows 
#us to start workers remotely
#
#example: 
#sudo vim /etc/sudoers

echo "Installing BCILAB worker on new instance"
cd ~ 

wget http://www.mathworks.com/supportfiles/MCR_Runtime/R2012a/MCR_R2012a_glnxa64_installer.zip
wget ftp://sccn.ucsd.edu/pub/bcilab/bcilab-1.1.zip 

sudo yum -y update

sudo mkdir /devel
sudo chmod a=rwx /devel
cd /devel

unzip ~/bcilab-1.1.zip -d /devel
rm  ~/bcilab-1.1.zip

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#Matlab Compiler Runtime -> 
#/usr/local/MATLAB/MATLAB_Compiler_Runtime/v717

sudo yum -y install libXp.x86_64
sudo yum -y install libXt.x86_64
sudo yum -y install libXmu.x86_64

mkdir /devel/2012MCRInstaller
unzip ~/MCR_R2012a_glnxa64_installer.zip -d /devel/2012MCRInstaller/ 
cd /devel/2012MCRInstaller/
sudo ./install -mode silent -agreeToLicense yes
cd /devel/
rm -rf 2012MCRInstaller/  
rm  ~/MCR_R2012a_glnxa64_installer.zip

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#Get s3fs app for mounting s3
#Specify your Security Credentials (Access Key ID & Secret 
#Access Key) by one of the following methods:
#	using the passwd_file command line option
#	setting the AWSACCESSKEYID and AWSSECRETACCESSKEY
#	environment variables
#
#	using a .passwd-s3fs file in your home directory or
#	using the system-wide /etc/passwd-s3fs file:
#	create the file with your amazon AWS
# 	id and secret key separated by a colon ie:
#	example-id:example-secret-key (note that you'll want to be 
#	careful about the permissions on this file)
#	
# 	I've found the /etc/passwd-s3fs option works best
#
#Command is /usr/bin/s3fs mybucket /mnt/s3
#See http://code.google.com/p/s3fs/wiki/FuseOverAmazon

echo "Setting up s3fs access key file"
read -p "Enter AWS Access Key ID: " AWSACCESSKEYID 
read -p "Enter AWS Secret Access Key: " AWSSECRETACCESSKEY
echo "$AWSACCESSKEYID:$AWSSECRETACCESSKEY" > ~/passwd-s3fs
echo "$AWSACCESSKEYID:$AWSSECRETACCESSKEY"
chmod og= ~/passwd-s3fs
sudo mv ~/passwd-s3fs /etc/passwd-s3fs 
 
echo "getting s3fs prerequisites"
sudo yum -y install make
sudo yum -y install gcc
sudo yum -y install libstdc++-devel
sudo yum -y install gcc-c++
sudo yum -y install fuse
sudo yum -y install fuse-devel
sudo yum -y install curl-devel
sudo yum -y install libxml2-devel
sudo yum -y install openssl-devel
sudo yum -y install mailcap 

cd /devel/
echo "getting s3fs"
wget http://s3fs.googlecode.com/files/s3fs-1.61.tar.gz
tar -zxvf s3fs-1.61.tar.gz
cd s3fs-1.61/
./configure --prefix=/usr
make
sudo make install

cd /devel/
rm -rf s3fs-1.61/
rm s3fs-1.61.tar.gz
sudo chmod a=rwx /mnt 
mkdir /mnt/s3
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%