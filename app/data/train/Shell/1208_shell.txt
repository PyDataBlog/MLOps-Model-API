#!/bin/sh
# script for CurrencyModule
#
# This script needs the following arguments :
# @var $1 the full path of the data directory
# @var $2 the id of the endpoint to backup
#

# change directory to __DIR__
cd `dirname $0`

# update current code at current date
if [ -d ".git" ]; then
	git pull --all
	git add --all
	git commit -m "Automatic update at `date +%Y-%m-%d`"
	git push git@github.com:yii1-module/yii1-currency.git
else
	echo "There is no git directory at .git" 
fi;

# execute the backup commands
if [ -n "$2" ]; then
	php ../../yiic.php currency/backup currency --endpoint_id="$2"
	php ../../yiic.php currency/backup rate --endpoint_id="$2" --start="`date -d '1 month ago' +%Y-%m-%d`"
	php ../../yiic.php currency/backup cleanupRate --endpoint_id="$2" --intervalFromNow="-1 month"
	php ../../yiic.php currency/optimize compactFromUsd
	php ../../yiic.php currency/optimize compactFromEur
	php ../../yiic.php currency/optimize compactFromJpy
	php ../../yiic.php currency/optimize compactFromGbp
	php ../../yiic.php currency/optimize compactFromChf
	php ../../yiic.php currency/optimize compactToUsd
	php ../../yiic.php currency/optimize compactToEur
	php ../../yiic.php currency/optimize compactToJpy
	php ../../yiic.php currency/optimize compactToGbp
	php ../../yiic.php currency/optimize compactToChf
else
	echo "No endpoint specified in script"
fi;

if [ -n "$1" ]; then
	# go to data directory
	if [ -d "$1" ]; then
		cd "$1"
		# update to git with message at current date
		if [ -d ".git" ]; then
			git pull --all
			git add --all
			git commit -m "Automatic update at `date +%Y-%m-%d`"
			git push git@github.com:yii1-module/yii1-currency-data.git
		else
			echo "There is no git directory at $1/.git"
		fi;
	else
		echo "There is no directory at $1"
	fi;
else
	echo "No directory to update git data defined in script"
fi;
