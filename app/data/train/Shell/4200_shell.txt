#!/bin/bash

sudo sudo sh -c 'echo "mysql-server mysql-server/root_password password root
mysql-server mysql-server/root_password_again password root" > /root/debconf.txt'
debconf-set-selections /root/debconf.txt

echo "mysql-server-5.5 mysql-server/root_password password root" > mysql_password.cfg
echo "mysql-server-5.5 mysql-server/root_password_again password root" >> mysql_password.cfg
debconf-set-selections mysql_password.cfg

sudo apt-get update
sudo apt-get upgrade -y

sudo apt-get install -y apache2 php7.0 php7.0-mysql libapache2-mod-php7.0 php7.0-curl php7.0-gd php7.0-mcrypt php-mbstring
sudo apt-get install -y mysql-server
#sudo apt-get install -y mythtv-backend mythtv-database
sudo apt-get install -y php-mbstring php7.0-mbstring php-gettext libapache2-mod-php7.0 zip unzip

#sudo groupadd mythtv
#sudo usermod -a -G mythtv vagrant

sudo cp /vagrant/000-default.conf /etc/apache2/sites-available
sudo a2enmod rewrite
sudo phpenmod mcrypt mbstring

curl -s https://getcomposer.org/installer | php
sudo mv composer.phar /usr/bin/composer

# @todo: Switch to webserver user to run composer?
cd /var/www/legend/
composer update

echo "CREATE DATABASE IF NOT EXISTS mythtv" | mysql -u root -proot

sudo mkdir -p /vagrant/storage/views
sudo mkdir /vagrant/storage/meta
sudo mkdir /vagrant/storage/logs
sudo mkdir /vagrant/storage/sessions
sudo chown vagrant /vagrant/storage
sudo chmod -R 777 /vagrant/storage

sudo mkdir /tmp/uploads
sudo mkdir /tmp/downloads
sudo chmod -R 777 /tmp/uploads
sudo chmod -R 777 /tmp/downloads

sudo service apache2 restart

cd /tmp;
sudo mkdir -p storage/meta storage/logs storage/views storage/sessions;
sudo chmod -R 777 storage/;
