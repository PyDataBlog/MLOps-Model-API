#!/bin/bash

# /home/pi/AOPi/report4duty.sh

# A script to send hostname, date and location to verify an AOPi-Soldier is connecting

# Exchange digital key for passwordless exchange

# Create cronjob
# 1 * * * * /home/pi/AOPi/report4duty.sh


tmpdir='/home/pi/AOPi/tmp/'

echo
echo "Checking for temporary directory in /home/pi/AOPi/ ... "
sleep 3
# Test for temp dir in /home/pi/AOPi/
if [ -d "$tmpdir" ]; then
  echo "Temporary Directory Exists Within AOPi directory"
  echo
else
  echo "Creating directory /home/pi/AOPi/tmp/ ... "
  mkdir $tmpdir
fi


echo "Testing for the program: curl.  Used to get public ip address to report location."
echo
sleep 3
# Test for curl
type curl >/dev/null 2>&1 || { echo >&2 "I require curl but it's not installed.  Please install it using: sudo apt-get install curl"; exit 1; }

# If curl is installed
echo "curl is installed. Now getting public ip address ... "
sleep 3

# get external ip address
xipaddress="$(curl -s ipecho.net/plain;echo)"
echo
echo "Your public ip address is: " $xipaddress
echo
sleep 3


echo "Gathering data publicly accessible on the internet about your location using ipinfo.io ... "
echo
sleep 3
curl ipinfo.io/$xipaddress > $tmpdir/location.txt
sleep 3
echo
cat $tmpdir/location.txt
echo

echo
echo "Removing some of the info. and generating report that gets sent to:  ArmyOfPi.net"
sleep 3
hostname -s > $tmpdir/report4duty.txt
/bin/date >> $tmpdir/report4duty.txt

cat $tmpdir/location.txt | grep city >> $tmpdir/report4duty.txt
cat $tmpdir/location.txt | grep region >> $tmpdir/report4duty.txt
cat $tmpdir/location.txt | grep country >> $tmpdir/report4duty.txt

echo
cat $tmpdir/report4duty.txt
sleep 3
echo

# Add hostname to path to create directory for each Pi then append using:
# cat source | ssh user@host "cat >> /path/to/target"
echo
echo "Sending report to armyofpi.net ... "
sleep 3
cat $tmpdir/report4duty.txt | ssh -p 21098 sysmon@armyofpi.net "cat >> /home/sysmon/rollcall.txt"
echo
echo "Looks like the report was successfully sent.  Check it here:  armyofpi.net/rollcall"
echo
echo "You can also set this script to run automatically using crontab -e"
echo


# cat $tmpdir/report4duty.txt | ssh -p 21098 sysmon@connect.armyofpi.net "cat >> /home/sysmon/$hostname/report4duty.txt"
# or
# /bin/hostname > $tmpdir/report4duty.txt && /bin/date >> $tmpdir/report4duty.txt
# scp -P 21098 $tmpdir/checkin.txt sysmon@connect.armyofpi.net:/home/sysmon/rollcall.txt
