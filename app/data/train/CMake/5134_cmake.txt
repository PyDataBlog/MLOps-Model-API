function(test_library lib_to_test)
    set(multi_value_args TEST_FILES LINK_LIBRARIES LINK_LIBRARIES_WHOLE_ARCHIVE)
    cmake_parse_arguments(TEST_LIBRARY
        ""
        ""
        "${multi_value_args}"
        ${ARGN}
    )

    # build test executable
    add_executable(test_${lib_to_test} ${TEST_LIBRARY_TEST_FILES})
    target_link_libraries(test_${lib_to_test}
        ${lib_to_test}
        ${TEST_LIBRARY_LINK_LIBRARIES}
        gtest tests_main

        -Wl,--whole-archive
        ${TEST_LIBRARY_LINK_LIBRARIES_WHOLE_ARCHIVE}
        -Wl,--no-whole-archive
    )

    # add test
    add_test(NAME ${lib_to_test} COMMAND $<TARGET_FILE:test_${lib_to_test}>)
endfunction()
