import { Component, OnInit, Input } from '@angular/core';
import { ActivatedRoute, Params }   from '@angular/router';
import { Location }                 from '@angular/common';
import 'rxjs/add/operator/switchMap';


import { AdminDataService } from '../admin-data.service';
import {ModelService} from '../model.service';


@Component({
  selector: 'model-page',
  templateUrl: './model-page.component.html',
  styleUrls: ['./model-page.component.css'],
  providers: [ModelService],
})
export class ModelPageComponent implements OnInit {

  constructor(
      private adminDataService : AdminDataService,
      private modelService : ModelService,
      private route: ActivatedRoute,
      private location: Location
    ) { }

 
  modelData = [];
  modelD = '';
  modelName = '';
  @Input()
  modelInfo = {};
  
  formInfo = {method:'post', id:''};
  getData() :void {
    this.adminDataService.getAdminInfo().then(adminData => {
        this.route.params.switchMap((params: Params)=>[params['modelName']]).
          subscribe(modelName=>{
            this.modelInfo = adminData.find(row =>row.name===modelName);
            this.modelName = this.modelInfo['name'];
            this.modelService.getAll(this.modelName).then(modelData => {
              this.modelData=modelData;
              this.modelD = JSON.stringify(this.modelData)
            });
          });
     });;
  }

  ngOnInit(): void{
    this.getData();
  }

  delete(obj): void {
    this.modelService
        .delete(this.modelName,obj.id)
        .then(() => {
          this.modelData = this.modelData.filter(o => o !== obj);
        });
  }

  fillForm(obj,md, mi): void {
    this.formInfo.id = md.id;
    for(var pf of mi.put_fields){
      if (mi.field_types[pf].list){
        obj[pf].val = '';
        obj[pf].vallist = md[pf];
      }
      else {
        obj[pf].val = md[pf];
      }
    }

    console.log(obj);
  }


}
