/**
 * Created by woolfi182 on 06.06.2016.
 */
import {Component} from '@angular/core';
import {Router} from '@angular/router';
import {AuthService} from "./auth.service";
import {UserService} from "../user/user.service";

@Component({
    selector: 'login-form',
    template: `
    <div class="error-message-block fadeIn animated" *ngIf="failedAuth">{{failedMessage}}</div>
    <form role="form" (ngSubmit)="onSubmit(f)" #f="ngForm">
        <div class="form-group">
            <label for="login">Username</label>
            <input id="login" class="form-control" required
                type="text" placeholder="Your login"
                ngControl="login">
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input id="password" class="form-control" required
                type="password" placeholder="Your password"
                ngControl="password">
        </div>
        <button type="submit" class="btn btn-default" [disabled]="!f.valid">Submit</button>
    </form>
    `
})
export class LoginFormComponent {
    user = {
        login: '',
        password: ''
    }
    private failedMessage = null;
    private failedAuth = null;

    constructor(private _authService:AuthService
        , private _userService:UserService
        , private _router:Router) {
    }

    onSubmit(form) {
        this.failedAuth = null
        this.user.login = form.value.login;
        this.user.password = form.value.password;
        this._authService
            .authenticate(this.user)
            .then(isLoggedIn=>{
                this.failedAuth = false;
                this._userService.setUser({name: this.user.login});
                this._router.navigate(['/chat']);
            })
            .catch(error=>{
                if (error.status === 401){
                    this.failedMessage = 'Invalid login or password';
                } else {
                    this.failedMessage = 'Connection error';
                }
                this.failedAuth = true;
            })
    }
}