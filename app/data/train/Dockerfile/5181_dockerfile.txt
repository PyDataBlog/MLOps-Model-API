#FROM registry.access.redhat.com/rhscl/python-27-rhel7:2.7
FROM docker.io/centos/python-27-centos7:latest

ENV ELASTALERT_VERSION 0.1.6
ENV ELASTALERT_HOME $HOME/elastalert-$ELASTALERT_VERSION

USER root

# Install python dev tools
RUN yum install -y python-devel python-setuptools net-tools && \
    easy_install -U pip && \
    pip install --upgrade pip

# Download ElastAlert
RUN cd $HOME && \
    curl -L https://github.com/Yelp/elastalert/archive/v$ELASTALERT_VERSION.zip -o elastalert-v$ELASTALERT_VERSION.zip && \
    bsdtar -xf elastalert-v$ELASTALERT_VERSION.zip && \
    rm -f elastalert-v$ELASTALERT_VERSION.zip

# Copy config
COPY configuration/run.sh $ELASTALERT_HOME/run.sh
COPY configuration/config.yaml $ELASTALERT_HOME/config.yaml

# Create default user and change ownership of files
RUN useradd -u 1000 -r -g 0 -m -d $HOME -s /sbin/nologin -c "elastalert user" elastalert && \
    cp -r /etc/skel/. $HOME && \
    chown -R elastalert:0 $HOME && \
    fix-permissions $HOME && \
    fix-permissions /opt/app-root

# Create dirs
RUN chmod +x $ELASTALERT_HOME/run.sh && \
    ln -s $ELASTALERT_HOME/run.sh $HOME/run.sh && \
    mkdir $ELASTALERT_HOME/rules

# switch to elastalert
USER 1000

# Install
RUN cd $ELASTALERT_HOME && \
    pip install -r requirements.txt && \
    python setup.py install
