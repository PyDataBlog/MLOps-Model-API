# Modifyed by Yang Wang
#
# To build ol6:wls. Based on image ol6:bare. The purpose of this image is for Weblogic Admin Server
# Features include:
# 1. Java 1.7
# 2. Expose ports 5556 7001 7002
# 3. Group "oracle" is added
# 4. Users "oracle/marlo12" and "ywang/marlo12" will be added
# 
#
# SSH and SSHD will not be installed because nsenter will be used to enter Docker container if necessary.
#
# To build this image
# 1. copy software/jdk-7u65-linux-x64.tar.gz to this directory. Delete it after building the image.
# 2. docker build -t ol6:java .
#

# Pull base image
FROM ol6:bare

MAINTAINER Yang Wang <yang.wang@dovetailsystems.com>

USER root

# Install Java 7

# Prepare the Oracle Linux 6.5: install packages including X11, SSH, etc
RUN cd /etc/yum.repos.d ; \
    wget http://public-yum.oracle.com/public-yum-ol6.repo ; \
    wget http://public-yum.oracle.com/RPM-GPG-KEY-oracle-ol6 -O /etc/pki/rpm-gpg/RPM-GPG-KEY-oracle ; \
    yum -y install sudo passwd unzip

# Install and setup Java 7

WORKDIR /opt

# Docker will automatically uncompress the file. So no need to uncompress it any more.
ADD jdk-7u65-linux-x64.tar.gz /opt

RUN chown -R root:root /opt/jdk1.7.0_65 ; \
    alternatives --install /usr/bin/java java /opt/jdk1.7.0_65/bin/java 1 ; \
    echo 1 | alternatives --config java ; \
    alternatives --install /usr/bin/jar jar /opt/jdk1.7.0_65/bin/jar 1 ; \
    alternatives --install /usr/bin/javac javac /opt/jdk1.7.0_65/bin/javac 1 ; \
    alternatives --set jar /opt/jdk1.7.0_65/bin/jar ; \
    alternatives --set javac /opt/jdk1.7.0_65/bin/javac ; \
    echo "# Setup JAVA environments" >> /opt/jdk1.7.0_65/java_env.sh ; \
    echo "export JAVA_HOME=/opt/jdk1.7.0_65" >> /opt/jdk1.7.0_65/java_env.sh ; \
    echo "export JRE_HOME=/opt/jdk1.7.0_65/jre" >> /opt/jdk1.7.0_65/java_env.sh ; \
    echo "export PATH=$PATH:/opt/jdk1.7.0_65/bin:/opt/jdk1.7.0_65/jre/bin" >> /opt/jdk1.7.0_65/java_env.sh ; \
    java -version

RUN groupadd -g 501 oracle ; \
    useradd -m -u 501 -s /bin/bash -g oracle -G wheel oracle ; \
    echo oracle:marlo12 | chpasswd ; \
    useradd -m -u 502 -g users -G wheel ywang ; \
    echo ywang:marlo12 | chpasswd ; \
    echo "oracle ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers ; \
    echo "ywang ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# Expose Node Manager default port, and also default http/https ports for admin console
# Still expose 22 even though SSH will not be used. We will use nsenter instead.
EXPOSE 5556 7001 7002 22
