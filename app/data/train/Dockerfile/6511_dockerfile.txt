# Ubuntu 12.04 with graphite
#
# VERSION 0.1

FROM asyncee/ubuntu12.04-base

MAINTAINER asyncee

# graphite and dependencies
RUN apt-get install -y python-cairo \
    && apt-get clean \
    && rm -rf /var/cache/apt/archives/* /var/lib/apt/lists/*

RUN pip install supervisor uwsgi \
    whisper==0.9.12 carbon==0.9.12 graphite-web==0.9.12 \
    django==1.5 django-tagging>=0.3.1 twisted==11.1

WORKDIR /opt/graphite

# configuration
RUN mv /opt/graphite/conf/aggregation-rules.conf.example /opt/graphite/conf/aggregation-rules.conf; \
    mv /opt/graphite/conf/blacklist.conf.example /opt/graphite/conf/blacklist.conf; \
    mv /opt/graphite/conf/carbon.amqp.conf.example /opt/graphite/conf/carbon.amqp.conf; \
    mv /opt/graphite/conf/dashboard.conf.example /opt/graphite/conf/dashboard.conf; \
    mv /opt/graphite/conf/graphTemplates.conf.example /opt/graphite/conf/graphTemplates.conf; \
    mv /opt/graphite/conf/graphite.wsgi.example /opt/graphite/conf/graphite.wsgi; \
    mv /opt/graphite/conf/relay-rules.conf.example /opt/graphite/conf/relay-rules.conf; \
    mv /opt/graphite/conf/rewrite-rules.conf.example /opt/graphite/conf/rewrite-rules.conf; \
    mv /opt/graphite/conf/storage-aggregation.conf.example /opt/graphite/conf/storage-aggregation.conf; \
    mv /opt/graphite/conf/storage-schemas.conf.example /opt/graphite/conf/storage-schemas.conf; \
    mv /opt/graphite/conf/whitelist.conf.example /opt/graphite/conf/whitelist.conf; \ 
    ln -s /opt/graphite/conf/graphite.wsgi /opt/graphite/webapp/graphite/wsgi.py

# external files
ADD conf/supervisord.conf /opt/graphite/supervisord.conf
ADD conf/uwsgi.ini /opt/graphite/uwsgi.ini
ADD conf/local_settings.py /opt/graphite/webapp/graphite/local_settings.py
ADD conf/carbon.conf /opt/graphite/conf/carbon.conf
ADD conf/storage-schemas.conf /opt/graphite/conf/storage-schemas.conf
ADD conf/initial_data.json /opt/graphite/webapp/graphite/initial_data.json

# creating database and admin user
RUN python /opt/graphite/webapp/graphite/manage.py syncdb --noinput --no-initial-data
RUN python /opt/graphite/webapp/graphite/manage.py loaddata /opt/graphite/webapp/graphite/initial_data.json

RUN echo "root:root" | chpasswd

EXPOSE 22 8000 2003 2003/udp 2004 7002

CMD supervisord -c /opt/graphite/supervisord.conf -n
