FROM jsurf/rpi-raspbian:stretch

RUN apt-get update
RUN apt-get install -y git
RUN apt-get install -y python3
RUN apt-get install -y python3-pip
# for pyyaml
RUN apt-get install -y python3-setuptools

#
# build Azure IoT SDKs for Python
#
WORKDIR /root/
RUN mkdir build
WORKDIR /root/build/

RUN git clone --recursive https://github.com/Azure/azure-iot-sdk-python.git 

WORKDIR /root/build/azure-iot-sdk-python/build_all/linux/

RUN ./setup.sh --python-version 3.5
RUN ./build.sh --build-python 3.5

#
# install required python modules
#
RUN python3 -m pip install pytz
RUN python3 -m pip install pyyaml
RUN python3 -m pip install pyserial
RUN python3 -m pip install azure-iothub-device-client

#
# setup TweLiteGateway
#
WORKDIR /root/
RUN mkdir twe_lite_gateway
WORKDIR /root/twe_lite_gateway
COPY src/* ./

# COPY IoTHub Device Client library
RUN cp /root/build/azure-iot-sdk-python/device/samples/iothub_client.so .

#
# remove Azure Iot SDKs for Python build files
#
RUN rm -rf /root/build/

#
# run TweLiteGateway
#
CMD ["python3", "gateway.py", "TweLiteGateway"]

