Imports SiiLib
Imports SiiLib.General.SharedFunct

Public Class NoWear
    Private Function GetCheckedObjects(Optional Nodes As TreeNodeCollection = Nothing) As List(Of SiiAttribute)
        Dim Output As New List(Of SiiAttribute)

        If Nodes Is Nothing Then Nodes = TreeView1.Nodes

        For Each Itm As TreeNode In Nodes
            If Itm.Checked AndAlso Not (Itm.Tag Is Nothing) Then Output.Add(Itm.Tag)
            If Itm.Nodes.Count Then Output.AddRange(GetCheckedObjects(Itm.Nodes))
        Next

        Return Output
    End Function

    Private Sub FillTree()
        Dim LastTreeNode As TreeNode, TrailersNode As TreeNode, TrucksNode As TreeNode
        Dim Player As SiiElement, Trailers As List(Of SiiElement), Trucks As List(Of SiiElement), Accessories As List(Of SiiAttribute)
        Dim AssignedTruck As String = vbNullString, AssignedTrailer As String = vbNullString
        Dim WearMax As Single = 0, AccessoriesWear As Single

        Player = sii.GetFirstElementByType("player")
        Trailers = sii.GetElementsByType("trailer")
        Trucks = sii.GetElementsByType("vehicle")

        If Not (Player Is Nothing) Then
            Try
                AssignedTruck = Player.GetFirstAttributeByName("assigned_truck").Value.ToString
                AssignedTrailer = Player.GetFirstAttributeByName("assigned_trailer").Value.ToString
            Catch ex As Exception

            End Try
        End If

        TreeView1.Nodes.Clear()

        TrucksNode = TreeView1.Nodes.Add("Trucks", My.Resources.Trucks, ICON_TRUCK, ICON_TRUCK)

        For Each t As SiiElement In Trucks
            LastTreeNode = TrucksNode.Nodes.Add(t.Name, t.Name, IIf(t.Name = AssignedTruck, ICON_PLAYER, ICON_TRUCK), IIf(t.Name = AssignedTruck, ICON_PLAYER, ICON_TRUCK))

            Accessories = t.GetAttributesByName("accessories")
            WearMax = 0

            For Each AccessoriesItm As SiiAttribute In Accessories
                If Not (AccessoriesItm.Index = SiiAttribute.NO_INDEX) Then
                    Dim AccessoriesElem As SiiElement = sii.GetElementByName(AccessoriesItm.Value.ToString)

                    AccessoriesWear = IEEE754_ToSingle(AccessoriesElem.GetFirstAttributeByName("wear").Value.ToString)
                    WearMax = Math.Max(WearMax, AccessoriesWear)

                    LastTreeNode.Nodes.Add(
                        "[ " & FormatPercent(AccessoriesWear, 0, TriState.True) & " ] " & AccessoriesElem.GetFirstAttributeByName("data_path").Value.ToString
                    ).Tag = AccessoriesItm
                End If
            Next

            LastTreeNode.Text = "[ " & FormatPercent(WearMax, 0, TriState.True) & " ] " & LastTreeNode.Text
        Next

        TrailersNode = TreeView1.Nodes.Add("Trailers", My.Resources.Trailers, ICON_TRAILER, ICON_TRAILER)
        For Each t As SiiElement In Trailers
            LastTreeNode = TrailersNode.Nodes.Add(t.Name, t.Name, IIf(t.Name = AssignedTrailer, ICON_PLAYER, ICON_TRAILER), IIf(t.Name = AssignedTrailer, ICON_PLAYER, ICON_TRAILER))

            Accessories = t.GetAttributesByName("accessories")
            WearMax = 0

            For Each AccessoriesItm As SiiAttribute In Accessories
                If Not (AccessoriesItm.Index = SiiAttribute.NO_INDEX) Then
                    Dim AccessoriesElem As SiiElement = sii.GetElementByName(AccessoriesItm.Value.ToString)

                    AccessoriesWear = IEEE754_ToSingle(AccessoriesElem.GetFirstAttributeByName("wear").Value.ToString)
                    WearMax = Math.Max(WearMax, AccessoriesWear)

                    LastTreeNode.Nodes.Add(
                        "[ " & FormatPercent(AccessoriesWear, 0, TriState.True) & " ] " & AccessoriesElem.GetFirstAttributeByName("data_path").Value.ToString
                    ).Tag = AccessoriesItm
                End If
            Next

            LastTreeNode.Text = "[ " & FormatPercent(WearMax, 0, TriState.True) & " ] " & LastTreeNode.Text
        Next

        TrucksNode.Expand()
        TrailersNode.Expand()
    End Sub

    Private Sub NoWear_Load(sender As System.Object, e As System.EventArgs) Handles MyBase.Load
        Me.Icon = My.Resources.IconRepair

        TreeView_Init(TreeView1)
        FillTree()
    End Sub

    Private Sub TreeView1_AfterCheck(sender As Object, e As System.Windows.Forms.TreeViewEventArgs) Handles TreeView1.AfterCheck
        Dim CheckedNode As TreeNode = e.Node, AllSameChecked As Boolean = False
        Static Lock As Boolean = False

        For Each SubNode As TreeNode In CheckedNode.Nodes
            SubNode.Checked = CheckedNode.Checked
        Next
    End Sub

    Private Sub BtnFix_Click(sender As System.Object, e As System.EventArgs) Handles BtnFix.Click
        Dim CheckedObjects As New List(Of SiiAttribute), itm As SiiAttribute
        CheckedObjects = GetCheckedObjects()

        For i = 0 To CheckedObjects.Count - 1
            itm = CheckedObjects.Item(i)
            If Not itm.Value.IsCompiled Then itm.Value.Compile(sii.Items)

            itm.Value.RefElement.GetFirstAttributeByName("wear").Value.x = 0

            Dim test = itm.Value.RefElement.GetFirstAttributeByName("wear").ToString
        Next

        FillTree()
    End Sub
End Class