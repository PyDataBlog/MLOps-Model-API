Imports Visomes.MySQL

''' <summary>
''' LISTA DE MATERIAIS DE UM ITEM DE RECEBIMENTO
''' </summary>
''' <remarks></remarks>
Public Class ListMaterialRecebimento

    Private indexItem As Integer
    Private data As DataTable
    Private materiaisAdd As New Generic.Dictionary(Of String, Integer)
    Private materiaisDel As New Generic.Dictionary(Of String, Integer)

    Public ReadOnly Property MateriaisDelete() As Generic.Dictionary(Of String, Integer)
        Get
            Return materiaisDel
        End Get
    End Property

    Public ReadOnly Property MateriaisAdiconar() As Generic.Dictionary(Of String, Integer)
        Get
            Return materiaisAdd
        End Get
    End Property

    ''' <summary>
    ''' INICIA UMA NOVA INSTÂNCIA DE frmCadMatRec
    ''' </summary>
    ''' <param name="idItem"></param>
    ''' <remarks></remarks>
    Public Sub New(ByVal idItem As Integer, _
                   ByRef materiaisAdd As Generic.Dictionary(Of String, Integer), _
                   ByRef materiaisDel As Generic.Dictionary(Of String, Integer), _
                   ByVal indexItem As Integer)
        InitializeComponent()
        Me.indexItem = indexItem
        Me.materiaisAdd = materiaisAdd
        Me.materiaisDel = materiaisDel
        CarregaDataGridViwer()
        CarregaMateriaisDataGridViwer(idItem)
    End Sub

    Public Sub New(ByRef materiaisAdd As Generic.Dictionary(Of String, Integer), _
                   ByRef materiaisDel As Generic.Dictionary(Of String, Integer), _
                   ByVal indexItem As Integer)
        InitializeComponent()
        Me.indexItem = indexItem
        Me.materiaisAdd = materiaisAdd
        Me.materiaisDel = materiaisDel
        CarregaDataGridViwer()
        CarregaByDicionary()
    End Sub

    ''' <summary>
    ''' OBTÉM LINHAS DO GRID
    ''' </summary>
    ''' <value></value>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public ReadOnly Property GetRowCollection() As DataGridViewRowCollection
        Get
            Return Me.dgvMat.Rows
        End Get
    End Property

    ''' <summary>
    ''' OBTÉM DATATABLE
    ''' </summary>
    ''' <value></value>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public ReadOnly Property GetDataTable() As DataTable
        Get
            Return Me.data
        End Get
    End Property

    ''' <summary>
    ''' CARREGA LINHAS DO DATAGRIDVIWER
    ''' </summary>
    ''' <remarks></remarks>
    Private Sub CarregaDataGridViwer()
        Connection.ConnectionMysql()
        Core.MyData = DML.Select("descricao,FALSE", _
                                 "recebimento_material", _
                                 "status = 1")
        If Not Core.MyData Is Nothing Then
            While Core.MyData.Read()
                Me.dgvMat.Rows.Add(Core.MyData.GetString(0), False)
            End While
            Core.MyData.Dispose()
        End If
        Connection.DisconnectMySQL()
    End Sub

    ''' <summary>
    ''' CARREGA MAT DOS ITEM
    ''' </summary>
    ''' <param name="idItem"></param>
    ''' <remarks></remarks>
    Private Sub CarregaMateriaisDataGridViwer(ByVal idItem As Integer)
        For Each row As DataGridViewRow In Me.dgvMat.Rows
            Connection.ConnectionMysql()
            Core.MyData = DML.Select("COUNT(*)", _
                                     "recebimento_material_item", _
                                     "idItem = " & idItem & " AND " _
                                   & "idMaterial = " & row.Index + 1 & "")
            If Not Core.MyData Is Nothing Then
                If Core.MyData.Read() Then
                    If Core.MyData.GetInt32(0) = 0 Then
                        row.Cells(1).Value = False
                    Else
                        row.Cells(1).Value = True
                        Me.materiaisAdd.Add(row.Cells(0).Value.ToString(), Me.indexItem)
                    End If
                End If
                Core.MyData.Dispose()
            End If
            Connection.DisconnectMySQL()
        Next
    End Sub

    Private Sub CarregaByDicionary()
        For Each key As String In Me.materiaisDel.Keys
            For Each row As DataGridViewRow In Me.dgvMat.Rows
                If row.Cells(0).Value.ToString().Equals(key) Then
                    row.Cells(1).Value = False
                End If
            Next
        Next
        For Each key As String In Me.materiaisAdd.Keys
            For Each row As DataGridViewRow In Me.dgvMat.Rows
                If row.Cells(0).Value.ToString().Equals(key) Then
                    row.Cells(1).Value = True
                End If
            Next
        Next
    End Sub

    ''' <summary>
    ''' ALTERA VALOR DE CHECKBOX
    ''' </summary>
    ''' <remarks></remarks>
    Private Sub dgvMat_CellContentClick(ByVal sender As System.Object, ByVal e As System.Windows.Forms.DataGridViewCellEventArgs) Handles dgvMat.CellClick
        If e.ColumnIndex = 1 Then
            If CBool(Me.dgvMat.CurrentRow.Cells(1).Value) Then
                Me.dgvMat.CurrentRow.Cells(1).Value = False
                If Not Me.materiaisDel.ContainsKey(Me.dgvMat.CurrentRow.Cells(0).Value.ToString()) Then
                    Me.materiaisDel.Add(Me.dgvMat.CurrentRow.Cells(0).Value.ToString(), Me.indexItem)
                    Me.materiaisAdd.Remove(Me.dgvMat.CurrentRow.Cells(0).Value.ToString())
                End If
            Else
                Me.dgvMat.CurrentRow.Cells(1).Value = True
                If Not Me.materiaisAdd.ContainsKey(Me.dgvMat.CurrentRow.Cells(0).Value.ToString()) Then
                    Me.materiaisAdd.Add(Me.dgvMat.CurrentRow.Cells(0).Value.ToString(), Me.indexItem)
                    Me.materiaisDel.Remove(Me.dgvMat.CurrentRow.Cells(0).Value.ToString())
                End If
            End If
        End If
    End Sub

    Private Sub frmCadMatRec_FormClosing(ByVal sender As System.Object, ByVal e As System.Windows.Forms.FormClosingEventArgs) Handles MyBase.FormClosing
        Me.DialogResult = Windows.Forms.DialogResult.OK
    End Sub
End Class