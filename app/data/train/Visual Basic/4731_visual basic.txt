Imports System.Windows.Forms
Imports System.Xml
Imports System.Xml.Serialization

Public Class ItemBrowser
    Private Sub Form1_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
    End Sub

    Public Sub XMLTreeItem(Item As Object)
        Try
            'Section 0, serialize the object to XML.
            Dim xf As New XmlSerializer(Item.GetType)
            Dim stream As New IO.StringWriter
            xf.Serialize(stream, Item)

            'MsgBox(stream.ToString)
            ' SECTION 1. Create a DOM Document and load the XML data into it.
            Dim dom As New XmlDocument()
            dom.LoadXml(stream.ToString)

            ' SECTION 2. Initialize the treeview control.
            MainTree.Nodes.Clear()
            MainTree.Nodes.Add(New TreeNode(dom.DocumentElement.Name))
            Dim tNode As New TreeNode()
            tNode = MainTree.Nodes(0)

            ' SECTION 3. Populate the TreeView with the DOM nodes.
            AddNode(dom.DocumentElement, tNode)


        Catch xmlEx As XmlException
            MessageBox.Show(xmlEx.Message)
        Catch ex As Exception
            MessageBox.Show(ex.ToString)
        End Try
        Try
            NodeCount.Text = MainTree.GetNodeCount(True).ToString + " nodes (" + MainTree.Nodes(0).GetNodeCount(False).ToString + " parents)"
        Catch ex As Exception
            NodeCount.Text = "Can't Count Nodes."
        End Try

        Me.Show()

    End Sub

    Private Sub AddNode(ByRef inXmlNode As XmlNode, ByRef inTreeNode As TreeNode)
        Dim xNode As XmlNode
        Dim tNode As TreeNode
        Dim nodeList As XmlNodeList
        Dim i As Integer

        ' Loop through the XML nodes until the leaf is reached.
        ' Add the nodes to the TreeView during the looping process.
        If inXmlNode.HasChildNodes() Then
            nodeList = inXmlNode.ChildNodes
            For i = 0 To nodeList.Count - 1
                xNode = inXmlNode.ChildNodes(i)
                inTreeNode.Nodes.Add(New TreeNode(xNode.Name))
                tNode = inTreeNode.Nodes(i)
                AddNode(xNode, tNode)
            Next
        Else
            ' Here you need to pull the data from the XmlNode based on the
            ' type of node, whether attribute values are required, and so forth.
            inTreeNode.Text = (inXmlNode.OuterXml).Trim
        End If
    End Sub

    Private Sub CollapseAllToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles CollapseAllToolStripMenuItem.Click
        MainTree.CollapseAll()
    End Sub

    Private Sub ExpandAllToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles ExpandAllToolStripMenuItem.Click

    End Sub

    Private Sub FindButton_Click(sender As Object, e As EventArgs) Handles FindButton.Click
        MainTree.CollapseAll()
        resetnodes(MainTree.Nodes)
        findnode(FindSearchBox.Text, MainTree.Nodes)
    End Sub

    Sub findnode(ByVal SearchText As String, ByVal Nodes As TreeNodeCollection)
        For Each Node As TreeNode In Nodes
            If Node.Text.ToUpper.Contains(SearchText.ToUpper) Then
                Node.Expand()
                ExpandParent(Node)
                Node.BackColor = Drawing.Color.LightCoral
            End If
            findnode(SearchText, Node.Nodes)
        Next
    End Sub

    Sub resetnodes(ByVal nodes As TreeNodeCollection)
        For Each Node As TreeNode In nodes
            Node.BackColor = System.Drawing.Color.White
            resetnodes(Node.Nodes)
        Next
    End Sub

    Sub ExpandParent(Node As TreeNode)
        Node.Parent.Expand()
        Try
            ExpandParent(Node.Parent)
        Catch ex As Exception

        End Try
    End Sub

    Private Sub EverythingToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles EverythingToolStripMenuItem.Click
        MainTree.ExpandAll()
    End Sub

    Private Sub SelectedOnlyToolStripMenuItem_Click(sender As Object, e As EventArgs) Handles SelectedOnlyToolStripMenuItem.Click
        MainTree.SelectedNode.ExpandAll()
    End Sub
End Class