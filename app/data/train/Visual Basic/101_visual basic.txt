Imports Transporter_AEHF.BurchfieldPositionerControl
Imports Transporter_AEHF.Objects.Enumerations
Imports Transporter_AEHF.Objects.Positioners
Imports NLog
Public Class PositionerConnectionForm

    Private _addressType As PumaEnums.ConnectionType
    Private _positionerModel As PumaEnums.PositionerModel
    Private _main As Main
    Private _positioner As Object

    Private Const EthernetHeader = ""
    Private Const EthernetFooter = ""
    Private Const UsbHeader = ""

    Private _log As Logger = LogManager.GetCurrentClassLogger
    Private _loggerSelection As String

    Sub New(ByVal aMain As Main)

        ' This call is required by the designer.
        InitializeComponent()

        ' Add any initialization after the InitializeComponent() call.
        _loggerSelection = aMain.LoggerSelection
        _main = aMain
    End Sub

    Private Sub cmboBoxConnectionType_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmboBoxConnectionType.SelectedIndexChanged

        If cmboBoxConnectionType.SelectedIndex = 0 Then 'if user selects ethernet
            lblConnectionAddress.Text = "Enter IP Adress"
            txtBoxConnectionAddress.Text = "192.168.100.179" '"TCPIP0::192.168.100.179::80::SOCKET" '169.254.117.216::INSTR"
            lblPort.Text = "Enter Port"
            txtBoxConnectionPort.Text = "4000"
            txtBoxConnectionAddress.Enabled = True
            txtBoxConnectionPort.Enabled = True
            _addressType = PumaEnums.ConnectionType.Ip
        ElseIf cmboBoxConnectionType.SelectedIndex = 1 Then 'if user selects com
            lblConnectionAddress.Text = "Com"
            txtBoxConnectionAddress.Text = "COM"
            lblPort.Text = "Enter Port"
            txtBoxConnectionPort.Text = "4"
            txtBoxConnectionPort.Enabled = True
            _addressType = PumaEnums.ConnectionType.Com
        End If

    End Sub

    Private Sub btnConnectPositioner_Click(sender As Object, e As EventArgs) Handles btnConnectPositioner.Click

        Dim address = Trim(txtBoxConnectionAddress.Text)
        Dim port = Trim(txtBoxConnectionPort.Text)

        'check the type of connection
        If _addressType = PumaEnums.ConnectionType.Ip Then  'if ethernet then use visa session

            'check the positioner type
            If _positionerModel = PumaEnums.PositionerModel.Burchfield Then 'if ethernet and Burchfield
                'try to establish a session
                'session should be managed with positioner object
                Try
                    'establish positioner object
                    _positioner = New BurchfieldUnit()
                    _positioner.connect(address, port, _addressType, _loggerSelection)
                    'send positioner object to positioner form
                    Dim posForm = New BurchfieldPositionerForm(_positioner, _loggerSelection)
                    posForm.Show()
                    Close()

                Catch ex As Exception
                    ErrorMessageFormat("Error trying to connect.", ex)
                    If _positioner IsNot Nothing Then
                        _positioner.dispose()
                    End If
                End Try

            ElseIf _positionerModel = PumaEnums.PositionerModel.DirectedPerception Then 'if ethernet and direct perception
                MsgBox("We do not currently support ethernet connections to direct perception positioners.  Try USB/Serial connection.")
            End If

        ElseIf _addressType = PumaEnums.ConnectionType.Com Then 'if usb then use serial session

            'check positioner type
            If _positionerModel = PumaEnums.PositionerModel.Burchfield Then 'if serial and Burchfield
                MsgBox("We do not currently support serial connections to Burchfield positioners.  Try Ethernet connection.")
            ElseIf _positionerModel = PumaEnums.PositionerModel.DirectedPerception Then 'if serial and direct perception
                Try
                    _positioner = New FlirUnit()
                    _positioner.connect(address & port)
                    Dim posForm = New FlirPositionerForm(_main, _positioner)
                    posForm.Show()
                    Me.Close()
                Catch ex As Exception
                    ErrorMessageFormat("Error trying to connect.", ex)
                    _positioner.dispose()
                End Try
            End If

        End If

    End Sub


    Private Sub cmboBoxPositionerType_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmboBoxPositionerType.SelectedIndexChanged
        If cmboBoxPositionerType.SelectedIndex = 0 Then 'if Burchfield selected
            _positionerModel = PumaEnums.PositionerModel.Burchfield
            cmboBoxConnectionType.Enabled = True
        ElseIf cmboBoxPositionerType.SelectedIndex = 1 Then 'if direct perception selected
            _positionerModel = PumaEnums.PositionerModel.DirectedPerception
            cmboBoxConnectionType.Enabled = True
        End If
    End Sub


    Private Sub btnPositionConnectCancel_Click(sender As Object, e As EventArgs) Handles btnPositionConnectCancel.Click
        Me.Dispose()
        Me.Close()
    End Sub


    Private Sub ErrorMessageFormat(ByVal message As String, ByVal ex As Exception)

        If ex.InnerException IsNot Nothing Then
            MsgBox(message & vbNewLine & "Message:" & vbNewLine & ex.Message & vbNewLine & "Inner Exception" & vbNewLine & _
                   ex.InnerException.Message, vbMsgBoxSetForeground)
        Else

            MsgBox(message & vbNewLine & "Message:" & vbNewLine & ex.Message, vbMsgBoxSetForeground)
        End If
    End Sub

End Class