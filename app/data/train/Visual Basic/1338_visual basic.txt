Public Class Chat
    Inherits System.Web.UI.Page

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If IsPostBack Then
        Else
            Dim user As String = Session("USER_ID")
            If Request.QueryString("Action").ToUpper = "CHATHEARTBEAT" Then

            ElseIf Request.QueryString("Action").ToUpper = "STARTCHATSESSION" Then

            ElseIf Request.QueryString("Action").ToUpper = "HISTORY" Then

            End If







        End If
    End Sub

    Private Sub startChatSession()
        getHistory()
    End Sub

    Private Sub chatHeartBeat()
        Dim response As String = ""
        Dim sessionID As Integer = 0
        Dim fromUser As String = Session("USER_ID")
        Dim toUser As String = Request.QueryString("toUserId")

        ''GET THE SESSION ID
        Dim strSessionSQL As String = "Select chat_sessions_id from P_SQL_PORTAL.dbo.chat_sessions where (user_1 = '" & fromUser & "' and user_2 = '" & toUser & "') or (user_2 = '" & fromUser & "' and user_1 = '" & toUser & "')"
        Dim sessionResult As DataTable = g_IO_Execute_SQL(strSessionSQL, False)
        If sessionResult.Rows.Count > 0 Then
            sessionID = sessionResult(0)(0)
        Else
            ''Create the session
            strSessionSQL = "Insert into P_SQL_PORTAL.dbo.chat_sessions (user_1, user_2) values ('" & fromUser & "', '" & toUser & "')"
            g_IO_Execute_SQL(strSessionSQL, False)
            sessionID = g_IO_GetLastRecId()
        End If

        Dim strSQL As String = "Select TOP 100 CM.[MESSAGE], CM.SENT, CM.RECD FROM P_SQL_PORTAL.DBO.CHAT_MESSAGES CM WHERE CHAT_SESSIONS_ID = " & sessionID & " ORDER BY ID ASC"
        Dim tblHistory As DataTable = g_IO_Execute_SQL(strSQL, False)

        If tblHistory.Rows.Count > 0 Then
            'Begin the response
            response = "{""items"": ["
            For Each chatMessage In tblHistory.Rows
                ''Iterate
                response &= "{"
                response &= """s"":""0"","
                response &= """f"":""" & chatMessage("SENT_BY") & ""","
                response &= """m"":""" & chatMessage("MESSAGE") & """"
                response &= "}"
            Next
            response &= "]}"
        Else
            ''Do nothing
        End If
    End Sub

    Private Sub getHistory()
        Dim response As String = ""
        Dim sessionID As Integer = 0
        Dim fromUser As String = Session("USER_ID")
        Dim toUser As String = Request.QueryString("toUserId")

        ''GET THE SESSION ID
        Dim strSessionSQL As String = "Select chat_sessions_id from P_SQL_PORTAL.dbo.chat_sessions where (user_1 = '" & fromUser & "' and user_2 = '" & toUser & "') or (user_2 = '" & fromUser & "' and user_1 = '" & toUser & "')"
        Dim sessionResult As DataTable = g_IO_Execute_SQL(strSessionSQL, False)
        If sessionResult.Rows.Count > 0 Then
            sessionID = sessionResult(0)(0)
        Else
            ''Create the session
            strSessionSQL = "Insert into P_SQL_PORTAL.dbo.chat_sessions (user_1, user_2) values ('" & fromUser & "', '" & toUser & "')"
            g_IO_Execute_SQL(strSessionSQL, False)
            sessionID = g_IO_GetLastRecId()
        End If

        Dim strSQL As String = "Select TOP 100 CM.[MESSAGE], CM.SENT, CM.RECD FROM P_SQL_PORTAL.DBO.CHAT_MESSAGES CM WHERE CHAT_SESSIONS_ID = " & sessionID & " ORDER BY ID ASC"
        Dim tblHistory As DataTable = g_IO_Execute_SQL(strSQL, False)

        If tblHistory.Rows.Count > 0 Then
            'Begin the response
            response = "{""items"": ["
            For Each chatMessage In tblHistory.Rows
                ''Iterate
                response &= "{"
                response &= """s"":""0"","
                response &= """f"":""" & chatMessage("SENT_BY") & ""","
                response &= """m"":""" & chatMessage("MESSAGE") & """"
                response &= "}"
            Next
            response &= "]}"
        Else
            ''Do nothing
        End If
    End Sub

    Private Sub sendMessage()

    End Sub

    Private Sub markRead()

    End Sub
End Class