Public Class NuevaListaPrecios

    Dim ControlesConErrores As List(Of Control) = New List(Of Control)
    Dim idSeleccionado As Integer = -1


#Region "Botones"

    Private Sub btn_Cancelar_Click(sender As Object, e As EventArgs) Handles btn_Cancelar.Click
        idSeleccionado = -1
        tbLista.Text = ""

        btn_Actualizar.Enabled = False
        btn_Guardar.Enabled = True
    End Sub
    Private Sub btn_Guardar_Click(sender As Object, e As EventArgs) Handles btn_Guardar.Click
        'Verificacion de campos obligatorios completos
        If tbLista.Text = "" Then
            formMain.ErrorProvider.SetError(tbLista, "Debe completar el campo")
            If Not ControlesConErrores.Contains(tbLista) Then
                ControlesConErrores.Add(tbLista)
            End If
        Else
            formMain.ErrorProvider.SetError(tbLista, "")
            ControlesConErrores.Remove(tbLista)
        End If

        'Verificamos que todos los campos hayan pasado las validaciones
        If ControlesConErrores.Count > 0 Then
            MsgBox("Por favor revise los campos ingresados", MsgBoxStyle.Exclamation, "Error")
            Exit Sub
        End If

        ' GUARDAR
        If (MsgBox("Está seguro?", MsgBoxStyle.OkCancel, "Guardar?") = MsgBoxResult.Ok) Then

            If (NuevaListaPrecio(
                         tbLista.Text
                        ) = True) Then
                PreciosNuevaLista(obtenerID("ListaPrecios", "nombre", tbLista.Text))
                MsgBox("Guardada correctamente.", MsgBoxStyle.Information, "Guardado")
                idSeleccionado = -1
                tbLista.Text = ""
                btn_Guardar.Enabled = True
                btn_Actualizar.Enabled = False
                cargarListaPrecios(dgvGrid)
            Else
                MsgBox("Ocurrió un problema al guardar", MsgBoxStyle.Critical, "Error")
            End If

        End If
    End Sub
    Private Sub btn_Actualizar_Click(sender As Object, e As EventArgs) Handles btn_Actualizar.Click
        ' Verificacion de campos obligatorios completos
        If tbLista.Text = "" Then
            formMain.ErrorProvider.SetError(tbLista, "Debe completar el campo")
            If Not ControlesConErrores.Contains(tbLista) Then
                ControlesConErrores.Add(tbLista)
            End If
        Else
            formMain.ErrorProvider.SetError(tbLista, "")
            ControlesConErrores.Remove(tbLista)
        End If

        If idSeleccionado = -1 Then
            MsgBox("Error al obtener el ítem seleccionado." & vbCrLf &
                   "Intente seleccionarlo nuevamente.", MsgBoxStyle.Exclamation, "Error")
            Exit Sub
        End If

        'Verificamos que todos los campos hayan pasado las validaciones
        If ControlesConErrores.Count > 0 Then
            MsgBox("Por favor revise los campos ingresados", MsgBoxStyle.Exclamation, "Error")
            Exit Sub
        End If

        'Verificación de item Repetido
        If existActualizar("ListaPrecios", "nombre", tbLista.Text, idSeleccionado) Then
            MsgBox("Ya existe una lista de precios con ese nombre", MsgBoxStyle.Exclamation, "Error")
            Exit Sub
        End If


        ' ACTUALIZAR
        If (MsgBox("Está seguro?", MsgBoxStyle.OkCancel, "Guardar?") = MsgBoxResult.Ok) Then

            If (EditarListaPrecio(
                         idSeleccionado,
                         tbLista.Text
                        ) = True) Then
                MsgBox("Guardado correctamente", MsgBoxStyle.Information, "Guardado")
                tbLista.Text = ""
                idSeleccionado = -1
                btn_Actualizar.Enabled = False
                btn_Guardar.Enabled = True
                cargarListaPrecios(dgvGrid)
            Else
                MsgBox("Ocurrió un problema al editar el ítem", MsgBoxStyle.Critical, "Error")
            End If

        End If
    End Sub
    Private Sub btn_Eliminar_Click(sender As Object, e As EventArgs) Handles btn_Eliminar.Click
        If dgvGrid.SelectedRows.Count = 0 Then
            MsgBox("Error al obtener la lista seleccionado." & vbCrLf &
                   "Intente seleccionarlo nuevamente.", MsgBoxStyle.Exclamation, "Error")
            Exit Sub
        End If

        ' ELIMINAR
        If (MsgBox("Está seguro?", MsgBoxStyle.OkCancel, "Eliminar?") = MsgBoxResult.Ok) Then

            If (EliminarListaPrecio(dgvGrid.CurrentRow.Cells("id").Value) = True) Then
                MsgBox("Eliminado Correctamente", MsgBoxStyle.Information, "Eliminado")
                tbLista.Text = ""
                idSeleccionado = -1
                btn_Actualizar.Enabled = False
                btn_Guardar.Enabled = True
                cargarListaPrecios(dgvGrid)
            Else
                MsgBox("Ocurrió un problema al eliminar el ítem", MsgBoxStyle.Critical, "Error")
            End If

        End If
    End Sub

#End Region

#Region "Eventos"

    Private Sub NuevaListaPrecios_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        cargarListaPrecios(dgvGrid)
    End Sub
    Private Sub dgvGrid_CellMouseDoubleClick(sender As Object, e As DataGridViewCellMouseEventArgs) Handles dgvGrid.CellMouseDoubleClick
        If e.RowIndex >= 0 Then
            idSeleccionado = CInt(dgvGrid.Rows(e.RowIndex).Cells("id").Value)
            tbLista.Text = dgvGrid.Rows(e.RowIndex).Cells("nombre").Value

            btn_Guardar.Enabled = False
            btn_Actualizar.Enabled = True
        End If
    End Sub

#End Region

#Region "Validaciones"

    Private Sub tbLista_KeyPress(sender As Object, e As KeyPressEventArgs) Handles tbLista.KeyPress
        keyverify(e, numeros:=True, letras:=True, espacios:=True, comas:=True)
    End Sub

#End Region

End Class