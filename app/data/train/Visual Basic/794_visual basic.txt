Imports System.Configuration
Imports System.Data.SqlClient
Imports System
Imports System.Text
Imports System.Security.Cryptography

Public Class UC_License

    Private Sub UC_License_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        LBLTitle.Text = "License"
        txtLicense.Clear()
        If My.Settings.LIC <> "" Then
            Dim LIC As String = DecryptString(My.Settings.LIC)

            Dim installdate As String = Get_License(4, LIC)
            lblInstallDate.Text = ": " & Format(CDate(installdate), "dd MMMM yyy")

            Dim valid As String = Get_License(5, LIC)
            If valid <> "4ever" Then
                lblValidDate.Text = ": " & Format(CDate(valid), "dd MMMM yyy")
                lblVersion.Text = ": 2.0 - Trial Version"
            Else
                lblVersion.Text = ": 2.0 - Full Version"
                lblValidDate.Text = ": - "
            End If
        Else
            lblInstallDate.Text = ": - "
            lblValidDate.Text = ": - "
        End If
    End Sub

    Private Function DecryptString(ByVal sourceText As String) As String
        Dim DES As New TripleDESCryptoServiceProvider
        Dim Md5 As New MD5CryptoServiceProvider
        DES.Key = Md5.ComputeHash(ASCIIEncoding.ASCII.GetBytes("#W0L3Stech!++"))
        DES.Mode = CipherMode.ECB
        Dim Buffer As Byte() = Convert.FromBase64String(sourceText)
        Dim ByteHash() As Byte = DES.CreateDecryptor().TransformFinalBlock(Buffer, 0, Buffer.Length)
        Return ASCIIEncoding.ASCII.GetString(ByteHash)
    End Function

    Public Function Get_License(ByVal iType As Int16, ByVal LIC As String) As String
        Try
            Dim sArray() As String
            sArray = LIC.Split(CChar("$"))

            '# 1 - Key
            '# 2 - PC Name
            '# 3 - CPU ID
            '# 4 - Tanggal Install
            '# 5 - Valid

            Return sArray(iType - 1)
        Catch ex As Exception
            Return ""
        End Try
    End Function

    Private Sub btnUpdate_Click(sender As Object, e As EventArgs) Handles btnUpdate.Click
        If txtLicense.Text = "" Then
            MsgBox("Please fill license", MsgBoxStyle.Exclamation, "")
        Else
            If MessageBox.Show("Are you sure ?", "", MessageBoxButtons.OKCancel, MessageBoxIcon.Question) = DialogResult.OK Then
                My.Settings.LIC = txtLicense.Text.Trim
                My.Settings.Save()
                MsgBox("Success", MsgBoxStyle.Information, "")
                WriteLog("License", "Update Success")
                menu_utama.Hide()
                menu_utama.Kosongkan()
                SPLASH.Show()
            End If
            
        End If

    End Sub

    Private Sub btnBack_Click(sender As Object, e As EventArgs) Handles btnBack.Click
        menu_utama.PNLUtama.Controls.Clear()
        Dim a As New UC_MasterData
        a.Dock = DockStyle.Fill
        menu_utama.PNLUtama.Controls.Add(a)
    End Sub
End Class
