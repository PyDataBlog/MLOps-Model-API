Public Class Dashboard
    Inherits System.Web.UI.Page

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If IsPostBack Then

        Else
            loadProjectBoard()
            loadTasks()
            loadCalendar()
            loadChartVariables()
            getImportantCounts()
        End If


    End Sub

    Private Sub loadProjectBoard()
        Dim strSQL As String = "SELECT Top 1 Details FROM P_SQL_PORTAL.dbo.whiteboard order by whiteboard_id"
        litProjectBoard.Text = "<span class=""btn""><a href=""Whiteboard.aspx"">Update</a></span><br /><br />"
        litProjectBoard.Text &= Server.HtmlDecode(g_IO_Execute_SQL(strSQL, False)(0)(0))

    End Sub

    Private Sub loadTasks()
        Dim strSQL As String = "Select Task_Name, Priority, Task_Details from vw_tasks where assigned_to = '" & Session("User_ID") & "' and is_complete = 0"
        Dim tblTasks As DataTable = g_IO_Execute_SQL(strSQL, False)

        Dim noteText As String = ""
        If tblTasks.Rows.Count > 0 Then
            litTaskList.Text = "<table>"

            'start the listing
            For Each row In tblTasks.Rows
                litTaskList.Text &= "<tr>"
                litTaskList.Text &= "<td class=""td1"">"
                ''Insert Priority Circle''
                If row("priority") = "Low" Then
                    litTaskList.Text &= "<img src=""images/Circle_Green.png"" class=""taskImg"" />"
                ElseIf row("priority") = "Normal" Then
                    litTaskList.Text &= "<img src=""images/Circle_Yellow.png"" class=""taskImg"" />"
                Else
                    litTaskList.Text &= "<img src=""images/Circle_Red.png"" class=""taskImg"" />"
                End If
                litTaskList.Text &= "</td>"
                litTaskList.Text &= "<td class=""td2"">"
                litTaskList.Text &= row("Task_Name")
                litTaskList.Text &= "</td>"
                litTaskList.Text &= "</tr>"
            Next
            litTaskList.Text &= "</table>"
        End If
    End Sub

    Private Sub loadCalendar()
        Dim strSQL As String = "sp_portal_getDashboardCalendarEntries;"
        Dim tblResults As DataTable = g_IO_Execute_SQL(strSQL, False)
        litCalendarEntries.Text = "<a href=""Calender.aspx""><h3>Calendar</h3></a>"
        If tblResults.Rows.Count > 0 Then
            ''Begin the Table
            litCalendarEntries.Text &= "<table>"
            litCalendarEntries.Text &= "<tr><th>Who</th><th>Start</th><th>End</th><th>Subject</th></tr>"
            For Each row In tblResults.Rows
                ''Begin the row
                litCalendarEntries.Text &= "<tr>"
                litCalendarEntries.Text &= "<td>" & row("CALENDAR") & "</td>" & _
                    "<td>" & row("STARTDATE") & " - " & row("STARTTIME") & "</td>" & _
                    "<td>" & row("ENDDATE") & " - " & row("ENDTIME") & "</td>" & _
                    "<td>" & row("SUBJECT") & "</td>"
                litCalendarEntries.Text &= "</tr>"
            Next
            litCalendarEntries.Text &= "</table>"
        Else

            litCalendarEntries.Text &= "<p>No Upcoming Events entered at this time.<p>"
        End If

    End Sub

    Private Sub loadChartVariables()

        ''var data = [
        ''['Heavy Industry', 12], ['Retail', 9], ['Light Industry', 14],
        ''['Out of home', 16], ['Commuting', 7], ['Orientation', 9]
        ''];

        Dim strSQL As String = "SELECT SQL_OPERATING_SYSTEM, COUNT(server_id) as TTLCount FROM [P_SQL_PORTAL].[dbo].[vw_server_listing_detail] GROUP BY SQL_OPERATING_SYSTEM"
        Dim tblCounts As DataTable = g_IO_Execute_SQL(strSQL, False)
        Dim delimiter As String = ""
        If tblCounts.Rows.Count > 0 Then
            ''begin the variable
            litChartVariables.Text = "<script>var data = ["

            For Each row In tblCounts.Rows
                litChartVariables.Text &= delimiter & "['" & row("SQL_OPERATING_SYSTEM") & "'," & row("TTLCount") & "]"
                delimiter = ","
            Next

            ''end the variable;
            litChartVariables.Text &= "];</script>"
        Else
            ''Do nothing because it won't matter anyway.
        End If
    End Sub

    Private Sub getImportantCounts()
        Dim tblResults As DataTable = g_getCountFailedBackupsLastDay()

        litImportantItems.Text = "<span class=""countBlock""><a href=""rpt_BackupFailuresReport.aspx""><span class=""countBlockTitle"">Failed Backups</span></a>" & _
            "<span class=""countBlockNumber"">" & tblResults.Rows(0)(0) & "</span></span>"

        tblResults = g_getCount_FailedSqlJobs()

        litImportantItems.Text &= "<span class=""countBlock""><a href=""rpt_RecentFailedJobs.aspx""><span class=""countBlockTitle"">Failed Jobs</span></a>" & _
            "<span class=""countBlockNumber"">" & tblResults.Rows(0)(0) & "</span></span>"

    End Sub

    Protected Sub imgImageSearch_Click(sender As Object, e As ImageClickEventArgs) Handles imgImageSearch.Click
        litSearchResults.Text = g_globalSearch(txtSearch.Text, "LIMITED")
    End Sub
End Class