Imports System.IO
Imports System.Net

Public Class Updater

    ' HiF-Client - A client to connect to the HiF database
    ' Copyright (C) 2016 Hawaii Impossible Force team

    ' This program Is free software: you can redistribute it And/Or modify
    ' it under the terms Of the GNU General Public License As published by
    ' the Free Software Foundation, either version 3 Of the License, Or
    ' (at your option) any later version.

    ' This program Is distributed In the hope that it will be useful,
    ' but WITHOUT ANY WARRANTY; without even the implied warranty Of
    ' MERCHANTABILITY Or FITNESS FOR A PARTICULAR PURPOSE.  See the
    ' GNU General Public License For more details.

    ' You should have received a copy Of the GNU General Public License
    ' along with this program.  If Not, see <http://www.gnu.org/licenses/>.

    'Information: a application patcher (alpha)
    'To do:
    '- develop a patcher
    '- add changable proxy
    '- add json support, remove string as it is highly unstable

#Region "Setup Stuff"
    ''' <summary>
    ''' Is there an update available?
    ''' Returns a boolean
    ''' </summary>
    Dim UpdateExists As Boolean

    ''' <summary>
    ''' Change size to a window without the 'Update' button
    ''' </summary>
    Dim ChangeSize As New Size(Size.Width, 133)

    ''' <summary>
    ''' Returns the current version As string
    ''' </summary>
    Dim CurrentVersion As String = My.Application.Info.Version.ToString()

    ''' <summary>
    ''' Returns the latest version returned from server
    ''' </summary>
    Dim LatestVersion As String

    ''' <summary>
    ''' Does errors exist? Returns a boolean
    ''' </summary>
    Dim ErrorExists As Boolean = False

    ''' <summary>
    ''' The server world wide web URL, return as a string
    ''' </summary>
    Private ServerURL As String = Login.serverURL

    ''' <summary>
    ''' Force update, will update even if application is up to date.
    ''' </summary>
    Dim ForceUpdate As Boolean = False

    ''' <summary>
    ''' The title string in all messageboxes being showed to user
    ''' </summary>
    Public TitleString As String = "HiF - Information"

    ''' <summary>
    ''' URI to fetch update data from
    ''' </summary>
    Public UpdateURI As String = ServerURL + "/project/hifclient/getVersion"

#End Region

    Public Sub PatchApplication()
        Try
            Process.Start(ServerURL + "/project/hifclient/")

        Catch ex As Exception
            MessageBox.Show(ex.Message, ex.GetType().Name, MessageBoxButtons.OK, MessageBoxIcon.Error)
            Application.Exit()

        End Try

        Me.Size = ChangeSize
        Me.Hide()
        Login.Show()

    End Sub 'Update Application

    Public Sub CheckForUpdate()
        Try
            Dim Request As HttpWebRequest = HttpWebRequest.Create(UpdateURI)
            Request.Timeout = 10000
            Dim responce As HttpWebResponse = Request.GetResponse()
            Dim ReadText As StreamReader = New StreamReader(responce.GetResponseStream())
            LatestVersion = ReadText.ReadToEnd()

        Catch ex As WebException
            'Letting itself know that it cannot reach to the server
            LatestVersion = "Not found"
            ErrorExists = True

            MessageBox.Show("An error occurred upon your request to the server, Try again later. " + ex.Message, TitleString, MessageBoxButtons.OK, MessageBoxIcon.Error)


        Catch ex As Exception
            MessageBox.Show(ex.Message, TitleString, MessageBoxButtons.OK, MessageBoxIcon.Error)
            Application.Exit()

        End Try

        'Displays newest version
        Label2.Text = Label2.Text + LatestVersion

        If LatestVersion = CurrentVersion Then
            If ForceUpdate = True Then
                UpdateBtn.Visible = False
                PatchApplication()
            End If
            UpdateExists = False
            UpdateBtn.Visible = False
            ExitBtn.Enabled = True
            Me.Size = ChangeSize
            MessageBox.Show("The client is up to date", TitleString, MessageBoxButtons.OK, MessageBoxIcon.Information)

        Else
            If ErrorExists = False Then
                'Starts here
                If LatestVersion < CurrentVersion Then
                    UpdateExists = False
                    UpdateBtn.Visible = False
                    ExitBtn.Enabled = True
                    Me.Size = ChangeSize
                    MessageBox.Show("The client is up to date", TitleString, MessageBoxButtons.OK, MessageBoxIcon.Information)
                Else
                    If UpdateExists = True Then
                        UpdateBtn.Visible = False
                        PatchApplication()
                    Else


                        Dim result As Integer = MessageBox.Show("A update is available, update now?", TitleString, MessageBoxButtons.YesNo, MessageBoxIcon.Question)
                        If result = DialogResult.Yes Then
                            'User pressed YES
                            PatchApplication()
                            UpdateBtn.Visible = False
                            ExitBtn.Enabled = True

                        ElseIf result = DialogResult.No Then
                            'User pressed NO
                            If UpdateExists = False Then
                                UpdateExists = True
                            End If
                            ExitBtn.Enabled = True
                            UpdateBtn.Text = "Update"
                            UpdateBtn.Enabled = True
                        End If
                    End If
                End If
                'Ends here
            Else
                'Error handling
                UpdateExists = False
                UpdateBtn.Visible = False
                ExitBtn.Enabled = True
                Me.Size = ChangeSize
            End If
        End If

        'Fix
        ExitBtn.Enabled = True
    End Sub 'Check for Update

    Private Sub Button1_Click(sender As Object, e As EventArgs) Handles UpdateBtn.Click

        'Disable buttons
        UpdateBtn.Enabled = False
        ExitBtn.Enabled = False

        'Disable force update check box
        FUCheckBox.Enabled = False

        UpdateBtn.Text = "Fetching data.."
        CheckForUpdate()
    End Sub 'Update button

    Private Sub Button2_Click(sender As Object, e As EventArgs) Handles ExitBtn.Click
        Me.Hide()
        Login.Show()
    End Sub 'Exit button

    Private Sub Updater_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        Label1.Text = Label1.Text + CurrentVersion
    End Sub 'Application loading

    Private Sub FUCheckBox_CheckedChanged(sender As Object, e As EventArgs) Handles FUCheckBox.CheckedChanged
        Select Case FUCheckBox.CheckState
            Case CheckState.Unchecked
                ForceUpdate = False
            Case CheckState.Checked
                ForceUpdate = True
        End Select
    End Sub 'Force Update button handler

End Class