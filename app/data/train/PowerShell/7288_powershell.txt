workflow Start-TeamCity
{	
	$daysOff = "Saturday", "Sunday";
	$today = (Get-Date).DayOfWeek;
	
	if($today -in $daysOff)
	{
		Write-Output "Day-off detected. Bye-bye.";
		return $null;
	}
	
	Write-Output "Adding teamcity account...";
	$pscreds = Get-AutomationPSCredential -Name "teamcity-account";
	Add-AzureAccount -Credential $pscreds | Write-Verbose;
	
	$vmScheduleTag = "vm-RunOnSchedule";
	$scheduleName = "workingDays";
	
	Write-Output "Getting virtual machines with tag ""$vmScheduleTag""=""$scheduleName""...";
	$vms = Get-AzureResource -TagName $vmScheduleTag -TagValue $scheduleName -OutputObjectFormat New;
	ForEach ($vm in $vms)
	{
		Write-Output "Starting virtual machine $($vm.ResourceName)...";
		Start-AzureVM -ResourceGroupName $vm.ResourceGroupName -Name $vm.ResourceName | Write-Verbose;
	}
	
	Write-Output "Done.";
	return $vms;
}