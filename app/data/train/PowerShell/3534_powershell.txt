# add powershell snapin for solarwinds so I can ask it questions
Add-PSSnapin SwisSnapin

$SourceServer = "mn601h5a033"
$DestinationServer = "localhost"

# create the connection to both source and destination SolarWinds servers
$swissource = Connect-Swis -Hostname $SourceServer -Trusted
$swisdest = Connect-Swis -Hostname $DestinationServer -trusted

$oldapps = Get-SwisData $swissource "SELECT Name, a.node.caption, a.node.IP_Address, ApplicationTemplateID, a.Template.Name as [templatename], '-3' as credential FROM Orion.APM.Application a"

foreach ($app in $oldapps) {
    "Working on $($App.Caption) - $($App.templatename)"

    $newnode = Get-SwisData $swisdest "select nodeid from orion.nodes where ip_address = '$($app.ip_address)'"
    if(!$newnode) {
        " No matching node in new environment"
    } else {
        " Match found, assigning template"
        $newtemplate = Get-SwisData $swisdest "select applicationtemplateid from orion.apm.applicationtemplate where name  = '$($app.templatename)'"
        if (!$newtemplate) {
            "  No matching template"
        } else {
            "  Assigning Template $newtemplate"
            if($app.templatename -like "AppInsight for SQL") {
                 Invoke-SwisVerb $swisdest "Orion.APM.SqlServerApplication" "CreateApplication" @(
                    #nodeid
                    "$newnode", 
                    #applicationtemplateid
                    "$newtemplate",
                    #credentialid
                    -3,
                    #skip if duplicate
                    1
                )
            }
            if($app.templatename -like "AppInsight for IIS") {
                 Invoke-SwisVerb $swisdest "Orion.APM.IIS.Application" "CreateApplication" @(
                    #nodeid
                    "$newnode", 
                    #applicationtemplateid
                    "$newtemplate",
                    #credentialid
                    -3,
                    #skip if duplicate
                    1
                )
            }
            if($app.templatename -like "AppInsight for Exchange") {
                 Invoke-SwisVerb $swisdest "Orion.APM.Exchange.Application" "CreateApplication" @(
                    #nodeid
                    "$newnode", 
                    #applicationtemplateid
                    "$newtemplate",
                    #credentialid
                    -3,
                    #skip if duplicate
                    1
                )
            }
            if($app.templatename -like "AppInsight for Active Directory") {
                 Invoke-SwisVerb $swisdest "Orion.APM.ActiveDirectory.Application" "CreateApplication" @(
                    #nodeid
                    "$newnode", 
                    #applicationtemplateid
                    "$newtemplate",
                    #credentialid
                    -3,
                    #skip if duplicate
                    1
                )
            } 
            if($app.templatename -notlike "AppInsight*") {
                Invoke-SwisVerb $swisdest "orion.apm.application" "CreateApplication" @(
                    #nodeid
                    "$newnode", 
                    #applicationtemplateid
                    "$newtemplate",
                    #credentialid
                    -3,
                    #skip if duplicate
                    1
                )
            }
        }
    }
}