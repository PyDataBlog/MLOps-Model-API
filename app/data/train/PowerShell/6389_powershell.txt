#This function takes a Cluster name as input, and filters for storage that contains "3PAR" in the friendly name and is not "unavailable"
#An array is created that contains each datastore in the cluster and is sorted by the percent of capacity that is "provisioned", in ascending order.
#The first element of the array is returned by this function, which is in effect the active datastore with the least provisioned space.


function get-LeastProvisionedDataStore {

    Param (
    [string]$Cluster
    )

    $array = get-cluster $Cluster | get-datastore | Where-Object {$_.name -like "*3PAR*" -and $_.State -notlike "Unavailable"} | select name, @{N="TotalSpaceGB";E={[Math]::Round(($_.ExtensionData.Summary.Capacity)/1GB,0)}},@{N="ProvisionedSpaceGB";E={[Math]::Round(($_.ExtensionData.Summary.Capacity - $_.ExtensionData.Summary.FreeSpace + $_.ExtensionData.Summary.Uncommitted)/1GB,0)}},@{N="ProvisionedThreshold";E={[Math]::Round(($_.ExtensionData.Summary.Capacity - $_.ExtensionData.Summary.FreeSpace + $_.ExtensionData.Summary.Uncommitted)/$_.ExtensionData.Summary.Capacity,2)}} | Sort-Object -Property ProvisionedThreshold
    $array[0]
    

    }

   