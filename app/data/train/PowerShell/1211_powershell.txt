$WebApplicationUrl = $args[0]
$SiteUrl = $args[1]
$SolutionName = $args[2]
$FeatureName = $args[3]

Add-PSSnapin microsoft.sharepoint.powershell

if ($FeatureName -ne $null)
{
    Write-Host "Deactivating feature: $FeatureName - " -NoNewline
	if (Get-SPFeature -Site $SiteURL | where {$_.DisplayName -eq $FeatureName})
        {
            Disable-SPFeature $FeatureName -Url $SiteUrl -Confirm:$false
        }
    Write-Host "Done" -foregroundcolor green
}

Write-Host "Retracting solution: $SolutionName - " -NoNewline
    $Solution = Get-SPSolution | ? {($_.Name -eq $SolutionName) -and ($_.Deployed -eq $true)}
    if ($Solution -ne $null)
    {
        if($Solution.ContainsWebApplicationResource)
        {
            Uninstall-SPSolution $SolutionName -WebApplication:$WebApplicationUrl -Confirm:$false
        }
        else
        {
            Uninstall-SPSolution $SolutionName -Confirm:$false
        }
    }
    
    while ($Solution.JobExists)
    {
        Start-Sleep 2
    }
Write-Host "Done" -foregroundcolor green
    
Write-Host "Removing solution: $SolutionName - " -NoNewline
    if ($(Get-SPSolution | ? {$_.Name -eq $SolutionName}).Deployed -eq $false)
    {
        Remove-SPSolution $SolutionName -Confirm:$false
    } 
Write-Host "Done" -foregroundcolor green