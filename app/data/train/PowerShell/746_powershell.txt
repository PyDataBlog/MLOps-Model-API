# Simple Powershell script that updates the roaming profile path and home directory for all users in an OU 
# Feel free to distribute and change as needed
# If you have any comments or updates to make this better, please email me, Roy Verrips (roy@verrips.org)

# Read the parameters from parameters.ps1
. '.\parameters.ps1'

#Load the Module
Import-Module ActiveDirectory

#Apply the changes
Get-ADUser -LDAPFilter "(&(objectclass=user)(objectcategory=user))" -SearchBase $SearchBase -Properties *| % { 
    #Update ProfilePath if needed
    If ($_.ProfilePath -eq $ProfilePath+($_.SamAccountName)) {
        $(get-date -f yyyy"-"MM"-"dd" "HH":"mm":"ss)+" User "+($_.SamAccountName)+" profile path is correct at "+$_.ProfilePath >> $LogFile
    } 
    else {
        Set-ADUser ($_.SamAccountName) -ProfilePath ($ProfilePath+$_.SamAccountName) 
        $(get-date -f yyyy"-"MM"-"dd" "HH":"mm":"ss)+" User "+($_.SamAccountName)+" profile path has been updated to "+$ProfilePath+($_.SamAccountName) >> $LogFile
    }
    #Update Homedrive if needed
    If ($_.Homedrive -eq $HomeDrive)  {
        $(get-date -f yyyy"-"MM"-"dd" "HH":"mm":"ss)+" User "+($_.SamAccountName)+" home drive is correct at "+$_.HomeDrive >> $LogFile
    } 
    else {
        Set-ADUser ($_.SamAccountName) -HomeDrive $HomeDrive 
        $(get-date -f yyyy"-"MM"-"dd" "HH":"mm":"ss)+" User "+($_.SamAccountName)+" home drive has been updated to "+$HomeDrive >> $LogFile
    }
    #Update HomeDirectory if needed
    If ($_.HomeDirectory -eq $HomeDirectory+($_.SamAccountName)) {
        $(get-date -f yyyy"-"MM"-"dd" "HH":"mm":"ss)+" User "+($_.SamAccountName)+" home path is correct at "+$_.HomeDirectory >> $LogFile
    } 
    else {
        Set-ADUser ($_.SamAccountName) -HomeDirectory ($HomeDirectory+$_.SamAccountName) 
        $(get-date -f yyyy"-"MM"-"dd" "HH":"mm":"ss)+" User "+$_.SamAccountName+" home path has been updated to "+($HomeDirectory+$_.SamAccountName) >> $LogFile
    }
    $(get-date -f yyyy"-"MM"-"dd" "HH":"mm":"ss) >> $LogFile
}

type $LogFile