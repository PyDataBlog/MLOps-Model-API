# Script to setup dev environment on Windows

# Paths to where virtual environment will be created
$projectPath = "D:\dev\anki\src\anki-sentence-cards"
$virtualEnvPath = "D:\dev\anki\venv\anki-sc"
$virtualEnvPython = Join-Path -Path $virtualEnvPath -ChildPath "Scripts\python.exe"
$ankiProfileDir = "D:\dev\anki\profile"

# Use chocolatey to install Python 2.7
choco install python2

$python27Path = "C:\Python27"

# Make sure virtualenv is installed in local system python environment
$pipExe = Join-Path -Path $python27Path -ChildPath "Scripts\pip.exe"
if (Test-Path -Path $pipExe) {
    # Install venv
    Invoke-Expression -Command "$pipExe install virtualenv"
} else {
    throw [System.IO.FileNotFoundException] "Could not find Python 2.7 pip executable."
}

# Create virtualenv
$virtualEnvExe = Join-Path -Path $python27Path -ChildPath "Scripts\virtualenv.exe"
if (Test-Path -Path $virtualEnvExe) {
    Invoke-Expression -Command "$virtualEnvExe $virtualEnvPath"
} else {
    throw [System.IO.FileNotFoundException] "Could not find virtualenv executable."
}

# Activate virtualenv and install pylint
$virtualEnvActivate = Join-Path -Path $virtualEnvPath -ChildPath "Scripts\activate.ps1"
$virtualEnvPip =  Join-Path -Path $virtualEnvPath -ChildPath "Scripts\pip.exe"
if (Test-Path -Path $virtualEnvActivate) {
    Invoke-Expression -Command "$virtualEnvActivate"
    Invoke-Expression -Command "$virtualEnvPip install pylint"
} else {
    throw [System.IO.FileNotFoundException] "Could not find virtualenv activation script."
}

# Create symlink so dev anki profile can see addon code
Set-Location $ankiProfileDir
New-Item -ItemType SymbolicLink -Name "addons" -Value $(Join-Path -Path $projectPath -ChildPath "src")

# Create environment variable with path to appropriate python executable
# Used so that Visual Studio Code can run the appropriate python environment
# and provide linting support etc
[System.Environment]::SetEnvironmentVariable("PYTHON_ANKI_DEV", $virtualEnvPython, "Machine")
# An again to add to local powershell process scope
[System.Environment]::SetEnvironmentVariable("PYTHON_ANKI_DEV", $virtualEnvPython, "Process")

# Set location and run vscode
Set-Location -Path $projectPath
code.cmd $projectPath