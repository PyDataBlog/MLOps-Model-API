######################3
#Requires NanoServerPackage module places in the same dir or already imported
#Connects to NANO host and allows management
#
#By Joel Ulrich
#

$Creds = Get-Credential
$ServerToManage = Read-Host "IP Or Hostname"
$WSMANhosts = Get-Item "WSMan:\localhost\Client\TrustedHosts"


#Check if WinRM is running
$Service = Get-Service -Name "WinRM"
if ($Service.Status -ne "Running"){
    Start-Service "WinRM"
    Write-Host "WinRM Starting.."
}

if ( ($WSMANhosts.Value -contains "*") -or ($WSMANhosts.Value -contains $ServerToManage) ) {
    if($PSBoundParameters.ContainsKey('cmd')) {
       Enter-PSSession -ComputerName $ServerToManage -Credential $Creds
     }
    if($PSBoundParameters.ContainsKey('InstallPackage')) {
     $PkgInstall = Invoke-Command -ComputerName $ServerToManage -Credential $Creds -ScriptBlock { 
        #Save-Module -Path “$env:ProgramFiles\WindowsPowerShell\Modules” -Name NanoServerPackage -MinimumVersion 1.0.0.0
        Import-Module NanoServerPackage
        Import-PackageProvider NanoServerPackage 
        Find-Package 
        } | Where {$_.Source -match "NanoServerPackageSource"} | Select Name, Summary | Out-GridView -PassThru -Title "Select a package to install"
     $PkgInstallName = $PkgInstall.Name
     Invoke-Command -ComputerName $ServerToManage -Credential $Creds -ScriptBlock { 
        Write-Host Installing $PkgInstallName on $ServerToManage
        Import-Module NanoServerPackage
        Import-PackageProvider NanoServerPackage 
        Install-Package $args[0]

        } -ArgumentList $PkgInstallName
     
     }



} else {
    Write-Host $ServerToManage has not been added to WSMAN Trusted Hosts or * not set.
}

 
 
 #Set-Item wsman:\localhost\client\trustedhosts *   
