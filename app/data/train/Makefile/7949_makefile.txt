DEPLOY_DIR=provision/roles/webtier/files/os/opt/urweb/plvsocial
DEPLOY=$(DEPLOY_DIR)/bin/plvsocial.exe
all : plvsocial.db
refresh: plvsocial.db plvsocial.pid static.pid 

.PHONY : deploy 

deploy : $(DEPLOY)

$(DEPLOY) : plvsocial.exe
	rm -rf  $(DEPLOY_DIR) ;\
	mkdir -p $(DEPLOY_DIR)/bin ;\
	cp plvsocial.exe $(DEPLOY) ;\
	cp -R static $(DEPLOY_DIR)/htdocs ;\
	cp -R data $(DEPLOY_DIR)

plvsocial.exe plvsocial.sql : plvsocial.urp plvsocial.urs plvsocial.ur config.ur identity.ur
	urweb -dbms sqlite plvsocial

config.ur : 
	autoconf && ./configure

plvsocial.db : plvsocial.sql
	rm -f plvsocial.db; sqlite3 plvsocial.db < plvsocial.sql ;\
	echo '.separator "|"'"\n"'.import data/uw_Plvsocial_plv_event.csv uw_Plvsocial_plv_event' | sqlite3 plvsocial.db ;\
	echo '.separator "|"'"\n"'.import data/uw_Plvsocial_plv_idea.csv uw_Plvsocial_plv_idea' | sqlite3 plvsocial.db 


static.pid:
	(cd static; nohup python -m SimpleHTTPServer > static.log 2>&1 & echo "$$!" > ../static.pid)


plvsocial.pid: plvsocial.exe
	killall -q plvsocial.exe ; \
	(nohup ./plvsocial.exe > plvsocial.log 2>&1 & echo "$$!" > plvsocial.pid)

clean:
	(test -f static.pid && kill "$(shell cat static.pid)" || true) ; \
	rm -f plvsocial.db plvsocial.sql plvsocial.exe coq.o *.pid plvsocial.log ; \
	(killall -q plvsocial.exe || true) ; \
	rm -rf config.status config.ur configure site.urp autom4te.cache config.log



