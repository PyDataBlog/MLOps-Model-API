############################################################################
# Copyright 2015-present Jonathan Barronville <jonathan@belairlabs.com>    #
#                                                                          #
# Licensed under the Apache License, Version 2.0 (the "License");          #
# you may not use this file except in compliance with the License.         #
# You may obtain a copy of the License at                                  #
#                                                                          #
#     http://www.apache.org/licenses/LICENSE-2.0                           #
#                                                                          #
# Unless required by applicable law or agreed to in writing, software      #
# distributed under the License is distributed on an "AS IS" BASIS,        #
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. #
# See the License for the specific language governing permissions and      #
# limitations under the License.                                           #
############################################################################

CURRENT_DIRECTORY = $(shell pwd)
TEMPORARY_DIRECTORY = $(CURRENT_DIRECTORY)/../tmp
TEMPORARY_BUILD_DIRECTORY = $(TEMPORARY_DIRECTORY)/build

DEPENDENCY_ARGTABLE2 = github.com/jonathanmarvens/argtable2
DEPENDENCY_CONCURRENCY_KIT = github.com/concurrencykit/ck
DEPENDENCY_JEMALLOC = github.com/jemalloc/jemalloc
DEPENDENCY_LIBPHENOM = github.com/facebook/libphenom
DEPENDENCY_LIBUUID = git.code.sf.net/p/libuuid/code
DEPENDENCY_LTHREAD = github.com/halayli/lthread

DEPENDENCIES = \
	$(DEPENDENCY_ARGTABLE2) \
	$(DEPENDENCY_CONCURRENCY_KIT) \
	$(DEPENDENCY_JEMALLOC) \
	$(DEPENDENCY_LIBPHENOM) \
	$(DEPENDENCY_LIBUUID) \
	$(DEPENDENCY_LTHREAD) \

.DEFAULT_GOAL := dependencies

dependencies: $(DEPENDENCIES)

.PHONY: dependencies

$(DEPENDENCY_ARGTABLE2): $(TEMPORARY_BUILD_DIRECTORY)
	cd $@ && \
	autoreconf -fiv && \
	./configure PKG_CONFIG_PATH="$(TEMPORARY_BUILD_DIRECTORY)/lib/pkgconfig" --disable-shared --enable-static --prefix="$(TEMPORARY_BUILD_DIRECTORY)" && \
	make V=1 && \
	make V=1 install
# make V=1 check

$(DEPENDENCY_CONCURRENCY_KIT): $(TEMPORARY_BUILD_DIRECTORY)
	cd $@ && \
	./configure --disable-shared --enable-static --prefix="$(TEMPORARY_BUILD_DIRECTORY)" && \
	make V=1 && \
	make V=1 install
# make V=1 check

$(DEPENDENCY_JEMALLOC): $(TEMPORARY_BUILD_DIRECTORY)
	cd $@ && \
	./autogen.sh PKG_CONFIG_PATH="$(TEMPORARY_BUILD_DIRECTORY)/lib/pkgconfig" --enable-lazy-lock --enable-xmalloc --prefix="$(TEMPORARY_BUILD_DIRECTORY)" --with-jemalloc-prefix="jemalloc_" --with-private-namespace="jemalloc_internal_" --without-export && \
	make V=1 build_lib_static && \
	make V=1 install_include install_lib
# make V=1 check

$(DEPENDENCY_LIBPHENOM): $(TEMPORARY_BUILD_DIRECTORY) $(DEPENDENCY_CONCURRENCY_KIT)
	cd $@ && \
	./autogen.sh && \
	./configure PKG_CONFIG_PATH="$(TEMPORARY_BUILD_DIRECTORY)/lib/pkgconfig" --disable-shared --enable-static --prefix="$(TEMPORARY_BUILD_DIRECTORY)" && \
	make V=1 && \
	make V=1 install
# make V=1 check

$(DEPENDENCY_LIBUUID): $(TEMPORARY_BUILD_DIRECTORY)
	cd $@ && \
	autoreconf -fiv && \
	./configure PKG_CONFIG_PATH="$(TEMPORARY_BUILD_DIRECTORY)/lib/pkgconfig" --disable-shared --enable-static --prefix="$(TEMPORARY_BUILD_DIRECTORY)" && \
	make V=1 && \
	make V=1 install
# make V=1 check

$(DEPENDENCY_LTHREAD): $(TEMPORARY_BUILD_DIRECTORY)
	cd $@ && \
	rm -frv .build && \
	mkdir -pv .build && \
	cd .build && \
	cmake -DCMAKE_INSTALL_PREFIX:PATH="$(TEMPORARY_BUILD_DIRECTORY)" .. && \
	make V=1 && \
	make V=1 install && \
	rm -frv .build
# make V=1 test

.PHONY: $(DEPENDENCIES)

$(TEMPORARY_BUILD_DIRECTORY): $(TEMPORARY_BUILD_DIRECTORY)/include $(TEMPORARY_BUILD_DIRECTORY)/lib

$(TEMPORARY_BUILD_DIRECTORY)/include:
	mkdir -pv $@

$(TEMPORARY_BUILD_DIRECTORY)/lib:
	mkdir -pv $@

.PHONY: $(TEMPORARY_BUILD_DIRECTORY)
