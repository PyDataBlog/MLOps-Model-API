AR := ar
CC := gcc
CFLAGS := --std=c99 -Wall -ffreestanding -pedantic -I. -Iinclude

LIBC := nooslibc.a
LIBC_OBJS := src/memcpy.o
LIBLIBC := lib$(LIBC)

TEST := nooslibc-test
TEST_OBJS := test/test.o test/start.o

LDFLAGS := -nostdlib -L. #-Wl,-T test/test.lds 

AFLAGS :=

all: $(LIBC) 
$(LIBC): $(LIBC_OBJS) Makefile
	$(AR) rcs $@ $(LIBC_OBJS)

# Overrides CFLAGS for test target
test: CFLAGS += -DNOOS_LIBC_TEST -Itest
test: $(TEST)
	./$(TEST)

# Link libc as whole-archive otherwise we will lose test_init section
$(TEST): $(LIBC) $(TEST_OBJS) Makefile
	$(CC) $(LDFLAGS) $(TEST_OBJS) -Wl,--whole-archive $(LIBC) -Wl,--no-whole-archive -lcunit -lgcc -o $@

clean:
	rm -rf $(LIBC) src/*.o
	rm -rf $(TEST) test/*.o

