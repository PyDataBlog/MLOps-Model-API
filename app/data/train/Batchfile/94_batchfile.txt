REM ×¢ÊÍ
@echo off
set ocd=%cd%
cd /d %~dp0

echo ##### ÌáÊ¾£º¶ÁÈ¡ÅäÖÃÎÄ¼þ #####
if exist ..\config.bat call ..\config.bat
if exist ..\..\config.bat call ..\..\config.bat
if exist ..\..\..\config.bat call ..\..\..\config.bat
if exist ..\..\..\..\config.bat call ..\..\..\..\config.bat
if exist ..\..\..\..\..\config.bat call ..\..\..\..\..\config.bat
if exist ..\..\..\..\..\..\config.bat call ..\..\..\..\..\..\config.bat
if exist ..\..\..\..\..\..\..\config.bat call ..\..\..\..\..\..\..\config.bat

echo ##### ÌáÊ¾£º±äÁ¿ÅäÖÃ #####
set LIBCURL_VERSION_NAME=curl-7.33.0
SET DIOS_PREBUILT=%cd%\prebuilt
SET DIOS_PLATFORM=win32
set BIN_DIRECTORY_DEBUG=%DIOS_PREBUILT%\bin\%DIOS_PLATFORM%\debug
set BIN_DIRECTORY_RELEASE=%DIOS_PREBUILT%\bin\%DIOS_PLATFORM%\release
set LIBRARY_DIRECTORY_DEBUG=%DIOS_PREBUILT%\lib\%DIOS_PLATFORM%\debug
set LIBRARY_DIRECTORY_RELEASE=%DIOS_PREBUILT%\lib\%DIOS_PLATFORM%\release
set INCLUDE_DIRECTORY=%DIOS_PREBUILT%\inc\libcurl

echo ##### ÌáÊ¾£º½âÑ¹ %LIBCURL_VERSION_NAME% #####
if not exist %LIBCURL_VERSION_NAME% (
	rem ½âÑ¹²Ù×÷
	%DIOS_TOOLS%\7za.exe x -y %LIBCURL_VERSION_NAME%.tar.bz2
	%DIOS_TOOLS%\7za.exe x -y %LIBCURL_VERSION_NAME%.tar
	del %LIBCURL_VERSION_NAME%.tar /Q
	)

cd %LIBCURL_VERSION_NAME%

mkdir %BIN_DIRECTORY_DEBUG%
mkdir %BIN_DIRECTORY_RELEASE%
mkdir %LIBRARY_DIRECTORY_DEBUG%
mkdir %LIBRARY_DIRECTORY_RELEASE%
mkdir %INCLUDE_DIRECTORY%

echo ##### ÌáÊ¾£ºVC»·¾³ #####
mkdir vc
cd vc
cmake -G %DIOS_GENERATOR_X64% ..

echo ##### ÌáÊ¾£º±àÒë #####
BuildConsole.exe CURL.sln /prj=libcurl /Silent /Cfg="Debug|x64,Release|x64" 

echo ##### ÌáÊ¾£º¿½±´ #####
copy /y ..\include\curl\*.h %INCLUDE_DIRECTORY%
copy /y lib\Debug\*.dll %BIN_DIRECTORY_DEBUG%
copy /y lib\Release\*.dll %BIN_DIRECTORY_RELEASE%
copy /Y lib\Debug\*.lib "%LIBRARY_DIRECTORY_DEBUG%"
copy /Y lib\Release\*.lib "%LIBRARY_DIRECTORY_RELEASE%"

rem ### cmake Ïà¹Ø
cd /d %~dp0
setlocal enabledelayedexpansion
call :GET_PATH_NAME %cd%
set project=%PATH_NAME%

if not exist  proj.win64 md proj.win64
cd proj.win64

echo #####ÌáÊ¾£º¿ªÊ¼¹¹½¨#####
cmake -G %DIOS_GENERATOR_X64% -DDIOS_CMAKE_PLATFORM=WIN64 ..
if %errorlevel% neq 0 goto :cmEnd
cmake -G %DIOS_GENERATOR_X64% -DDIOS_CMAKE_PLATFORM=WIN64 ..
if %errorlevel% neq 0 goto :cmEnd
echo #####ÌáÊ¾£º¹¹½¨½áÊø#####

echo #####ÌáÊ¾£º¿ªÊ¼±àÒë#####
BuildConsole.exe %project%.sln /prj=ALL_BUILD /Silent  /Cfg="Debug|x64,Release|x64" 
if %errorlevel% neq 0 goto :cmEnd
echo #####ÌáÊ¾£º±àÒë½áÊø#####

echo #####ÌáÊ¾£º¿ªÊ¼°²×°#####
cmake -DBUILD_TYPE="Debug" -P cmake_install.cmake
if %errorlevel% neq 0 goto :cmEnd
cmake -DBUILD_TYPE="Release" -P cmake_install.cmake
if %errorlevel% neq 0 goto :cmEnd
echo #####ÌáÊ¾£º°²×°½áÊø#####

goto cmDone
:cmEnd
echo setup failed
pause
exit

:cmDone
cmake -P dios_cmake_compile_succeeded.cmake
cmake -P dios_cmake_install_succeeded.cmake
cd /d %ocd%

@echo on

goto :eof
:GET_PATH_NAME
set PATH_NAME=%~n1