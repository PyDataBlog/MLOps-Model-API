// A method override middleware for [rkgo/web](https://github.com/rkgo/web)
//
//  app := web.New()
//  app.Use(methodoverride.Middleware())
//
package methodoverride

import (
	"strings"

	"github.com/rkgo/web"
)

const (
	overrideFormField = "_method"
	overrideHeader    = "X-HTTP-Method-Override"
)

// The method override middleware allows overriding a POST request to a PUT,
// PATCH or DELETE request using either the form field `_method` or the
// header X-HTTP-Method-Override.
func Middleware() web.Middleware {
	return func(ctx web.Context, next web.Next) {
		if ctx.Req().Method == "POST" {
			method := ctx.Req().FormValue(overrideFormField)

			if len(ctx.Req().Header.Get(overrideHeader)) > 0 {
				method = ctx.Req().Header.Get(overrideHeader)
			}

			if len(method) > 0 {
				method = strings.ToUpper(method)

				switch method {
				case "PUT", "PATCH", "DELETE":
					ctx.Req().Method = method
				}
			}
		}

		next(ctx)
	}
}
