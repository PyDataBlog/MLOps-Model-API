//+build cgo

package utub

import (
	"strings"

	"gopkg.in/olebedev/go-duktape.v2"
)

type duktapeJSEngine struct{}

func (js duktapeJSEngine) Name() string {
	return "Duktape"
}

func (js duktapeJSEngine) Available() bool {
	return true
}

func (js duktapeJSEngine) Exec(code string) (string, error) {
	ctx := duktape.New()
	defer ctx.DestroyHeap()

	err := ctx.PevalString(code)
	if err != nil {
		return "", err
	}

	return ctx.SafeToString(-1), nil
}

func (js duktapeJSEngine) sanitizeJSPlayerCode(code string) string {
	// SO UGLY!
	code = strings.Replace(code, `(?=:|,|]|}|$)`, `(?=:|,|\]|\}|$)`, 1)
	return code
}
