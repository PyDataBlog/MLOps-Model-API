package chatwork

import (
	"encoding/json"
	"net/url"
	"strings"
)

type MessageResult struct {
	MessageId int `json:"message_id"`
}

var format string = "/rooms/{roomId}/messages"

func (api *Client) PostMessage(roomId, text string) int {
	text = escapeMessage(text)
	apiUrl := CHATWORK_API + strings.Replace(format, "{roomId}", roomId, 1)

	values := url.Values{}
	values.Add("body", text)

	contents := api.Request("POST", apiUrl, values.Encode())
	var result MessageResult
	json.Unmarshal(contents, &result)
	return result.MessageId
}

func escapeMessage(message string) string {
	replacer := strings.NewReplacer("&", "&amp;", "<", "&lt;", ">", "&gt;")
	return replacer.Replace(message)
}
