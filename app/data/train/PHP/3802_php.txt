<?php

use app\models\Upload;

if ($object_id) {
    ?>
    <div>
        <img src="<?= Upload::getThumb($type, $value, true); ?>" data-toggle="lightbox" data-image="<?= Upload::getPicture($value, true); ?>" height="65" id="<?= $id; ?>_picture">
        <p>预览缩略图</p>
    </div>
<?php } else { ?>
    <img src="<?= Upload::getThumb($type, $value, true); ?>" height="65" id="<?= $id; ?>_picture"><p>预览缩略图</p>
    <?php
}
if ($display_upload && empty($value)) {
    ?>
    <div class="upload_picture">
        <input type="file" name="file" id="uploadif_<?= $id; ?>">         
    </div>
<?php } ?>
<input name="<?= $old_name; ?>" type="hidden" value="<?= $value; ?>">
<input name="<?= $name; ?>" type="hidden" id="<?= $id; ?>_path" value="<?= $value; ?>">
<?php if ($object_id && $value && $delete_url) { ?>
    <p><button class="btn btn-sm btn-danger btn-confirm" type="button" data-title="删除图片" data-url="<?php echo $delete_url; ?>" data-params="_csrf=<?= \Yii::$app->request->csrfToken ?>"><span class="icon-remove"></span> 删除</button></p>
<?php } ?>
<script type="text/javascript">
    $(function () {
        $('#uploadif_<?= $id; ?>').fileupload({
            url: '<?= $upload_url; ?>', //文件上传地址
            dataType: 'json',
            done: function (e, data) {
                //done方法就是上传完毕的回调函数，其他回调函数可以自行查看api
                if (data.result.error === 0) {
                    $('#<?= $id; ?>_path').val(data.result.url);
                    $('#<?= $id; ?>_picture').attr('src', '<?= \Yii::$app->params['upload_dir']; ?>' + data.result.url + '?' + Math.random());
                    $('#<?= $id; ?>_picture').attr('data-image', '<?= \Yii::$app->params['upload_dir']; ?>' + data.result.url + '?' + Math.random());
                    $('.upload_picture').hide();
                } else {
                    alert(data.result.message);
                }
            }
        });
    });
</script>