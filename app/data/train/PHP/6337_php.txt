<?php


	$fileURL = '../'.$_POST['fileURL'];
	$directoryToLoad = $_POST['directoryToLoad'];
	$directoryStructure = $_POST['DirectoryStructure'];

			$files = array();
			$folders = array();

			$folderItemIndex = array();
			$fileItemIndex = array();

	if (($directoryToLoad == 'root') && ($fileURL == '../')) {

		$directoryToLoad = '';

		for ($i = 0; $i < sizeof($directoryStructure)-1; $i++) {
			$itemName = $directoryStructure[$i];
			if (strpos($itemName,'/') == '') {
				$files[] = $itemName;
				$fileItemIndex[] = $i;
			}else{
				$itemName = substr($itemName,0,strpos($itemName,'/'));			
				if (in_array($itemName, $folders)) {}else{
					$folders[] = $itemName;
					$folderItemIndex[] = $i;
				}
			}
		}

	}else{
		if ($directoryToLoad == '') {
			$zip = new ZipArchive(); 

			$zip->open($fileURL);
	
			for ($i = 0; $i < $zip->numFiles; $i++) {
				$itemName = $zip->getNameIndex($i);
				if (strpos($itemName,'/') == '') {
					$files[] = $itemName;
					$fileItemIndex[] = $i;
				}else{
					$itemName = substr($itemName,0,strpos($itemName,'/'));			
					if (in_array($itemName, $folders)) {}else{
						$folders[] = $itemName;
						$folderItemIndex[] = $i;
					}
				} 
			}
		}else{
			
				$slashNumber = 1;
				$strlen = strlen($directoryToLoad);
				for( $i = 0; $i <= $strlen; $i++ ) {
					$char = substr( $directoryToLoad, $i, 1 );
					if ($char == '/') {
						$slashNumber += 1;
					}
				}



				for ($i = 0; $i < sizeof($directoryStructure)-1; $i++) {
					$parts  = explode('/', $directoryStructure[$i]);	/*remove everything after shash*/
					$directoryStructureDirectory = implode('/', array_slice($parts, 0, $slashNumber));   /*remove everything after shash*/
					if ($directoryStructureDirectory == $directoryToLoad) {
						$itemName = $directoryStructure[$i];

						/*----remove everything before slash----*/
						$arr = explode("/", $itemName);
						for( $x = 0; $x < $slashNumber; $x++ ) {
							//shifting array
							array_shift($arr);
						}
						//implode and return
						$itemName = implode("/", $arr);
						/*----end of remove everything before slash----*/

						if ($itemName != '') {
							if (strpos($itemName,'/') == '') {
								$files[] = $itemName;
								$fileItemIndex[] = $i;
							}else{
								$itemName = substr($itemName,0,strpos($itemName,'/'));			
								if (in_array($itemName, $folders)) {}else{
									$folders[] = $itemName;
									$folderItemIndex[] = $i;
								}
							}
						}
					}
				}
		}
	}


	$folderItemIndexNumber = 0;
	$fileItemIndexNumber = 0;
	$container = 0;
	$element = 0;
	foreach ($folders as $folder) {

		if ($directoryToLoad == '') {
		    $loadZipDirectory = "loadZipDirectory('".$folder."','','')";
		}else{
		    $loadZipDirectory = "loadZipDirectory('".$directoryToLoad."/".$folder."','','')";
		}

	    echo '<div id="Container'.$container.'" itemIndex="'.$folderItemIndex[$folderItemIndexNumber].'" class="file_display organize_files" ondblclick="'.$loadZipDirectory.'" onclick="check(this.id)">
			<input itemIndex="'.$folderItemIndex[$folderItemIndexNumber].'" value="" type="checkbox" class="hide_checkbox" id="Element'.$element.'">
			<img id="" src="extIcons/folder.png" height="96" width="96">  <br>
			<span class="cuttext">'.$folder.'</span>
		</div>';
		$folderItemIndexNumber += 1;
		$container += 1;
		$element += 1;
	}

	foreach ($files as $file) {
		$fileExtension = strtolower(substr($file, strrpos($file, '.') + 1));
		if (strpos($file,'.') == '') {
			$fileExtensionImage = 'extIcons/blank.png';
		}else{
			$fileExtensionImage = 'extIcons/'.strtolower(substr($file, strrpos($file, '.') + 1)).'.png';
		}
		
	    echo '<div id="Container'.$container.'" itemIndex="'.$fileItemIndex[$fileItemIndexNumber].'" class="file_display organize_files" ondblclick="" onclick="check(this.id)">
			<input itemIndex="'.$fileItemIndex[$fileItemIndexNumber].'" value="" type="checkbox" class="hide_checkbox" id="Element'.$element.'">
			<img id="" src="'.$fileExtensionImage.'" height="96" width="96">  <br>
			<span class="cuttext">'.$file.'</span>
		</div>';
		$fileItemIndexNumber += 1;
		$container += 1;
		$element += 1;
	} 	
	

?>
