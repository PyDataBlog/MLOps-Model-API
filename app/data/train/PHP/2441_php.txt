<?php
if(!defined('ROOT')) exit('No direct script access allowed');

$dashboard=getConfig("DASHBOARD_PAGE");
?>
<div id="workspace" style='display:none;overflow:hidden;width: 100%;height: 100%;'>
	<ul>
		<?php if(strlen($dashboard)>0) { ?>
			<li><a href='#dashboard'>Dashboard</a></li>
		<?php } ?>
	</ul>
	<?php if(strlen($dashboard)>0) { ?>
		<div id="dashboard" class="unclosable" style="overflow:hidden;width:100%;height:100%;">
			<iframe id="dashboardframe" src="<?=generatePageRequest($dashboard,"")?>" style="width:100%;height:100%;margin:0px;padding:0px;" frameborder=0>
			</iframe>
		</div>
	<?php } ?>
</div>
<a class='workspaceclose' onclick="closeCurrentTab()">&nbsp;X</a>
<script language=javascript>
var $tabs=null;
var resizePageTimer=null;
var sitepath="<?=generatePageRequest("","")?>";
function resizePageUI() {
	$("#dashboard").css("height",($("#content").height()-28)+"px");
	$("#workspace .iframetab").css("height",$("#dashboard").height());
}
$(function() {
	$(window).bind('resize', function() {
		if (resizePageTimer) {
			clearTimeout(resizePageTimer);
		}
		resizePageTimer=setTimeout(resizePageUI, 100);
	});
	setTimeout(function() {
		resizePageUI();
		$("#workspace").show();
	}, 120);
	$tabs = $("#workspace").tabs({
			ajaxOptions:{
				beforeSend:function() {
					return false;
				},
			},
			tabTemplate: "<li><a class='tabref' href='x' rel='#{href}'>#{label}</a> <span class='ui-icon ui-icon-closethick'>Remove Tab</span></li>",
			spinner: 'Loading ...',
			//fx: {},//opacity: 'toggle'
			crossDomain:false,
			cache:true,
			add: function( event, ui ) {
				//$( ui.panel ).append( "<p>" + tab_content + "</p>" );
				$tabs.tabs('select', '#' + ui.panel.id);
				loadTabFrame('#' + ui.panel.id,$("#workspace .tabref[href=#"+ui.panel.id+"]").attr("rel"));
			},
			select: function(event, ui) {
				var url = $.data(ui.tab, 'load.tabs');
				return true;
			},
			load: function(event, ui) {
				//Keep links, form submissions, etc. contained within the tab
				//$(ui.panel).hijack();
				return false;
			}
		});
	//$tabs.find( ".ui-tabs-nav" ).sortable({ axis: "x" }).disableSelection();
	$("#workspace").delegate("span.ui-icon-close,span.ui-icon-closethick","click",function() {
		var index = $( "li", $tabs ).index( $( this ).parent() );
			closeTab(index);
	});
});
function indexOfTab(url) {
	var links = $("#workspace > ul").find("li a");
	for(i=0;i<links.length;i++) {
		var lnk = $.data(links[i], 'load.tabs');
		if(lnk==url) return i;
	}
	return -1;
}
function closeTab(index) {
	if(!$($tabs.find(">div")[index]).hasClass("unclosable")) {
		$tabs.tabs("remove",index);
		return true;
	} else {
		return false;
	}
	//if(index==0) return false;
	//$tabs.tabs( "remove",index);
}
function closeCurrentTab() {
	var n = $tabs.tabs('option', 'selected');
	closeTab(n);
}
function openInNewTab(title, url) {
	if(indexOfTab(url)>=0) {
		$tabs.tabs("select",indexOfTab(url));
		return;
	}
	if(!(url.indexOf("http:")>=0) && !(url.indexOf("https:")>=0)) {
		if(!(url.indexOf("?")>=0)) {
			url=sitepath+"&"+url;
		} else {
			url=SiteLocation+url;
		}
	}
	$tabs.tabs("add", url, title );
	$("a.tabref").click(function(event) {
			loadTabFrame($(this).attr("href"),$(this).attr("rel"));
		});
	$("#workspace div.ui-tabs-panel").each(function() {
			if($(this).html().length<=0) $(this).detach();
		});
}
function openInCurrentTab(url) {
	var n = $tabs.tabs('option', 'selected');
	$tabs.tabs("url", n,url);
	$tabs.tabs("load", n);
	$tabs.tabs("select",n);
}
function loadTabFrame(tab, url) {
	if ($(tab).find("iframe").length == 0) {
		var html = [];
		//html.push('<div class="tabIframeWrapper">');
		html.push('<iframe class="iframetab" src="' + url + '" width=100% height=100% frameborder=0 style="padding:0px;border:0px;">Load Failed?</iframe>');
		//html.push('</div>');
		$(tab).append(html.join(""));
		$(tab).find("iframe").height($("#dashboard").height());
	}
	return false;
}
</script>
<style>
.iframetab {
	width:100%;
	border:0px;
	margin:0px;
	padding:0px;
	margin-top:0px;
}
#workspace div.ui-tabs-panel.ui-widget-content {
	border:0px;
}
</style>
