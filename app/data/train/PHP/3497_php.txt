<?php
require_once 'users/init.php';
global $errors, $successes, $thisUserID;

require_once 'usersc/includes/general.php';
global $abs_us_root, $us_url_root;
global $PERMISSION, $UPLOADS, $seasonsArray;

require_once $abs_us_root . $us_url_root . 'users/includes/header.php';

// This should be set before including navigation
$queryParameter = "player=" . (string)Input::get('player');

require_once $abs_us_root . $us_url_root . 'users/includes/navigation.php';

require_once $abs_us_root . $us_url_root . 'usersc/classes/PlayerStats.php';
require_once $abs_us_root . $us_url_root . 'usersc/classes/Player.php';

if (!securePage($_SERVER['PHP_SELF'])) die();

//Check if user has the required permission
if ($user->isLoggedIn())
{
    $thisUserID = $user->data()->id;
    $data = $user->data();
    $permission = (checkMenu($PERMISSION['administrator'], $user->data()->id));

} else {
    $permission = false;
}

$player = Input::get('player');
$history = $player ? PlayerStats::getSeasonElo($season,$player) : null;

?>

<div id="page-wrapper">
    <div class="container">

        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading"><strong>ELO History</strong></div>
                    <div class="panel-body">
                        This a report for a browse the ELO's changes in the season <span class="strong"><?= $seasonsArray[$season]['reference'] ?></span> for the player
                        <span class="strong"><?= Player::getNameByID($player); ?></span> <?= printID($player); ?>.
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 beforeLoad">
                <div class="table-responsive well center">
                    <h2>... LOADING ...</h2>
                </div>
            </div>
            <?php if (!count($history)) { ?>
                <?php include($abs_us_root . $us_url_root . 'usersc/includes/no_results.php'); ?>
            <?php } else { ?>
            <div class="col-md-12 afterLoad">
                <div class="well table-responsive">
                    <div class="pager">
                        <form>
                            <i class="fa icon pager-action fa-step-backward first"></i>
                            <i class="fa icon pager-action fa-backward prev"></i>
                            <!-- the "pagedisplay" can be any element, including an input -->
                            <span class="pagedisplay" data-pager-output-filtered="{startRow:input} &ndash; {endRow} / {filteredRows} of {totalRows} total rows"></span>
                            <i class="fa icon pager-action fa-forward next"></i>
                            <i class="fa icon pager-action fa-step-forward last"></i>
                            <select class="pagesize">
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                                <option value="all">All Rows</option>
                            </select>
                        </form>
                    </div>
                    <table id="player_elo" class="tablesorter">
                        <thead>
                        <tr>
                            <th class="fit-70 center">Order</th>
                            <th class="fit-110">Date</th>
                            <th>Opponent</th>
                            <th class="fit-90 center">Result</th>
                            <th class="fit-110 center">Opponent's ELO</th>
                            <th class="fit-110 center">Player's ELO</th>
                            <th class="fit-110 center">ELO Change</th>
                            <th class="fit-110 center">Player's new ELO</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php
                        $count = 0;
                        foreach ($history as $row) { $count++; ?>
                            <tr>
                                <td class="fit-70 center"><?= $count; ?></td>
                                <td class="fit-110 no-wrap"><?= $row['date']; ?></td>
                                <td class="fit-240">
                                    <span class="strong"><?= Player::getNameByID($row['opponent']); ?></span> <?= printID($row['opponent']) ?> <?= Player::getNickByID($row['opponent']) ? '(' . Player::getNickByID($row['opponent']) . ')' : "" ; ?>
                                </td>
                                <td class="fit-90 center">
                                    <?php
                                    if ($row['winner'] == $row['opponent'])
                                    {
                                        echo 'Loss';
                                    } elseif ($row['winner'] == $player) {
                                        echo 'Win';
                                    } else {
                                        echo 'Draw';
                                    }
                                    ?>
                                </td>
                                <td class="fit-90 center"><?= round($row['oldOpELO'], $PRECISION);?></td>
                                <td class="fit-90 center"><?= round($row['oldELO'], $PRECISION); ?></td>
                                <td class="fit-90 center strong <?= $row['ELOChange'] > 0 ? 'ELOgreen' : 'ELOred' ?>"><?=$row['ELOChange'] > 0 ? '+' : '' ?><?= round($row['ELOChange'], $PRECISION); ?></td>
                                <td class="fit-90 center"><?= round($row['newELO'], $PRECISION); ?></td>
                        <?php } ?>
                        </tbody>
                    </table>
                    <div class="pager">
                        <form>
                            <i class="fa icon pager-action fa-step-backward first"></i>
                            <i class="fa icon pager-action fa-backward prev"></i>
                            <!-- the "pagedisplay" can be any element, including an input -->
                            <span class="pagedisplay" data-pager-output-filtered="{startRow:input} &ndash; {endRow} / {filteredRows} of {totalRows} total rows"></span>
                            <i class="fa icon pager-action fa-forward next"></i>
                            <i class="fa icon pager-action fa-step-forward last"></i>
                            <select class="pagesize">
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                                <option value="all">All Rows</option>
                            </select>
                        </form>
                    </div>
                </div>
            </div><!-- /.col -->
            <?php } ?>
        </div><!-- /.row -->
    </div> <!-- /.container -->
</div> <!-- /.wrapper -->

    <!-- footers -->
<?php require_once $abs_us_root . $us_url_root . 'users/includes/page_footer.php'; // the final html footer copyright row + the external js calls ?>

<script type="text/javascript" src="usersc/js/3rd/jquery.tablesorter.min.js"></script>
<script type="text/javascript" src="usersc/js/3rd/jquery.tablesorter.widgets.js"></script>
<script type="text/javascript" src="usersc/js/3rd/widget-pager.js"></script>
<script type="text/javascript" src="usersc/js/3rd/jquery.redirect.js"></script>
<script type="text/javascript" src="usersc/js/player_elo.js"></script>

<?php require_once $abs_us_root . $us_url_root . 'users/includes/html_footer.php'; // currently just the closing /body and /html ?>