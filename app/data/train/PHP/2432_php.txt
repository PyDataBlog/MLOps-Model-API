<?php
header("Access-Control-Allow-Origin:*");
?>
<html>
    <head>
        <title>TESTS AJAX</title>
        <style type="text/css">
		.bouton,.obj_prec{
			margin-left:4px;
			color:blue;
			font-size:14px;
			font-weight:bold;
			cursor:pointer;
		}
		.bouton:hover{
			color:#ccc;
		}
		#log{
			border:1px solid red;
			background-color:pink;
		}
		</style>
        <script src="http://code.jquery.com/jquery.js"></script>
        <script>
            function recreer_liste(){
                $( "p#result" ).hide( 200, function() {
                    $( "p#result" ).html('');
                    afficher();
                 });
            }
            function afficher(){
                $.ajax({
                   type:"GET",
                   url:"http://sfrest.local/app_dev.php/notes.json",
                   contentType:"text/plain",
                   dataType:"json",
                   cache:false,
                   data:{limit:$("#nb_mess").val()},
                   success:function(data,status,jqXHR){
                       showData2(data);
                    },
                    error: function (jqXHR,status) {
                        messager(status,'Affichage Erreur');
                    }
                 });                
            }
            
            function showData2(data){ // de benjamin
                messager(data,'Affichage OK');
                $("p#result").append($("<ul>"));
                $.each(data.notes,function(i,item){
                   $("p#result ul").append($('<li>'+item.message+' ('+i+')<span num="'+i+'" class="bouton item">Supprimer</span></li>'));
                });
                $("p#result").show(400);
                $(".item").click(function() {
                    //alert($(this).attr('num'));
                    remover($(this).attr('num'));
                });
            }
            
            function remover(n){
                $.ajax({
                   type:"GET",
                   url:'http://sfrest.local/app_dev.php/notes/'+n+'/remove',
                   contentType:"text/plain",
                   dataType:"json",
                   data:{id:n},
                   success:function(result){
                       messager(result,'Suppr OK');
                    },
                    error: function (jqXHR,status) {
                        messager(status + JSON.stringify(jqXHR),'Suppr Erreur');
                    }
                 }); 
                 recreer_liste();
                 //setTimeout(recreer_liste,2000);
            }
			
            function ajouter(m){
                $.ajax({
                  type: "POST",
                    url: "http://sfrest.local/app_dev.php/notes.json",
                    data: {'note[message]':m},
                    dataType: "json",
                   success:function(result,status,jqXHR){
                       messager(result,'Ajout OK');
					   messager(jqXHR,'Ajout OK');
                     },
                    error: function (jqXHR,status) {
                        messager(status + JSON.stringify(jqXHR),'Ajout Erreur');
                    }
                }); 
                recreer_liste();
            }
			
			function messager(mess,quoi){
				if(typeof(mess)=='object'){
					mess = JSON.stringify(mess);
					c = '<div class="obj_prec">Objet</div>';
					c += '<div style="display:none">'+mess+'</div>';
					$("#log").html(c + $("#log").html());
				}else{
					$("#log").html(mess+'<br>'+$("#log").html());
				}
				d = new Date();
				dts = d.getHours()+':'+d.getMinutes()+':'+d.getSeconds();
				$("#log").html('['+dts+'] '+$("#log").html());
				if(quoi!=undefined){
					$("#log").html(quoi+' : '+$("#log").html());
				}
				$(".obj_prec").click(function() {
                    $(this).next().toggle();
                });
			}
			
            $(document).ready(function(){
                $("#envoie").click(function() {
                    ajouter($("#message").val());
                });
				$("#rafraichir").click(function() {
                    recreer_liste();
                });
                afficher();
            });
        </script>
     </head>
    <body>
        <div id="menus">
			Afficher : <input type="text" id="nb_mess" value="10" style="width:30px;"> <span id="rafraichir" class="bouton">Rafraichir</span>
            <br><br><input type="text" id="message"> <span id="envoie" class="bouton">Ajouter</span>
        </div>
        <div id="conteneur" style="min-height:400px;">
        <p id="result"></p>
        </div>
		<div id="log">
		</div>
    </body>       
<?php

/* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

