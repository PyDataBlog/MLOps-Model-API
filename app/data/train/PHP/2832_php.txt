<?php
// Newfoundland Genetics Project
// https://github.com/opyum/nlgp
// Admin Functions
// "admin.php"

// Get config and start session
require 'inc/config.php';
session_start();
$uid = $_SESSION['UserID'];

if (isset($_SESSION['UserLoggedIn']) && ($_SESSION['UserLevel'] == 2)) {

    // Print Token
    if (isset($_GET['print_token_sheet'])) {
        $sql = "SELECT * FROM `reg_token` ORDER BY `id` DESC LIMIT 1";
        $result = mysqli_query($conn, $sql);
        $row = mysqli_fetch_array($result);
        $token = $row['token'];
        $issued = $row['added'];
        $issued = strtotime($issued);
        $issued = date('d M Y', $issued);
?>
        <style>
            /* unvisited link */
            a:link {
                color: blue;
            }

            /* visited link */
            a:visited {
                color: blue;
            }

            /* mouse over link */
            a:hover {
                color: blue;
            }

            /* selected link */
            a:active {
                color: blue;
            }
        </style>
        <h1 align="center">Newfoundland Genetics Project<br><a href="//www.nlgp.ca">www.nlgp.ca</a></h1>
        <h2 align="center">This token issued <?php echo $issued; ?></h2>
        <p align="center">
            Notice: The Registration Token is updated on an ongoing basis. Please make sure you are using the most recent. If you are receiving errors when using your token, please check this document again.
        </p>
        <br><br>
        <h2 align="center">Registration Token:</h2>
        <h3 align="center"><?php echo $token; ?></h3>
        <br><br>
        <h2 align="center">Direct Link:</h2>
        <h3 align="center"><a href="//www.nlgp.ca/register?token=<?php echo $token; ?>">https://www.nlgp.ca/register?token=<?php echo $token; ?></a></h3>

<?php
        die();
    }

    // Get header
    $site_title = "Site Administration Tools | $site_tag";
    include (APP_INCLUDES_PATH . 'header.php');

    // Registration Tokens
    if (isset($_GET['reg_tokens']) && ($_SESSION['UserLevel'] == 2 OR $_SESSION['UserLevel'] == 3)) {
        if (isset($_GET['generate'])) {

            if (isset($_GET['do'])) {

                include (APP_FUNCTIONS_PATH . 'pwgen.php');
                function token($length){
                    $str = "";
                    $characters = array_merge(range('A','Z'), range('a','z'), range('0','9'));
                    $max = count($characters) - 1;
                    for ($i = 0; $i < $length; $i++) {
                        $rand = mt_rand(0, $max);
                        $str .= $characters[$rand];
                    }
                    return $str;
                }
                $token = token(15);

                $sql = "INSERT INTO `reg_token` (`token`) VALUES ('$token')";
                $result = mysqli_query($conn, $sql);

                if (!$result) {
                    error_log("Connection failed: " . mysqli_error($conn));
                }

                // If the insert Query was successful.
                if (mysqli_affected_rows($conn) == 1) {
                    $_SESSION['messages'] = '<div class="alert alert-success"><a href="#" class="close" data-dismiss="alert">&times;</a>New Token Generated Successfully!</div>';
                    header('Location: /admin?reg_tokens&view');
                }

                else {
                    $_SESSION['messages'] = '<div class="alert alert-danger"><a href="#" class="close" data-dismiss="alert">&times;</a>Token Generation Failed!</div>';
                    header('Location: /');
                }

            }
            ?>
            <div class="container">
                <div class="row">
                    <div class="col-sm-12 margin-top-25">
                        <div class="alert alert-info"><strong>Are you sure you want to generate a new token?</strong></div>
                    </div>
                    <button type="button" id="do" class="btn btn-primary center-block" onclick="location.href = '/admin?reg_tokens&generate&do';">Create New</button>
                </div>
            </div>

            <?php
        }

        else if (isset($_GET['view'])) {

            $sql = "SELECT `token` FROM `reg_token` ORDER BY `id` DESC LIMIT 1";
            $result = mysqli_query($conn, $sql);
            $row = mysqli_fetch_array($result);
            $token = $row['token'];
?>
            <div class="container">
                <h1 class="page-header">Registration Token Management</h1>
                    <h2>Token:</h2>
                        <p><strong><?php echo $token; ?></strong></p>
                    <button type="button" id="do" class="btn btn-primary" onclick="window.open('/admin?print_token_sheet', '_blank');">Print Token Sheet</button>
            </div>
<?php
        }

        else {
            header('Location: /admin?reg_tokens&view');
        }
    }

    else if (isset($_GET['manage']) && ($_SESSION['UserLevel'] == 2 OR $_SESSION['UserLevel'] == 3)) {

        if (isset($_GET['members'])) {

            $sql = "SELECT COUNT(*) as num FROM `members`";
            $total_pages = mysqli_fetch_array(mysqli_query($conn, $sql));
            $total_pages = $total_pages['num'];

            /* Setup vars for query. */

            $page_var = 'page';
            $limit = 10;

            if (isset($_GET[$page_var])) {
                $page = $_GET[$page_var];
            } else {
                $page = 1;
            }

            $start = ($page - 1) * $limit;

            /* Get data. */

            $sql = "SELECT * FROM `members` ORDER BY `id` DESC LIMIT $start, $limit";

            $result = mysqli_query($conn, $sql);

            /* Setup page vars for display. */
            $prev = $page - 1;
            $next = $page + 1;
            $lastpage = ceil($total_pages / $limit);
            $lpm1 = $lastpage - 1;
            $adjacents = 3;
            $targetpage = "/admin?manage&members";

            $pagination = "";
            if ($lastpage > 1) {
                $pagination .= "<div class=\"row\"><div class=\"col-lg-12 text-center\"><ul class=\"pagination\">";
                //previous button
                if ($page > 1) {
                    $pagination .= "<li><a href=\"$targetpage&$page_var=$prev\"><i class=\"fa fa-caret-square-o-left\"></i> Previous</a></li>";
                } else {
                    $pagination .= "<li class=\"disabled\"><a href=\"#\"><i class=\"fa fa-caret-square-o-left\"></i> Previous</a></li>";
                }
                //pages
                if ($lastpage < 7 + ($adjacents * 2)) {
                    for ($counter = 1; $counter <= $lastpage; $counter++) {
                        if ($counter == $page) {
                            $pagination .= "<li class=\"active\"><a href=\"#\">$counter</a></li>";
                        } else {
                            $pagination .= "<li><a href=\"$targetpage&$page_var=$counter\">$counter</a></li>";
                        }
                    }
                } elseif ($lastpage > 5 + ($adjacents * 2)) {
                    //close to beginning; only hide later pages
                    if ($page < 1 + ($adjacents * 2)) {
                        for ($counter = 1; $counter < 4 + ($adjacents * 2); $counter++) {
                            if ($counter == $page) {
                                $pagination .= "<li class=\"active\"><a href=\"#\">$counter</a></li>";
                            } else {
                                $pagination .= "<li><a href=\"$targetpage&$page_var=$counter\">$counter</a></li>";
                            }
                        }
                        $pagination .= "<li class=\"disabled\"><a href=\#\>...</a></li>";
                        $pagination .= "<li><a href=\"$targetpage&$page_var=$lpm1\">$lpm1</a></li>";
                        $pagination .= "<li><a href=\"$targetpage&$page_var=$lastpage\">$lastpage</a></li>";
                    } //in middle; hide some front and some back
                    elseif ($lastpage - ($adjacents * 2) > $page && $page > ($adjacents * 2)) {
                        $pagination .= "<li><a href=\"$targetpage&$page_var=1\">1</a></li>";
                        $pagination .= "<li><a href=\"$targetpage&$page_var=2\">2</a></li>";
                        $pagination .= "<li class=\"disabled\"><a href=\#\>...</a></li>";
                        for ($counter = $page - $adjacents; $counter <= $page + $adjacents; $counter++) {
                            if ($counter == $page) {
                                $pagination .= "<li class=\"active\"><a href=\"#\">$counter</a></li>";
                            } else {
                                $pagination .= "<li><a href=\"$targetpage&$page_var=$counter\">$counter</a></li>";
                            }
                        }
                        $pagination .= "<li class=\"disabled\"><a href=\#\>...</a></li>";
                        $pagination .= "<li><a href=\"$targetpage&$page_var=$lpm1\">$lpm1</a></li>";
                        $pagination .= "<li><a href=\"$targetpage&$page_var=$lastpage\">$lastpage</a></li>";
                    } //close to end; only hide early pages
                    else {
                        $pagination .= "<li><a href=\"$targetpage&$page_var=1\">1</a></li>";
                        $pagination .= "<li><a href=\"$targetpage&$page_var=2\">2</a></li>";
                        $pagination .= "<li class=\"disabled\"><a href=\#\>...</a></li>";
                        for ($counter = $lastpage - (2 + ($adjacents * 2)); $counter <= $lastpage; $counter++) {
                            if ($counter == $page) {
                                $pagination .= "<li class=\"active\"><a href=\"#\">$counter</a></li>";
                            } else {
                                $pagination .= "<li><a href=\"$targetpage&$page_var=$counter\">$counter</a></li>";
                            }
                        }
                    }
                }

                //next button
                if ($page < $counter - 1) {
                    $pagination .= "<li><a href=\"$targetpage&$page_var=$next\">Next <i class=\"fa fa-caret-square-o-right\"></i></a></li>";
                } else {
                    $pagination .= "<li class=\"disabled\"><a href=\"#\">Next <i class=\"fa fa-caret-square-o-right\"></i></a></li>";
                    $pagination .= "</ul></div></div>\n";
                }
            }
?>
            <div class="container">
                <div class="row">
                    <h1 class="page-header">Manage Members (<?php echo $total_pages; ?>)</h1>
                    <div class="col-lg-12">
                        <div id="members" class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th>Full Name</th>
                                    <th>City</th>
                                    <th>Province</th>
                                    <th>Country</th>
                                    <th>Email</th>
                                    <th>Joined</th>
                                    <th>Last Login</th>
                                    <th>Last Update</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
<?php
                                while ($row = mysqli_fetch_array($result)) {
?>
                                    <tr>
                                        <td><?php echo $row['gname'], ' ', $row['fname']; ?></td>
                                        <td><?php echo $row['city']; ?></td>
                                        <td><?php echo $row['province']; ?></td>
                                        <td><?php echo $row['country']; ?></td>
                                        <td><?php echo '<a href="mailto:', $row['email'], '">', $row['email'], '</a>'; ?></td>
                                        <td><?php echo $row['joined']; ?></td>
                                        <td><?php echo $row['last_login']; ?></td>
                                        <td><?php echo $row['last_updated']; ?></td>
                                        <td>
                                            <div class="btn-group btn-group-xs">
                                                <button type="button" id="do" class="btn btn-default" onclick="location.href = '/admin?masq_user&uid=<?php echo $row['id']; ?>';"><i class="fa fa fa-edit"></i> Masq.</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <?php
                                }
                                ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <?= $pagination ?>
                </div>
            </div>
<?php
        }

        if (isset($_GET['kits'])) {

            $sql = "SELECT COUNT(*) as num FROM `kits`";
            $total_pages = mysqli_fetch_array(mysqli_query($conn, $sql));
            $total_pages = $total_pages['num'];

            /* Setup vars for query. */

            $page_var = 'page';
            $limit = 10;

            if (isset($_GET[$page_var])) {
                $page = $_GET[$page_var];
            } else {
                $page = 1;
            }

            $start = ($page - 1) * $limit;

            /* Get data. */

            $sql = "SELECT * FROM `kits` ORDER BY `id` ASC LIMIT $start, $limit";

            $result = mysqli_query($conn, $sql);

            /* Setup page vars for display. */
            $prev = $page - 1;
            $next = $page + 1;
            $lastpage = ceil($total_pages / $limit);
            $lpm1 = $lastpage - 1;
            $adjacents = 3;
            $targetpage = "/admin?manage&kits";

            $pagination = "";
            if ($lastpage > 1) {
                $pagination .= "<div class=\"row\"><div class=\"col-lg-12 text-center\"><ul class=\"pagination\">";
                //previous button
                if ($page > 1) {
                    $pagination .= "<li><a href=\"$targetpage&$page_var=$prev\"><i class=\"fa fa-caret-square-o-left\"></i> Previous</a></li>";
                } else {
                    $pagination .= "<li class=\"disabled\"><a href=\"#\"><i class=\"fa fa-caret-square-o-left\"></i> Previous</a></li>";
                }
                //pages
                if ($lastpage < 7 + ($adjacents * 2)) {
                    for ($counter = 1; $counter <= $lastpage; $counter++) {
                        if ($counter == $page) {
                            $pagination .= "<li class=\"active\"><a href=\"#\">$counter</a></li>";
                        } else {
                            $pagination .= "<li><a href=\"$targetpage&$page_var=$counter\">$counter</a></li>";
                        }
                    }
                } elseif ($lastpage > 5 + ($adjacents * 2)) {
                    //close to beginning; only hide later pages
                    if ($page < 1 + ($adjacents * 2)) {
                        for ($counter = 1; $counter < 4 + ($adjacents * 2); $counter++) {
                            if ($counter == $page) {
                                $pagination .= "<li class=\"active\"><a href=\"#\">$counter</a></li>";
                            } else {
                                $pagination .= "<li><a href=\"$targetpage&$page_var=$counter\">$counter</a></li>";
                            }
                        }
                        $pagination .= "<li class=\"disabled\"><a href=\#\>...</a></li>";
                        $pagination .= "<li><a href=\"$targetpage&$page_var=$lpm1\">$lpm1</a></li>";
                        $pagination .= "<li><a href=\"$targetpage&$page_var=$lastpage\">$lastpage</a></li>";
                    } //in middle; hide some front and some back
                    elseif ($lastpage - ($adjacents * 2) > $page && $page > ($adjacents * 2)) {
                        $pagination .= "<li><a href=\"$targetpage&$page_var=1\">1</a></li>";
                        $pagination .= "<li><a href=\"$targetpage&$page_var=2\">2</a></li>";
                        $pagination .= "<li class=\"disabled\"><a href=\#\>...</a></li>";
                        for ($counter = $page - $adjacents; $counter <= $page + $adjacents; $counter++) {
                            if ($counter == $page) {
                                $pagination .= "<li class=\"active\"><a href=\"#\">$counter</a></li>";
                            } else {
                                $pagination .= "<li><a href=\"$targetpage&$page_var=$counter\">$counter</a></li>";
                            }
                        }
                        $pagination .= "<li class=\"disabled\"><a href=\#\>...</a></li>";
                        $pagination .= "<li><a href=\"$targetpage&$page_var=$lpm1\">$lpm1</a></li>";
                        $pagination .= "<li><a href=\"$targetpage&$page_var=$lastpage\">$lastpage</a></li>";
                    } //close to end; only hide early pages
                    else {
                        $pagination .= "<li><a href=\"$targetpage&$page_var=1\">1</a></li>";
                        $pagination .= "<li><a href=\"$targetpage&$page_var=2\">2</a></li>";
                        $pagination .= "<li class=\"disabled\"><a href=\#\>...</a></li>";
                        for ($counter = $lastpage - (2 + ($adjacents * 2)); $counter <= $lastpage; $counter++) {
                            if ($counter == $page) {
                                $pagination .= "<li class=\"active\"><a href=\"#\">$counter</a></li>";
                            } else {
                                $pagination .= "<li><a href=\"$targetpage&$page_var=$counter\">$counter</a></li>";
                            }
                        }
                    }
                }

                //next button
                if ($page < $counter - 1) {
                    $pagination .= "<li><a href=\"$targetpage&$page_var=$next\">Next <i class=\"fa fa-caret-square-o-right\"></i></a></li>";
                } else {
                    $pagination .= "<li class=\"disabled\"><a href=\"#\">Next <i class=\"fa fa-caret-square-o-right\"></i></a></li>";
                    $pagination .= "</ul></div></div>\n";
                }
            }
            ?>
            <div class="container">
                <div class="row">
                    <h1 class="page-header">Manage Kits (<?php echo $total_pages; ?>)</h1>
                    <div class="col-lg-12">
                        <div id="kits" class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th>Kit ID</th>
                                    <th>Owned By</th>
                                    <th>Full Name</th>
                                    <th>Gender</th>
                                    <th>Birth</th>
                                    <th>Death</th>
                                    <th>MKit</th>
                                    <th>FKit</th>
                                    <th>mtDNA</th>
                                    <th>Y-DNA</th>
                                    <th>Added</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                <?php
                                while ($row = mysqli_fetch_array($result)) {
                                    $user = $row['uid'];
                                    $sql2 = "SELECT * FROM `members` WHERE `id`='$user'";
                                    $result2 = mysqli_query($conn, $sql2);
                                    $row2 = mysqli_fetch_array($result2);

                                    ?>
                                    <tr>
                                        <td><?php echo '<a href="/kit?view&kit=', $row['kit'], '">', $row['kit'], '</a>'; ?></td>
                                        <td><?php echo '<a href="mailto:', $row2['email'], '">', $row2['gname'], ' ', $row2['fname'], '</a>'; ?></td>
                                        <td><?php echo $row['gname'], ' ', $row['fname']; ?></td>
                                        <td><?php echo $row['gender']; ?></td>
                                        <td><?php echo $row['bday']; ?></td>
                                        <td><?php echo $row['dday']; ?></td>
                                        <td><?php echo '<a href="/kit?view&kit=', $row['mkit'], '">', $row['mkit'], '</a>'; ?></td>
                                        <td><?php echo '<a href="/kit?view&kit=', $row['fkit'], '">', $row['fkit'], '</a>'; ?></td>
                                        <td><?php echo $row['mtdna']; ?></td>
                                        <td><?php echo $row['ydna']; ?></td>
                                        <td><?php echo $row['added']; ?></td>
                                        <td>
                                            <div class="btn-group btn-group-xs">
                                                <button type="button" id="do" class="btn btn-default" onclick="location.href = '/kit?edit&kit=<?php echo $row['kit']; ?>';"><i class="fa fa fa-edit"></i> Edit</button><button type="button" id="do" class="btn btn-default" onclick="location.href = '/admin?masq_user&uid=<?php echo $row['uid']; ?>';"><i class="fa fa fa-edit"></i> Masq.</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <?php
                                }
                                ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <?= $pagination ?>
                </div>
            </div>
            <?php
        }

    }

    else if (isset($_GET['masq_user']) && ($_SESSION['UserLevel'] == 2 OR $_SESSION['UserLevel'] == 3)) {

        if (isset($_GET['uid'])) {
            $uid = mysqli_real_escape_string($conn, filter_input(INPUT_GET, 'uid', FILTER_SANITIZE_STRING));

            $sql = "SELECT * FROM `members` WHERE `id`= '$uid'";
            $result = mysqli_query($conn, $sql);
            $row = mysqli_fetch_array($result, MYSQLI_ASSOC);

            if (!isset($_SESSION['ActualUserID'])) {
                $_SESSION['ActualUserID'] = $_SESSION['UserID'];
            }

            $_SESSION['UserID'] = $uid;
            $_SESSION['MemberName'] = $row['gname'] . ' ' . $row['fname'];
            $_SESSION['Email'] = $row['email'];
        }

        else if (isset($_GET['reset'])) {

            $uid = $_SESSION['ActualUserID'];

            $sql = "SELECT * FROM `members` WHERE `id`= '$uid'";
            $result = mysqli_query($conn, $sql);
            $row = mysqli_fetch_array($result, MYSQLI_ASSOC);

            $_SESSION['UserID'] = $uid;
            $_SESSION['MemberName'] = $row['gname'] . ' ' . $row['fname'];
            $_SESSION['Email'] = $row['email'];
            unset($_SESSION['ActualUserID']);
        }
        header('Location: /');
    }

    else {
        header('Location: /');
    }
// Get app footer
include (APP_INCLUDES_PATH . 'footer.php');
}

// Not Admin
else {
    header('Location: /');
}
