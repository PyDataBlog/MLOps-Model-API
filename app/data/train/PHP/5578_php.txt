<?php
/**
 * @version		1.7.0 formscrm $
 * @package		formscrm
 * @copyright	Copyright Â© 2010 - All rights reserved.
 * @license		GNU/GPL
 * @author		serrbiz
 * @author mail	nobody@nobody.com
 *
 *
 * @MVC architecture generated by MVC generator tool at http://www.alphaplug.com
 */

// no direct access
defined('_JEXEC') or die('Restricted access');
jimport('joomla.application.component.modellist');
// Your custom code here
	global $mainframe;
	require_once(JPATH_ADMINISTRATOR.'/components/com_formscrm/helpers/helper.php');
	require_once(JPATH_ADMINISTRATOR.'/components/com_formscrm/helpers/reusefunction.class.php');
  	$reusefunction=new reusefunction();
	$leadInfos=$this->leadInfos;
	$user=$this->user;
	$allCampaignInfo = sbfAdmin::getAllCampaign(-1,'dropdown');
	$obj= array();   //Modified By Sapna Talreja On 29th feb 2008 frm $obj= "new" to $obj=array
	$allCampaignInfo = sbfAdmin::insertInArray($allCampaignInfo,1,$obj);
	$allCampaignInfo1[0] = new stdClass();
	$allCampaignInfo1[0]->value = "-1";
	$allCampaignInfo1[0]->text = "All";
	$allCampaignInfo=array_merge($allCampaignInfo1,$allCampaignInfo);
	//For 1.7
	/*$search_word = $mainframe->getUserStateFromRequest( "search_word", 'search_word', '' );
	$select_campaign = intval( $mainframe->getUserStateFromRequest( "select_campaign", 'select_campaign', -1 ) );
	$created_date = $mainframe->getUserStateFromRequest( "created_date", "created_date", 'All') ;
	$end_date = $mainframe->getUserStateFromRequest( "end_date", 'end_date', 'All' );
	$hideclosed = $mainframe->getUserStateFromRequest( "hideclosed", 'hideclosed', '' );*/
	//For 1.7
	$search_word = JModelList::getUserStateFromRequest( "search_word", 'search_word', '' );
	$select_campaign = intval( JModelList::getUserStateFromRequest( "select_campaign", 'select_campaign', -1 ) );
	$created_date = JModelList::getUserStateFromRequest( "created_date", "created_date", 'All') ;
	$end_date = JModelList::getUserStateFromRequest( "end_date", 'end_date', 'All' );
	$hideclosed = JModelList::getUserStateFromRequest( "hideclosed", 'hideclosed', '' );
	//
	$select_gids=$confdata[0]->gid;
	$select_gid = explode( ',', $select_gids );
	
	$created_date = JModelList::getUserStateFromRequest( "created_date", "created_date", 'All') ;
	$end_date = JModelList::getUserStateFromRequest( "end_date", 'end_date', 'All' );
    ?>
	<link href="<?php echo JURI::root();?>components/com_formscrm/assets/css/serrbiz.css" rel="stylesheet" type="text/css"  id="css"/>
	<style type="text/css">
	input, select {
	border:1px solid silver;
	font-size:10px;
	}
	</style>
	<script type="text/javascript">
	function fun_submitform()
	{
		var frm=document.adminForm;
		frm.option.value='com_formscrm';
		frm.submit();
	}
	//
	function tableOrdering(name,order)
	{
		var frm=document.adminForm;
		frm.option.value='com_formscrm';
		frm.name.value=name;
		frm.order.value=order;
		frm.submit();
		//location.href = 'index.php?option=com_formscrm&task=view&name='+name+'&order='+order;
	}
	//
	function fun_hideclosed(val)
	{
		var frm=document.adminForm;
		frm.hideclosed.value=val;
		frm.submit();
	}
	</script>
	<div id="serrbiz-formslt">
	<form name="adminForm" action="index.php?option=com_formscrm&view=formscrm" method="post" enctype="multipart/form-data">
	<input type="hidden" name="option" value="com_formscrm">
	<input type="hidden" name="task" value="<?php echo $_REQUEST['task'];?>">
	<input type="hidden" name="Itemid" value="<?php echo $_REQUEST['Itemid'];?>">

	<input type="hidden" name="name" value="" />
	<input type="hidden" name="order" value="" />
	<table width="100%" border="0" cellspacing="3" cellpadding="1" class="search-block">
	  <tr>
		<td nowrap="nowrap">Search Word</td>
		<td align="left"><input type="text" name="search_word" size="20" value="<?php echo $search_word;?>"/></td>
		<td>Select Form</td>
		<td align="left"><?php //echo mosHTML::selectList($allCampaignInfo, 'select_campaign', 'class="inputbox"  onChange="document.adminForm.submit();" ', 'value', 'text', $select_campaign);
		 echo JHTML::_('select.genericlist', $allCampaignInfo, 'select_campaign', 'size="1" class="inputbox" onChange="document.adminForm.submit()"', 'value', 'text', $select_campaign); ?></td>
		
	  </tr>
	  <tr>
		<td>Start Date</td>
								  <td>
								<?php
								if($_REQUEST["created"]){
									$start_date = $_REQUEST["created"];
								} else {
									$start_date = $created_date;
								}
							?>
						  <?php //	echo JHTML::_('calendar',$created_date, 'created_date', 'created_date', '%Y-%m-%d', array('class'=>'inputbox', 'size'=>'18',  'maxlength'=>'19',"readonly" => "readonly")); 
						  echo JHTML::calendar( $created_date, "created_date", "created_date", "%Y-%m-%d", "readonly=\"readonly\" size=\"16\" maxlength=\"10\" " );//For J1.7?>
								  </td>
								  <td>End Date</td>
								  
								  <td >
								   <?php
								if($_REQUEST["end_date"]){
									$end_date = $_REQUEST["end_date"];
								} else {
									$end_date = $end_date;
								}
							?>
						  <?php //echo JHTML::_('calendar',$end_date, 'end_date', 'end_date', '%Y-%m-%d', array('class'=>'inputbox', 'size'=>'18',  'maxlength'=>'19' ,"readonly" => "readonly"));
						  echo JHTML::calendar( $end_date, "end_date", "end_date", "%Y-%m-%d", "readonly=\"readonly\" size=\"16\" maxlength=\"10\" " );//For J1.7 ?></td>
		
		
	  </tr>
	  <tr>
		<td>Number of leads per page</td>
		 <td><?php //echo $pagination->getLimitBox(); ?> <?php if(count($leadInfos) > 0) echo $this->pagination->getLimitBox(); else {?>
		 <select name="s2" >
		 	<option value="5">5</option>
			<option value="10">10</option>
			<option value="15">15</option>
			<option value="20" selected="selected">20</option>
			<option value="25">25</option>
			<option value="30">30</option>
			<option value="50">50</option>
			<option value="100">100</option>
			<option value="ALL">ALL</option>
		 
		 </select> <?php } ?> </td>
		 <td>Hide Closed:</td><td>
							 <select name="hideclosed" id="hideclosed" class="inputbox" onChange="fun_hideclosed(this.value);"  style="width:95px;">
									  <option  value="1" <?php if($_REQUEST['hideclosed'] == 1) { ?> selected="selected" <?php }?> >Yes</option>
									 <option  value="2" <?php if($_REQUEST['hideclosed'] == 2 || $_REQUEST['hideclosed'] == '') { ?> selected="selected" <?php } ?> >No</option>
									  <option  value="3"<?php if($_REQUEST['hideclosed'] == 3) { ?> selected="selected" <?php }?> >Show only closed.</option>
									</select>
		
		
	  </tr>
	  <tr><td colspan="4" align="right"><input type="button" value="Search" name="searchform" onclick="javascript:fun_submitform()"></td></tr>
	  
	</table>
	
		<table cellspacing=2 cellpadding=2 border="0" class="listing-block">
		
		<tr>
			<?php if(in_array($user->id,$select_gid)) { ?><td width="10%"><?php if($_REQUEST['order']=='DESC') {?><a href="javascript:tableOrdering('campaign_name','ASC');" style="text-decoration:none" title="Click to sort by this column"><strong>Form </strong>&nbsp;<img alt="" src="media/system/images/sort_desc.png"></a><?php }  else {?><a href="javascript:tableOrdering('campaign_name','DESC');" style="text-decoration:none" title="Click to sort by this column"><strong>Form </strong>&nbsp;<img alt="" src="media/system/images/sort_asc.png"></a><?php } ?></td><?php } ?>
		<!--<td width="10%" ><strong>TC</strong></td>  -->
			<td width="15%"><?php if($_REQUEST['order']=='DESC') {?><a href="javascript:tableOrdering('name','ASC');" style="text-decoration:none" title="Click to sort by this column"><strong>First Name</strong>&nbsp;<img alt="" src="media/system/images/sort_desc.png"></a><?php }  else {?><a href="javascript:tableOrdering('name','DESC');" style="text-decoration:none" title="Click to sort by this column"><strong>First Name</strong>&nbsp;<img alt="" src="media/system/images/sort_asc.png"></a><?php } ?></td>
			<td width="10%"><?php if($_REQUEST['order']=='DESC') {?><a href="javascript:tableOrdering('lastname','ASC');" style="text-decoration:none" title="Click to sort by this column"><strong>Last Name</strong>&nbsp;<img alt="" src="media/system/images/sort_desc.png"></a><?php }  else {?><a href="javascript:tableOrdering('lastname','DESC');" style="text-decoration:none" title="Click to sort by this column"><strong>Last Name</strong>&nbsp;<img alt="" src="media/system/images/sort_asc.png"></a><?php } ?></td>
			<td width="10%"><?php if($_REQUEST['order']=='DESC') {?><a href="javascript:tableOrdering('date_added','ASC');" style="text-decoration:none" title="Click to sort by this column"><strong>Date Added</strong>&nbsp;<img alt="" src="media/system/images/sort_desc.png"></a><?php }  else {?><a href="javascript:tableOrdering('date_added','DESC');" style="text-decoration:none" title="Click to sort by this column"><strong>Date Added</strong>&nbsp;<img alt="" src="media/system/images/sort_asc.png"></a><?php } ?></td>
			<td width="10%"><?php if($_REQUEST['order']=='DESC') {?><a href="javascript:tableOrdering('status','ASC');" style="text-decoration:none" title="Click to sort by this column"><strong>Status</strong>&nbsp;<img alt="" src="media/system/images/sort_desc.png"></a><?php }  else {?><a href="javascript:tableOrdering('status','DESC');" style="text-decoration:none" title="Click to sort by this column"><strong>Status</strong>&nbsp;<img alt="" src="media/system/images/sort_asc.png"></a><?php } ?></td>
			<!--<td width="15%"><strong>Email</strong></td>  -->
			<td width="4%" align="left"><strong>Details</strong></td>
		</tr>
		<?php 
		$database = &JFactory::getDbo();
		for($c=0;$c<count($leadInfos);$c++) {
			$qry1="SELECT `custom_field_value`,custom_field_id FROM `#__sbf_campaigns_custom_field_value` WHERE user_campaign_id = ".$leadInfos[$c]->UCID;  
		 $database->setQuery($qry1);
		 $leadData1 = $database->loadObjectList();
		 for($j=0;$j<count($leadData1);$j++)
		 {
			switch($leadData1[$j]->custom_field_id)
			{ 
				case	'1'	:	$leadInfos[$c]->name 		= $leadData1[$j]->custom_field_value;	break;
				case	'2'	:	$leadInfos[$c]->lastname 	= $leadData1[$j]->custom_field_value;	break;
				case	'3'	:	$leadInfos[$c]->email		= $leadData1[$j]->custom_field_value;	break;
				case	'10':	$leadInfos[$c]->phone		= $leadData1[$j]->custom_field_value;	break;
			}
			
		 }
		}	
		
		
		
		if(count($leadInfos) > 0)	{ 
			foreach ($leadInfos as $leadInfo){
	?>
	
		<tr align="left">
			<?php if(in_array($user->id,$select_gid)) { echo '<td height="20">'; echo $leadInfo->campaign_name; echo '</td>';}?>
			<td><?php if($leadInfo->name!='') echo $leadInfo->name; else echo '<span style="color:#990000">na</span>'; ?></td>
			<td><?php if($leadInfo->lastname!='') echo $leadInfo->lastname; else echo '<span style="color:#990000">na</span>'; ?></td>
			<td><?php if($leadInfo->date_added!='') echo JHTML::_('date',$leadInfo->date_added, "m/d/Y"); else echo '<span style="color:#990000">na</span>'; ?></td>
			<td><?php if($leadInfo->status==0) echo "Open"; else echo "Close"; ?></td> 
			<td><a href="index.php?option=com_formscrm&task=leadDetail&id=<?php echo $leadInfo->UCID; ?>&Itemid=<?php echo $_REQUEST['Itemid']; ?>" title="View Details"><!--<img src="administrator/components/com_formscrm/assets/images/icons-17x17-d.jpg" border="0" />-->Details</a></td>
		</tr>	
	<?php
			}
	?>

	<?php
		} else {
	?>
		<tr>
			<td colspan="7">
				No Leads assigned
			</td>
		</tr>
	
	<?php } ?>
	<!--<input type="hidden" name="task" value="view"  />-->
	<?php if(count($leadInfos) > 0) {?>
	<tr>
						<td colspan="7">
						<table width="100%" align="center" class="pagination-block">
							<tr>
								<td align="center"><div id="pagination"><?php
	//echo $this->pagination->writePagesLinks(); ?><?php //echo $this->pagination->getListFooter(); ?><?php  echo $this->pagination->getPagesLinks();  ?><div>
	</td><td align="center"><?php 	echo $this->pagination->getPagesCounter(); ?>
	</td></tr></table>

							</td>
						</tr>
	<?php } ?>
						</table>
					</td>
				</tr>
	</table>
	</form>
	</div>
