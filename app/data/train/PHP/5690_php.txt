<?php
/**
 * Created by PhpStorm.
 * User: Jon
 * Date: 6/24/2016
 * Time: 10:08 PM
 */
//usual post check.
if ($_SERVER['REQUEST_METHOD'] != 'POST') {
    header('HTTP/1.1 405 Method not allowed');
    header('Allow: POST');
    header('Content-Type: text/html; charset=UTF-8');
    exit('Invalid request, expecting POST.');
}
require "../authentication/cookieHeaders.php";

$data = json_decode(file_get_contents('php://input'), true);
if (isset($_FILES)) {

    $conn = require "../databaseManager_write.php";

    //update DB with file info
    if (isset($_FILES['json'])) {
        if ($_FILES['json']['size'] > 0) {
            $pdfFile = $_FILES['json'];
            $pdfURL = doPDFUpload($pdfFile);
            if ($pdfURL != false) {
                try {
                    //SQL to update the DB//
                    echo "File was successfully uploaded. URL: $pdfURL";
                } catch (PDOException $e) {
                    echo "DB error: " . $e->getMessage();
                }
            } else {
                echo "File upload returned as false. (Check filetype or image mime) \n";
            }
        } else {
            echo "File had a size of zero. \n";
        }
    }

    $conn = null;
}
function doPDFUpload($PDFFile)
{
    //filter by allowed image types and MIMES
    $allowedExtensions = array("json", "JSON");
    $allowedPDFMimes = array("application/json");
    $pdfExtension = pathinfo($PDFFile['name'], PATHINFO_EXTENSION);
    $fileType = $PDFFile['type'];
    $fileName = pathinfo($PDFFile['name'], PATHINFO_BASENAME);

    if (in_array($pdfExtension, $allowedExtensions) && (in_array($fileType, $allowedPDFMimes))) {
        //assign the image to a location.
        //TODO: Pick a location in the server.
        //Location is what isstored in the DB and is a realitive URL to the pdf
        $fileLocation = "../../letterPDFs/" . $fileName;
        //an absolute route to the file.
        //TODO: finish this route up
        $uploadLocation = "C:/xampp/htdocs/" . $fileName;

        move_uploaded_file($PDFFile['tmp_name'], $uploadLocation);
        return $fileLocation;
    } else {
        return false;
    }

}
