
local groupSize = 0;
textureList = nil;



local function separateName(s)
	if s then 
		local i=string.find(s, "-")
		if i then
			s=string.sub(s, 1, i-1)
		end
	end
	return s;
end


local function reset()
	local l = textureList
	textureList=nil;
	while l~=nil do
		l.texture:SetTexture(0,0,0,0);
		l=l.next
	end
end




local function setListSize()
	if groupSize~=GetNumGroupMembers() then
		groupSize=GetNumGroupMembers()
		reset()
		for i=1, 40 do
			if _G["CompactRaidFrame"..i.."Name"] ~= nil then
				local n=separateName(_G["CompactRaidFrame"..i.."Name"]:GetText())
				if n~=nil then
					local old=textureList
					textureList = {}
					textureList.next=old
					
					textureList.name=n
					local frame = _G["CompactRaidFrame"..i]
					local tex = frame:CreateTexture()
					tex:SetDrawLayer("BACKGROUND", 1)
					textureList.texture=tex
				end
			end
		end
	end
end



local function setSize(f, progress)
	f:SetAllPoints();
	local w, h = f:GetSize();
	h=h*progress
	f:ClearAllPoints();
	f:SetPoint("BOTTOMRIGHT")
	f:SetSize(w, h);
end



local function setColor(f, playerName)
	local i=1
	f:SetTexture(0,0,0,0)
	while true do
		local name, rank, icon, count, debuffType, duration, expirationTime, unitCaster = UnitBuff(playerName, i)
		if name == nil then 
			return
		end
		if unitCaster~="player" then
			break
		end
		if name == "Extend Life" then
			setSize(f, (expirationTime-GetTime())/duration)
			f:SetTexture(255,0,0,0.3)
			return
		else 
			if name == "Renewing Mist" then
				setSize(f, (expirationTime-GetTime())/duration)
				f:SetTexture(0,255,0,0.3)
			end
		end
		i=i+1
	end
end



local function onUpdate(self,elapsed)
	setListSize();
	local l=textureList;
	local i=0
	while l~=nil and i<40 do
		i=i+1
		setColor(l.texture, l.name);
		l=l.next;
	end
end
local f = CreateFrame("frame")
f:SetScript("OnUpdate", onUpdate)
