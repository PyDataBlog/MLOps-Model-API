var model = require(__dirname + '/../models/model.js');

var controller = function() {};

//create new user
function create(id) {
  var newUser = new model({
    id: id,
    currentCowntt: 0,
    apiCallsMade: 0
  });
  return newUser;
}

function getUser(id, cb) {
  model.findOne({ //find by unique id
    id: id
  }, function(err, user) {
    if (err) {
      console.log(err);
      throw new Error('could not query db');
    }

    if (!user) {//user already existed in database
      user = create(id);
    }
    cb(user);
  });
}

function saveUser(user, cb) {
  user.save( function(saveErr) {
    if (saveErr) {
      console.log('saveError saving to debugger: ' + saveErr);
    }
    cb(user);
  });
}

controller.prototype.incrementCowntt = function(id, parentCB) {
  getUser(id, function (user) {
    user.currentCowntt += 1;
    user.apiCallsMade += 1;
    saveUser(user, function() {
      parentCB(user.currentCowntt);
    });
  });
};

controller.prototype.decrementCowntt = function(id, parentCB) {
  getUser(id, function (user) {
    user.currentCowntt -= 1;
    user.apiCallsMade += 1;
    saveUser(user, function() {
      parentCB(user.currentCowntt);
    });
  });
};

controller.prototype.setCowntt = function(id, setVal, parentCB) {
  getUser(id, function (user) {
    user.currentCowntt = setVal;
    user.apiCallsMade += 1;
    saveUser(user, function() {
      parentCB(user.currentCowntt);
    });
  });
};

controller.prototype.getCowntt = function(id, parentCB) {
  getUser(id, function (user) {
    user.apiCallsMade += 1;
    saveUser(user, function() {
    });
      parentCB(user.currentCowntt);
  });
};

module.exports = controller;
