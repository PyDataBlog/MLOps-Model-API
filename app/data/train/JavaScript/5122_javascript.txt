import { addTimer } from './timer/timer';
import { showProfile } from './profile/profile';
import { showHelp } from './help/help';

import { getAllUsers } from './timer/listUtil/getAllUsers';
import { isWorking } from './timer/listUtil/isWorking';
import { timerTimeout } from './timer/listUtil/timerTimeout';
import { refreshPoints } from './timer/listUtil/refreshPoints';
import { minusStackCalculate } from './timer/listUtil/minusStackCalculate';
import { updUsrList } from './timer/listUtil/updUsrList';

const emojiMap = { '⏺': addTimer, '👤': showProfile, '❓': showHelp };

async function menuGUI(res, bot) {
  const channel = bot.channel;

  const timerList = {};
  let userList = await getAllUsers(); // eslint-disable-line

  const menuMsg = await channel.send('', {
    embed: { description: '`⏺ Start Recording! | 👤 Your Profile | ❓ Need help?`' },
  });

  // add reactions to message
  for (const emoji in emojiMap) {
    await menuMsg.react(emoji);
  }

  await channel.send('▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬');

  await menuMsg.createReactionCollector(async (reaction, user) => {
    if (user.bot) return false;

    // run the emoji command logic and remove the reaction
    if (emojiMap[reaction.emoji.name]) {
      emojiMap[reaction.emoji.name](bot, user, timerList);
    }
    await reaction.remove(user);

    return false;
  });

  res();

  setInterval(() => {
    timerTimeout(bot, timerList);
  }, 60000);

  setInterval(async () => {
    refreshPoints(timerList);
    isWorking(userList, timerList);
    minusStackCalculate();
    updUsrList(userList);
  }, 60000);
}

module.exports = {
  init: (bot) => {
    return new Promise((res) => {
      menuGUI(res, bot);
    });
  },
};
