var request = require('request');
var cheerio = require('cheerio');
var admin = require("firebase-admin");

//var serviceAccount = require("tehillim-17559-firebase-adminsdk-gx90v-b712a63ab5.json");

admin.initializeApp({
    credential: admin.credential.cert("tehillim-17559-firebase-adminsdk-gx90v-b712a63ab5.json"),
    databaseURL: "https://tehillim-17559.firebaseio.com"
});

// As an admin, the app has access to read and write all data, regardless of Security Rules
var db = admin.database();


// Attach an asynchronous callback to read the data at our posts reference
//ref.on("value", function (snapshot) {
//    console.log(snapshot.val());
//}, function (errorObject) {
//    console.log("The read failed: " + errorObject.code);
//});


var psalmId = 1;
var stripeHtml = function (text) {
    return text.replace(/<i><\/i>/g, '');
};

var removeLeadingVerseIndex = function (text) {
    return text.replace(/\d{1,2}/g, '');
};

var runEnHeRequest = function (id) {
    request('http://www.sefaria.org/api/texts/Psalms.' + id + '?commentary=0&context=1&pad=0', function (error, response, html) {
        if (!error && response.statusCode == 200) {
            console.log("Psalm: " + id + " OK");
            var objHtml = JSON.parse(html);

            var enArray = [];
            objHtml.text.forEach(function (item) {
                enArray.push(stripeHtml(item));
            });

            var newObj = {
                id: id,
                name: "Psalm " + id,
                en: enArray,
                he: objHtml.he
            }
            var path = "psalms/" + (id-1).toString();
            var ref = db.ref(path);
          
            ref.update(newObj, function (error) {
                if (error) {
                    console.log("Data could not be saved." + error);
                } else {
                    console.log("Psalm " + id + " saved successfully.");
                }
            });
        }
        if (error) {
            console.log(response);
        }
    });
}
var runPhonetiqueFrRequest = function (id) {
    request('http://tehilim-online.com/les-psaumes-de-David/Tehilim-' + id, function (error, response, html) {
        if (!error && response.statusCode == 200) {
            console.log("Psalm: " + id + " OK");
            var $ = cheerio.load(html);
            var ph = $('#phonetiqueBlock span').text().split("\n");
            var frNotFormatted = $('#traductionBlock p').text().split("\n");
            var fr = [];
            frNotFormatted.forEach(function (item) {
                fr.push(removeLeadingVerseIndex(item));
            });
            var newObj = {
                ph: ph,
                fr: fr
            }
           // console.log(newObj);
            var path = "psalms/" + (id - 1).toString();
            var ref = db.ref(path);

            ref.update(newObj, function (error) {
                if (error) {
                    console.log("Data could not be saved." + error);
                } else {
                    console.log("Psalm " + id + " saved successfully.");
                }
            });
        }
        if (error) {
            console.log(response);
        }
    });
}
while(psalmId <= 150) {
    var psalmTextArray = [];
  
    //runEnHeRequest(psalmId);
    runPhonetiqueFrRequest(psalmId);
    psalmId++;
}