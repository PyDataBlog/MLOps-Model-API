#!/usr/bin/perl -w
use strict;
use Net::LDAP;
use Getopt::Std;
use Term::ReadKey;
use Authen::Krb5::Admin;
require '/usr/local/seguridad/userManagement/common.pm';

#
# Defaults
#
my $ConfigFile = '/usr/local/seguridad/userManagement/userManagement.conf';
my %config;

sub print_usage {
	print "$0: $0 [-f config_file] [-e expire_date] [-p policy] username\n";
}

if (! $ARGV[0]) {
	print_usage;
	exit 1;
}

#
# Parsing de las Opciones de Linea de Comandos
#
my %args; getopts('f:e:p:', \%args);

#
# Inicializacion de variables
#
$ConfigFile = $args{'f'} if ($args{'f'});
readConfigFile($ConfigFile, \%config);
$config{'searchBase'} = '';

my $kerberos_handle = kerberos_authentication(\%config);
my %kerberos_principal;

if ($ARGV[0]) {
	die "ERROR: El usuario especificado ya existe." if check_krb_princ(\%config, $ARGV[0], $kerberos_handle);
	$kerberos_principal{'principal'} = $ARGV[0];
} else {
	print_usage;
	exit 1;
}

$kerberos_principal{'expiredate'} = $args{'e'} if $args{'e'};

if ($args{'p'}) {
	$kerberos_principal{'policy'} = $args{'p'};
} else {
	$kerberos_principal{'policy'} = $config{'DefaultKerberosPolicy'}
}


my $password = read_password("Ingrese el Password para el nuveo usuario: ");

print "Agregando el PRINCIPAL en KERBEROS...\n";
add_kerberos_principal(\%config, \%kerberos_principal, $password, $kerberos_handle);

print "Hecho.\n";
