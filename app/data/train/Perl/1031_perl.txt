#!/usr/bin/perl
use strict;
use warnings;

if (scalar(@ARGV) != 1 ) {
	die "Usage: $0 file.pgn\n";
}
else {
	# nothing.
}

my $this_file = shift @ARGV;

my $this_suffix = ".pgn";
if ($this_file =~ /$this_suffix/) {
	# nothing.
}
else {
	die "File error! Usage: $0 file.pgn\n";
}

#my $sheet = $this_file;
#$sheet =~ s/$this_suffix/\_sheet\.txt/;
#open(SHEET, ">$sheet") or die "error write $sheet\n";

my $this_out = $this_file;
my $add = "_keys";
$this_out =~ s/$this_suffix/$add$this_suffix/;

if (-e $this_out) {
	# do nothing.
}
else {
	open(OUT, ">$this_out") or die "error write $this_out\n";
	my $double_this_out = &write_file_with_keys($this_file);
}

exit;

sub write_file_with_keys {
	my $file = shift @_;
	open(IN, $file) or die "error read $file\n";

	my $out = $file;
	my $suffix = ".pgn";
	my $add = "_keys";
	$out =~ s/$suffix/$add$suffix/;
	open(OUT, ">$out") or die "error write $out\n";

	my $FirstTag = "Event ";
	my $Key = 0;
	my $KeyStart = "[Key = ";
	my $KeyEnd = "]";
	while(<IN>) {
		chomp;
		if (/$FirstTag/) {
			$Key++;
			print OUT $KeyStart.$Key.$KeyEnd."\n$_\n";
		}
		else {
			print OUT "$_\n";
		}
	}
	close(IN);
	close(OUT);

	return $out;
}
