#!/usr/bin/perl
use strict;
use warnings;
use RPi::I2C;

package Rrdpi::Gas;

sub new
{
	my ($class, $conf) = @_;
	my $self = {conf => $conf};
	bless( $self, $class );
	$self->{rrdParams} = $self->getRrdParams();
	return $self;
}

sub getRrdParams
{
	my ($self) = @_;
	 
	return {
		name => 'gas',
		datafiles => [$self->{conf}->{DBPATH}."/gas.rrd"],
		picBase => [$self->{conf}->{OUTPATH}."/gas-"],
		DS => ['gas'],
		DSDescr => ['Gas level'],
		DSChecks => [{warn=>'$_>100', fail=>'$_>200'}],
		rrdCreate => [
			 "DS:gas:GAUGE:300:-10:500",
			 ],
		graphTitles => [''],
		
		rrdGraph => [
			'--lazy',
			'--imgformat=PNG',
			'--title=Gas level',
			"--width=".$self->{conf}->{GRAPH_WIDTH},
			"--height=".$self->{conf}->{GRAPH_HEIGHT},
			'--lower-limit=0',
#			'--upper-limit=100',
			'--rigid',

			"DEF:gas=DATAFILE:gas:AVERAGE",
			
			'AREA:gas#3535FF:Gas level',
			'COMMENT:\n',
			'COMMENT: '
			]
		};
}

sub gather 
{	
	my ($self) = @_;
	
	my $device = RPi::I2C->new(0x28, '/dev/i2c-3');
	my $reading = $device->read_word(0x81);
	$reading = 'U' if $reading == -1;

	return [sprintf("N:%s", $reading)];
}

1;
