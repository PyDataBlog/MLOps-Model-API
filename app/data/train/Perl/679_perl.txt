#!/usr/bin/perl

use strict;
use warnings;
use Switch 'Perl6';
use LWP::UserAgent;

package xkcdbot;
use base qw ( Bot::BasicBot );


sub said {
	my ($self, $message) = @_;
	parse($self, $message);
}


sub parse {
	my ($self, $message) = @_;

	given ($message->{body}) {

		# Comic Search
		when (/\.xkcd (.+?)$/) {
			my $result = search($self, $message);

			if($message->{body} =~ /\| (.+?)$/) {
				# Name Piping
				talk($self, $message->{channel}, "$1, $result", "");
			} else {
				# Normal Send
				talk($self, $message->{channel}, "$message->{who}, $result", "$message->{who}");
			}
		}
	}
}


sub talk {
	my ($self,$channel,$message,$who) = @_;

	if($who eq "") { return; }

	$self->say(
		who => "$who",
		channel => "$channel",
		body => "$message",
	);		
}


sub search {
	my ($self, $message) = @_;
	my $ua = LWP::UserAgent->new();
	$ua->agent('Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.1.5) Gecko/20091102 Firefox/3.5.5 (.NET CLR 3.5.30729)');
	my $response = $ua->get("http://www.google.com/search?hl=en&sitesearch=xkcd.com&safe=off&num=1&q=%22link to this comic%22 -forum $message->{body}");

	my $content = $response->content;

	if($content =~ /http:\/\/xkcd\.com\/(\d+?)\//g) {
		return "http://xkcd.com/$1/";
	}

	 return "Sorry but I can't seem to find a comic related to what you searched for.";
}



my $bot = xkcdbot->new(
        nick => "",
        username => "",
        name => "",
        server => "",
        port => "6667",
        channels => [ '' ],
)->run();
