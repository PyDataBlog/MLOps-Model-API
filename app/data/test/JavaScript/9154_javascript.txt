var express = require('express');
var router = express.Router();
const env = require('env2')('./env.json');

var Tag = require('../mongo/tags')
var IssueTag = require('../mongo/Issue')


router.post('/removeTag', function (req, res, next) {
    var userID = req.body.userID;
    var repoID = req.body.repoID;
    var name = req.body.name;
    var tagID = req.body.tagID;
    Tag.remove({
        userID: userID,
        repoID: repoID,
        tagID: tagID
    }, function (err, data) {
        res.send(data);
    });
});

router.post('/getTag', function (req, res, next) {
    var userID = req.body.userID;
    var repoID = req.body.repoID;
    Tag.find({ userID: userID, repoID: repoID }, function (err, docs) {
        res.send(docs);
    });
});

router.post('/addTag', function (req, res, next) {
    var userID = req.body.userID;
    var repoID = req.body.repoID;
    var tagID = req.body.tagID;
    var name = req.body.name;
    var color = req.body.color;
    var selected = req.body.selected;
    var tag = new Tag({
        tagID: tagID,
        userID: userID,
        repoID: repoID,
        name: name,
        color: color,
        selected: selected
    });

    tag.save(function (err, resp) {
        if (err) {
            console.log("Error:" + err);
        }
        else {
            res.send(resp);
        };
    });
});

router.post('/updateIssueTag', function (req, res, next) {
    var userID = req.body.userID;
    var repoID = req.body.repoID;
    var number = req.body.number;
    var tagIDs = req.body.tagIDs;
    var query = {
        userID: userID,
        repoID: repoID,
        number: number
    };
    IssueTag.update(query, { tagIDs: tagIDs }, { upsert: true }, function (err, docs) {
        res.send(docs);
    });
});

router.post('/updateIssueNote', function (req, res, next) {
    var userID = req.body.userID;
    var repoID = req.body.repoID;
    var number = req.body.number;
    var note = req.body.note;
    var query = {
        userID: userID,
        repoID: repoID,
        number: number
    };
    IssueTag.update(query, { note: note }, { upsert: true }, function (err, docs) {
        res.send(docs);
    });
});

module.exports = router;