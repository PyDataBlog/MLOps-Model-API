@echo off
setlocal EnableDelayedExpansion
echo ***************************************************************************
echo                build_all.bat
echo                     by niuren.zhu
echo                           2017.01.13
echo  ËµÃ÷£º
echo     1. ´Ë½Å±¾ÐèÒªÔÚNode.js command promptÏÂÔËÐÐ¡£
echo     2. ±éÀúµ±Ç°Ä¿Â¼ÏÂËùÓÐ×ÓÄ¿Â¼£¬´æÔÚtsconfig.jsonÔò±àÒë¡£
echo     3. ²ÎÊý1£¬tscÃüÁîµÄÆäËû²ÎÊý£¬Èç£º-w£¬±íÊ¾¼àÌýÎÄ¼þ±ä»¯¡£
echo ****************************************************************************
REM ÉèÖÃ²ÎÊý±äÁ¿
REM ¹¤×÷Ä¿Â¼
SET WORK_FOLDER=%~dp0
REM Èô¹¤×÷Ä¿Â¼×îºó×Ö·û²»ÊÇ¡°\¡±Ôò²¹Æë
if "%WORK_FOLDER:~-1%" neq "\" SET WORK_FOLDER=%WORK_FOLDER%\
echo --¹¤×÷µÄÄ¿Â¼£º%WORK_FOLDER%
REM ÆäËû²ÎÊý
SET OPTIONS=%~1
REM ¹¹½¨ÃüÁî
SET COMMOND=tsc
if "%OPTIONS%" neq "" (
  SET COMMOND=start /min !COMMOND! %OPTIONS%
  echo ÃüÁî£º!COMMOND!
)
REM Ó³Éä¿â
SET IBAS_FOLDER=%IBAS_TS_LIB%
if "%IBAS_FOLDER%" equ "" (
REM Ã»ÓÐ¶¨Òå»·¾³±äÁ¿
  if exist "%WORK_FOLDER%..\..\..\..\..\ibas-typescript\" (
    SET IBAS_FOLDER=%WORK_FOLDER%..\..\..\..\..\ibas-typescript\
  )
)

REM ¼ì²é²¢Ó³Éä¿â
if "%IBAS_FOLDER%" neq "" (
echo --¼ì²é¿â·ûºÅÁ´½Ó
  if not exist %WORK_FOLDER%3rdparty\ibas mklink /d .\3rdparty\ibas %IBAS_FOLDER%ibas\ > nul
  if not exist %WORK_FOLDER%3rdparty\openui5 mklink /d .\3rdparty\openui5 %IBAS_FOLDER%openui5\ > nul
  if not exist %WORK_FOLDER%3rdparty\shell mklink /d .\3rdparty\shell %IBAS_FOLDER%shell\ > nul
)

REM ±àÒëÏîÄ¿ÅäÖÃ
SET TS_CONFIGS=tsconfig.json
SET TS_CONFIGS=%TS_CONFIGS% bsui\c\tsconfig.json
SET TS_CONFIGS=%TS_CONFIGS% bsui\m\tsconfig.json

FOR %%l IN (%TS_CONFIGS%) DO (
  SET TS_CONFIG=%%l
  echo --¿ªÊ¼±àÒë£º!TS_CONFIG!
  call !COMMOND! -p !TS_CONFIG!
)
