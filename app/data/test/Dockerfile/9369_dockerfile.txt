FROM 720913919698.dkr.ecr.us-east-1.amazonaws.com/node:8.11.3

RUN apk add --no-cache \
    autoconf \
    automake \
    g++ \
    gcc \
    git \
    make \
    nasm \
    python \
    zlib-dev

ONBUILD ARG NPM_TOKEN

ONBUILD ARG NODE_ENV=production
ONBUILD ENV NODE_ENV=${NODE_ENV}

ONBUILD ARG NPM_LOG_LEVEL=error
ONBUILD ENV npm_config_loglevel=${NPM_LOG_LEVEL}

ONBUILD ARG REVISION
ONBUILD ENV REVISION=${REVISION}

ONBUILD COPY package.json package-lock.json ./
ONBUILD RUN echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> ~/.npmrc \
  && npm install \
  && rm ~/.npmrc
ONBUILD COPY . ./
ONBUILD RUN if [ -f ./scripts/build.sh ]; then ./scripts/build.sh; fi
