FROM mggd/debian:jessie-amd64

################################
# Helpful ARGS
################################
ARG DEBIAN_FRONTEND=teletype 
ARG aptget_min="apt-get -q -y --no-install-recommends install "
ARG sdk_root="/home/devuser/sdk"
ARG staging_dir=${sdk_root}/staging_dir
ARG sdk_prefix=${staging_dir}/toolchain-mips_r2_gcc-4.6-linaro_uClibc-0.9.33.2/bin/mips-openwrt-linux-
ARG lib_path=${staging_dir}/toolchain-mips_r2_gcc-4.6-linaro_uClibc-0.9.33.2/lib/ 

#######################
# Install sudo
#######################
RUN \
echo "Updating apt-get..." && \
apt-get update && \
echo "Installing sudo..." && \
$aptget_min  sudo

########################
# Setup user:  devuser
########################
RUN useradd -ms /bin/bash devuser && printf "devuser  ALL=NOPASSWD: ALL\n" >> /etc/sudoers
USER devuser
WORKDIR /home/devuser

############################################
# Install OpenWRT (Linino) SDK prerequisite
############################################
RUN \
sudo $aptget_min \
build-essential \
cmake \
curl \
gawk \
git-core \
ca-certificates \
libncurses5 \
libncurses5-dev \
openssh-client \
python \
sed \
subversion \
unzip \
zlib-gst \
zlib1g \
zlib1g-dbg \
zlib1g-dev \
zlibc \ 

#########################
# Build and install vim
#########################
libncurses5-dev \
libgnome2-dev \
libgnomeui-dev \
libgtk2.0-dev \
libatk1.0-dev \
libbonoboui2-dev \
libcairo2-dev \
libx11-dev \
libxpm-dev \
libxt-dev \
python-dev \
lua5.1 \
lua5.1-dev \
libperl-dev && \

git clone https://github.com/vim/vim.git && \

cd vim && \

./configure --with-features=huge \
--enable-multibyte \
--enable-pythoninterp=yes \
--with-python-config-dir=/usr/lib/python2.7/config \
--enable-python3interp=yes \
--enable-perlinterp=yes \
--enable-luainterp=yes \
--enable-cscope \
--prefix=/usr && \

make VIMRUNTIMEDIR=/usr/share/vim/vim80 && \
sudo make install && \
sudo apt-get -y purge vim-common vim-tiny && \
sudo update-alternatives --install /usr/bin/editor editor /usr/bin/vim 1 && \
sudo update-alternatives --set editor /usr/bin/vim && \
sudo update-alternatives --install /usr/bin/vi vi /usr/bin/vim 1 && \
sudo update-alternatives --set vi /usr/bin/vim && \
rm -rf /home/devuser/vim && \
mkdir -p /home/devuser/.vim/colors

###############################
#  Download linino/openWRT sdk
###############################
RUN curl -O http://gunlock.io/dev/linino/files/sdk.zip
RUN unzip sdk.zip && rm sdk.zip

COPY Tomorrow-Night-Bright.vim /home/devuser/.vim/colors/Tomorrow-Night-Bright.vim
COPY vimrc /home/devuser/.vimrc


#########################
#  Set dev env vars
#########################
ENV SDKROOT=${sdk_root} \
STAGING_DIR=${sdk_root}/staging_dir  \
SDK_PREFIX=${staging_dir}/toolchain-mips_r2_gcc-4.6-linaro_uClibc-0.9.33.2/bin/mips-openwrt-linux- \
CC=${sdk_prefix}gcc \
CXX=${sdk_prefix}g++ \
AR=${sdk_prefix}ar \
RANLIB=${sdk_prefix}ranlib \
LINK=${sdk_prefix}g++ \
CPP="${sdk_prefix}gcc -E" \
STRIP=${sdk_prefix}strip \
OBJCOPY=${sdk_prefix}objcopy \
LD=${sdk_prefix}g++ \
OBJDUMP=${sdk_prefix}objdump \
NM=${sdk_prefix}nm \
AS=${sdk_prefix}as \
LIBPATH=${staging_dir}/toolchain-mips_r2_gcc-4.6-linaro_uClibc-0.9.33.2/lib/ \
LDFLAGS='-Wl,-rpath-link '${lib_path} \
SDK_INCLUDE_DIR=${staging_dir}/include
