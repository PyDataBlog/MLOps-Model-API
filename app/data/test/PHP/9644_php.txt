<?php
defined('BASEPATH') OR exit('No direct script access allowed');

class User extends CI_Controller {
 
 	public function __construct() {
        parent::__construct();        
       	$this->load->library('auth');
        $this->auth->cek_auth();
        //$this->load->model('Model_config','m_config', True);
        $this->load->model('Model_user','m_user', True);
		date_default_timezone_set("Asia/Jakarta");
	}
	public function index()
	{
		
		$data  = array(
			'isikonten' => 'main/user', 
			'listuser'	=> $this->m_user->getUser(),
			'listAkses' => $this->m_config->getAkses(),
			'url' 		=> site_url('User/ambil_data')
			 );		
		$this->load->view('wrapper',$data);
		
	}
	public function add_user(){
		$username = $this->session->userdata('username');
		$log_date = date("Y-m-d H:i:s");
		$log_activity = 'add user';
		$log_module = 'User';		
				$id 			= $this->input->post('id');
				$userID 		= $this->input->post('userID');
				
				$email 			= $this->input->post('email');
				$akses_level 	= $this->input->post('akses_level');
				$status 		= $this->input->post('status');
				if($id !='')
				{
					$password 		= $this->input->post('password');
				}else
				{
					$password 		= md5($this->input->post('password'));
				}
				$data 	= array(
					'userID' 		=> $userID,
					'password'		=> $password,
					'email_user'	=> $email,
					'akses_level'	=> $akses_level,
					'aktif'			=> $status
					);
				if($id !='')
				{

					$this->m_user->update_user($id,$data);
					$this->session->set_flashdata('message', "Success");
					redirect('User');
				}
				else
				{
				$query = $this->db->query("select userID from tbl_user where userID = '".$userID."' OR email_user='".$email."'");
				if($query->num_rows() == 0){				
					$simpan = $this->m_user->save($data);


					if ($simpan) {
						
		$log_detail = $userID.'-'.$password.'-'.$email.'-'.$akses_level;
		$this->auth->log_activity($log_date,$log_module,$log_activity,$log_detail,$username);
		/////////////////////////////////////////////////////////						
						$this->session->set_flashdata('message', "Success");
						redirect('User');
					}
				}else{
					echo "<script>alert('UserID Or Email has been used');</script>";
					echo "<script>window.location = '".base_url()."index.php/User/';</script>";
				}

			   }

	}

	function ambil_data()
	{
		 $list = $this->m_user->get_datatables();
   
    $data = array();
    $no = $_POST['start'];



    foreach ($list as $user) {
      
      $no++;
      $row = array();
      $row[] = $no;
      $row[] = $user->userID;
      $row[] = $user->email_user;
      $row[] = $user->akses_level;
      $row[] = $user->aktif;

      $html = '<a href="#" data-user_id="'.$user->id.'" class="btn btn-info editUser" data-toggle="modal" data-target="#FormUser">Edit User</a>';
      $row[] = $html;
     

      $data[] = $row;
    }

    $output = array(
            "draw" => $_POST['draw'],
            "recordsTotal" => $this->m_user->count_all(),
            "recordsFiltered" => $this->m_user->count_filtered(),
            "data" => $data,
        );
    //output to json format
    echo json_encode($output);
	}
	

	function json_edit_user()
	{
		$userid = $this->input->post('userid'); 
		$query  = $this->m_user->get_user($userid);

		foreach ($query->result() as $val_user)
		{
			$data_user = array(
				'id'			=> $val_user->id,
				'user_id_edit' 	=> $val_user->userID, 
				'password'		=> $val_user->password,
				'email'			=> $val_user->email_user,
				'akses_level'	=> $val_user->akses_level,
				'aktif'			=> $val_user->aktif
				);
		}
		echo json_encode($data_user);

	}

	function edited()
	{
		$username = $this->session->userdata('username');
		$log_date = date("Y-m-d H:i:s");
		$log_activity = 'edit user';
		$log_module = 'User';
		
		$userid=$_POST['userid'];
		$password = (md5($this->input->post('password')));
		$akses = $_POST['akses_level'];
		
		$data = array
		(
			'email_user' => $_POST['email'],
			'password' => ($password),
			'akses_level' => $akses
		);

		$log_detail = $userid.'-'.$password.'-'.$akses;
		$this->auth->log_activity($log_date,$log_module,$log_activity,$log_detail,$username);
		/////////////////////////////////////////////////////////		
		
		$this->m_user->edit_user($userid, $data);
		redirect('User');
	}
	
}