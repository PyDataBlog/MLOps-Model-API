<?php
/**
 * JS_API支付demo
 * ====================================================
 * 在微信浏览器里面打开H5网页中执行JS调起支付。接口输入输出数据格式为JSON。
 * 成功调起支付需要三个步骤：
 * 步骤1：网页授权获取用户openid
 * 步骤2：使用统一支付接口，获取prepay_id
 * 步骤3：使用jsapi调起支付
*/
	include_once("WxPayPubHelper/WxPayPubHelper.php");

	$orderid=$_GET['orderid'];
    $openid=$_GET['openid'];
	$con = mysql_connect("localhost","root","^7*iK,MnHy");
	if (!$con){
  		die('Could not connect: ' . mysql_error());
  	}
  	mysql_select_db("weixin_xkt", $con);
  	mysql_query("SET CHARACTER SET utf8 ");
	$result = mysql_query("SELECT * FROM v_football_order_info where id_order=".$orderid);
	while($row = mysql_fetch_array($result)){
  		$ordersn=$row['ordersn'];
  		$price=$row['price'];
  		$title=$row['title'];
  		$username=$row['username'];
  		$userphone=$row['userphone'];
  	}
	// 一些代码...
	mysql_close($con);

	//使用jsapi接口
	$jsApi = new JsApi_pub();

	//=========步骤1：网页授权获取用户openid============
	//通过code获得openid
	// if (!isset($_GET['code']))
	// {
	// 	//触发微信返回code码
	// 	$url = $jsApi->createOauthUrlForCode(WxPayConf_pub::SHOPPING_PAY_URL.'?orderid='.$orderid);
 //        Header("Location: $url");
	// }else
	// {
	// 	//获取code码，以获取openid
	//     $code = $_GET['code'];
	// 	$jsApi->setCode($code);
	// 	$openid = $jsApi->getOpenId();
	// }
    // echo $openid;

    // echo $code.'  '.$openid;
	//=========步骤2：使用统一支付接口，获取prepay_id============
	//使用统一支付接口
	$unifiedOrder = new UnifiedOrder_pub();
	//设置统一支付接口参数
	//设置必填参数
	//appid已填,商户无需重复填写
	//mch_id已填,商户无需重复填写
	//noncestr已填,商户无需重复填写
	//spbill_create_ip已填,商户无需重复填写
	//sign已填,商户无需重复填写
	$unifiedOrder->setParameter("openid","$openid");//用户标识
	$unifiedOrder->setParameter("body",$title);//商品描述
	//自定义订单号，此处仅作举例
	$timeStamp = time();
	$out_trade_no = WxPayConf_pub::APPID."$timeStamp";
	if(isset($ordersn)){
		$out_trade_no=$ordersn.$timeStamp;
	}
	$unifiedOrder->setParameter("out_trade_no","$out_trade_no");//商户订单号
	$unifiedOrder->setParameter("total_fee","1");//总金额
	$unifiedOrder->setParameter("notify_url",WxPayConf_pub::NOTIFY_URL);//通知地址
	$unifiedOrder->setParameter("trade_type","JSAPI");//交易类型
	// 非必填参数，商户可根据实际情况选填
	// $unifiedOrder->setParameter("sub_mch_id","XXXX");//子商户号  
	// $unifiedOrder->setParameter("device_info","XXXX");//设备号 
	// $unifiedOrder->setParameter("attach","XXXX");//附加数据 
	// $unifiedOrder->setParameter("time_start","XXXX");//交易起始时间
	// $unifiedOrder->setParameter("time_expire","XXXX");//交易结束时间 
	// $unifiedOrder->setParameter("goods_tag","XXXX");//商品标记 
	// $unifiedOrder->setParameter("openid","XXXX");//用户标识
	// $unifiedOrder->setParameter("product_id","XXXX");//商品ID

	$prepay_id = $unifiedOrder->getPrepayId();
	//=========步骤3：使用jsapi调起支付============
	$jsApi->setPrepayId($prepay_id);

	$jsApiParameters = $jsApi->getParameters();
	 // echo $openid.' \r\n '.$prepay_id.'\r\n '.$jsApiParameters;
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
<title>微信安全支付</title>
<style>
* { margin:0;padding:0; }
</style>
<link rel="stylesheet" href="/assets/css/weui.min.css" type="text/css"/>
<link rel="stylesheet" href="/assets/css/football.css?v=<?php echo time();?>" type="text/css"/>	
<script src="/assets/js/zepto.min.js" type="text/javascript"></script>
<script src="/assets/js/football.js?v=<?php echo time();?>" type="text/javascript"></script>
</head>
<body id="body">

<div class="head">
    <a href="javascript:history.go(-1);" class="bn pull-left"><img src="/assets/images/icon_nav_back.png" class="head_img"></a>
    <span class="title">订单支付</span>
    <a href="index.php?d=football&m=myorder" class="bn pull-right"><img src="/assets/images/personal.png" class="head_img_right"></a>
</div>
<div class="container" id="container" >
<div class="bd">
    <div  id="productPhoto" style="padding-top:55px;">
       
    </div>
    <div class="weui_cells">
        <div class="weui_cell">
            <div class="weui_cell_bd weui_cell_primary">
                <p>订单编号</p>
            </div>
            <div class="weui_cell_ft"><?php if (isset($ordersn)) {
                echo $ordersn;
            } ?></div>
        </div>
        <div class="weui_cell">
            <div class="weui_cell_bd weui_cell_primary">
                <p>订单金额</p>
            </div>
            <div class="weui_cell_ft"><span style="color:#e9342a"><?php if (isset($price)) {
                echo $price;
            } ?>元</span></div>
        </div>
        <div class="weui_cell">
            <div class="weui_cell_bd weui_cell_primary">
                <p>商品名称</p>
            </div>
            <div class="weui_cell_ft"><?php if (isset($title)) {
                echo $title;
            } ?></div>
        </div>
        <div class="weui_cell">
            <div class="weui_cell_bd weui_cell_primary"><label class="weui_label">姓名</label></div>
            <div class="weui_cell_ft"><?php if (isset($username)) {
                echo $username;
            } ?></div>
        </div>
        <div class="weui_cell">
            <div class="weui_cell_bd weui_cell_primary"><label class="weui_label">手机号</label></div>
            <div class="weui_cell_ft"><?php if (isset($userphone)) {
                echo $userphone;
            } ?></div>
        </div>
    </div>
    <div class="weui_btn_area">
        <a class="weui_btn weui_btn_warn btn_blue" href="javascript:callpay();" id="payGoodsOrder">立即支付</a>
    </div>
</div>
</div>

<div class="weui_dialog_alert" id="dialog_error" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title">提示</strong></div>
        <div class="weui_dialog_bd" id="tip_content">支付失败,请重试！</div>
        <div class="weui_dialog_ft">
            <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>

<div class="weui_dialog_alert" id="dialog_cancel" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title">提示</strong></div>
        <div class="weui_dialog_bd" id="tip_content">支付已取消！</div>
        <div class="weui_dialog_ft">
            <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>

<div class="weui_dialog_alert" id="dialog_ok" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title">提示</strong></div>
        <div class="weui_dialog_bd" id="tip_content">支付成功！</div>
        <div class="weui_dialog_ft">
            <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>
<!-- loading toast -->
<div id="loadingToast" class="weui_loading_toast" style="display:none;">
    <div class="weui_mask_transparent"></div>
    <div class="weui_toast">
        <div class="weui_loading">
            <div class="weui_loading_leaf weui_loading_leaf_0"></div>
            <div class="weui_loading_leaf weui_loading_leaf_1"></div>
            <div class="weui_loading_leaf weui_loading_leaf_2"></div>
            <div class="weui_loading_leaf weui_loading_leaf_3"></div>
            <div class="weui_loading_leaf weui_loading_leaf_4"></div>
            <div class="weui_loading_leaf weui_loading_leaf_5"></div>
            <div class="weui_loading_leaf weui_loading_leaf_6"></div>
            <div class="weui_loading_leaf weui_loading_leaf_7"></div>
            <div class="weui_loading_leaf weui_loading_leaf_8"></div>
            <div class="weui_loading_leaf weui_loading_leaf_9"></div>
            <div class="weui_loading_leaf weui_loading_leaf_10"></div>
            <div class="weui_loading_leaf weui_loading_leaf_11"></div>
        </div>
        <p class="weui_toast_content">数据请求中</p>
    </div>
</div>
	<script type="text/javascript">

		//调用微信JS api 支付
		function jsApiCall()
		{
			WeixinJSBridge.invoke(
				'getBrandWCPayRequest',
				<?php echo $jsApiParameters; ?>,
				function(res){
					WeixinJSBridge.log(res.err_msg);
					if(res.err_msg=='get_brand_wcpay_request:ok'){
						 window.location.href="/index.php?d=football&c=reserve&m=paydone&orderid=<?php echo $orderid;?>";  
					}else if(res.err_msg=='get_brand_wcpay_request:ok'){
						$('#dialog_cancel').show().on('click', '.weui_btn_dialog', function () {
                    		$('#dialog_cancel').off('click').hide();
           				 });
					}else{
                        // alert(res.err_msg);
						$('#dialog_error').show().on('click', '.weui_btn_dialog', function () {
                    		$('#dialog_error').off('click').hide();
           				 });
					}
				}
			);
		}

		function callpay()
		{
			if (typeof WeixinJSBridge == "undefined"){
			    if( document.addEventListener ){
			        document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
			    }else if (document.attachEvent){
			        document.attachEvent('WeixinJSBridgeReady', jsApiCall); 
			        document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
			    }
			}else{
			    jsApiCall();
			}
		}
	</script>
</body>
</html>