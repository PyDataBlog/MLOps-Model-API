/*
 * Copyright 2004,2006 The Poderosa Project.
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 *
 * $Id: TerminalSessionEx.cs,v 1.2 2011/10/27 23:21:59 kzmi Exp $
 */
using System;
using System.Collections.Generic;
using System.Text;

using Poderosa.Commands;
using Poderosa.Protocols;
using Poderosa.Terminal;
using Poderosa.Forms;

namespace Poderosa.Sessions {

    //^[~iÚ±ÌZbV
    //  TerminalEmulatorvOCàÌR}hÍACommandTarget->View->Document->Session->TerminalSession->TerminalÆHÁÄR}hÀsÎÛð¾éB
    /// <summary>
    /// <ja>
    /// ^[~iZbVð¦·C^[tFCXÅ·B
    /// </ja>
    /// <en>
    /// Interface that show the terminal session.
    /// </en>
    /// </summary>
    /// <remarks>
    /// <ja>
    /// <para>
    /// PoderosaðWÌ^[~iG~[^ÆµÄp¢éêÉÍA<seealso cref="ISession">ISession</seealso>ÌÀÔÍA
    /// ±ÌITerminalSessionÅ èAGetAdapterðgÁÄæ¾Å«Ü·B
    /// </para>
    /// <para>
    /// <para>
    /// ^[~iZbVÍAÌû@Åæ¾Å«Ü·B
    /// </para>
    /// <list type="number">
    /// <item>
    /// <term>ANeBuÈEBhE^r[©çæ¾·éê</term>
    /// <description>
    /// <para>
    /// EBhE}l[WÌActiveWindowvpeBÍAANeBuEBhEð¦µÜ·B
    /// ±ÌANeBuEBhE©çhLgA»µÄAZbVÖÆ½Çé±ÆÅ^[~iZbVðæ¾Å«Ü·B 
    /// </para>
    /// <code>
    /// // EBhE}l[Wðæ¾
    /// ICoreServices cs = (ICoreServices)PoderosaWorld.GetAdapter(typeof(ICoreServices));
    /// IWindowManager wm = cs.WindowManager;
    ///
    /// // ANeBuEBhEðæ¾
    /// IPoderosaMainWindow window = wm.ActiveWindow;
    ///
    /// // r[ðæ¾
    /// IPoderosaView view = window.LastActivatedView;
    /// 
    /// // hLgðæ¾
    /// IPoderosaDocument doc = view.Document;
    /// 
    /// // ZbVðæ¾
    /// ISession session = doc.OwnerSession;
    /// 
    /// // ^[~iZbVÖÆÏ·
    /// ITerminalSession termsession = 
    ///   (ITerminalSession)session.GetAdapter(typeof(ITerminalSession));
    /// </code>
    /// </description>
    /// </item>
    /// <item><term>j[âc[o[Ì^[Qbg©ç^[~iZbVð¾éê</term>
    /// <description>
    /// <para>
    /// j[âc[o[©çR}hªø«n³êéÆ«ÉÍA^[QbgÆµÄìÎÛÌEBhEª¾çêÜ·B
    /// ±Ì^[QbgðpµÄ^[~iZbVð¾é±ÆªÅ«Ü·B 
    /// </para>
    /// <para>
    /// <seealso cref="CommandTargetUtil">CommandTargetUtil</seealso>ÉÍAANeBuÈhLgð¾é½ßÌAsDocumentOrViewOrLastActivatedDocument\bhª èÜ·B
    /// ±Ì\bhðgÁÄhLgðæ¾µA»±©çITerminalSessionÖÆÏ··é±ÆÅA^[QbgÉÈÁÄ¢é^[~iZbVðæ¾Å«Ü·B 
    /// </para>
    /// <code>
    /// // targetÍR}hÉn³ê½^[QbgÅ éÆzèµÜ·
    /// // hLgðæ¾
    /// IPoderosaDocument doc = 
    ///   CommandTargetUtil.AsDocumentOrViewOrLastActivatedDocument(target);
    /// if (doc != null)
    /// {
    ///   // ZbVðæ¾
    ///   ISession session = doc.OwnerSession;
    ///   // ^[~iZbVÖÆÏ·
    ///   ITerminalSession termsession = 
    ///     (ITerminalSession)session.GetAdapter(typeof(ITerminalSession));
    /// }
    /// </code>
    /// </description>
    /// </item>
    /// </list>
    /// </para>
    /// </ja>
    /// <en>
    /// <para>
    /// The realities of <seealso cref="ISession">ISession</seealso> are these ITerminalSession when Poderosa is used as a standard terminal emulator, and it is possible to acquire it by using GetAdapter. 
    /// </para>
    /// <para>
    /// <para>
    /// The terminal session can be got in the following method. 
    /// </para>
    /// <list type="number">
    /// <item>
    /// <term>Get from active window or view.</term>
    /// <description>
    /// <para>
    /// Window manager's ActiveWindow property shows the active window. The terminal session can be got by tracing it from this active window to the document and the session. 
    /// </para>
    /// <code>
    /// // Get the window manager.
    /// ICoreServices cs = (ICoreServices)PoderosaWorld.GetAdapter(typeof(ICoreServices));
    /// IWindowManager wm = cs.WindowManager;
    ///
    /// // Get the active window.
    /// IPoderosaMainWindow window = wm.ActiveWindow;
    ///
    /// // Get the view.
    /// IPoderosaView view = window.LastActivatedView;
    /// 
    /// // Get the document.
    /// IPoderosaDocument doc = view.Document;
    /// 
    /// // Get the session
    /// ISession session = doc.OwnerSession;
    /// 
    /// // Convert to terminal session.
    /// ITerminalSession termsession = 
    ///   (ITerminalSession)session.GetAdapter(typeof(ITerminalSession));
    /// </code>
    /// </description>
    /// </item>
    /// <item><term>Get the terminal session from the target of menu or toolbar.</term>
    /// <description>
    /// <para>
    /// When the command is handed over from the menu and the toolbar, the window to be operated as a target is obtained. 
    /// The terminal session can be obtained by using this target. 
    /// </para>
    /// <para>
    /// In <seealso cref="CommandTargetUtil">CommandTargetUtil</seealso>, there is AsDocumentOrViewOrLastActivatedDocument method to obtain an active document. 
    /// </para>
    /// <code>
    /// // It is assumed that target is a target passed to the command. 
    /// // Get the document.
    /// IPoderosaDocument doc = 
    ///   CommandTargetUtil.AsDocumentOrViewOrLastActivatedDocument(target);
    /// if (doc != null)
    /// {
    ///   // Get the session.
    ///   ISession session = doc.OwnerSession;
    ///   // Convert to terminal session.
    ///   ITerminalSession termsession = 
    ///     (ITerminalSession)session.GetAdapter(typeof(ITerminalSession));
    /// }
    /// </code>
    /// </description>
    /// </item>
    /// </list>
    /// </para>
    /// </en>
    /// </remarks>
    public interface ITerminalSession : ISession {
        /// <summary>
        /// <ja>^[~iðÇ·éIuWFNgÅ·B</ja>
        /// <en>Object that manages terminal.</en>
        /// </summary>
        /// <remarks>
        /// <ja>±ÌIuWFNgÍAóMðtbNµ½¢êâOðÆè½¢êÈÇÉp¢Ü·B</ja><en>This object uses transmitting and receiving to hook and to take the log. </en>
        /// </remarks>
        AbstractTerminal Terminal {
            get;
        }
        /// <summary>
        /// <ja>
        /// ^[~iÌ[U[C^[tFCXðñ·éRg[Å·B
        /// </ja>
        /// <en>
        /// Control that offers user interface of terminal.
        /// </en>
        /// </summary>
        TerminalControl TerminalControl {
            get;
        }
        /// <summary>
        /// <ja>^[~iÝèð¦·IuWFNgÅ·B</ja>
        /// <en>Object that shows terminal setting.</en>
        /// </summary>
        ITerminalSettings TerminalSettings {
            get;
        }
        /// <summary>
        /// <ja>^[~iÌÚ±ð¦·IuWFNgÅ·B</ja>
        /// <en>Object that shows connection of terminal.</en>
        /// </summary>
        ITerminalConnection TerminalConnection {
            get;
        }
        /// <summary>
        /// <ja>L·éEBhEð¦µÜ·B</ja>
        /// <en>The owned window is shown. </en>
        /// </summary>
        IPoderosaMainWindow OwnerWindow {
            get;
        }
        /// <summary>
        /// <ja>^[~iÖÌM@\ðñµÜ·B</ja>
        /// <en>The transmission function to the terminal is offered. </en>
        /// </summary>
        TerminalTransmission TerminalTransmission {
            get;
        }
    }


    /// <summary>
    /// <ja>
    /// ^[~iT[rXðñ·éC^[tFCXÅ·B
    /// </ja>
    /// <en>
    /// Interface that provides terminal service.
    /// </en>
    /// </summary>
    /// <remarks>
    /// <ja>
    /// <para>
    /// ±ÌC^[tFCXÍAVKTelnet^SSH^CygwinÚ±Ì@\ðñµÜ·B
    /// </para>
    /// <para>
    /// TerminalSessionPluginvOCivOCIDFuorg.poderosa.terminalsessionsvjÉæÁÄ
    /// ñ³êÄ¨èAÌæ¤ÉµÄæ¾Å«Ü·B
    /// </para>
    /// <code>
    /// ITerminalSessionsService termservice = 
    ///  (ITerminalSessionsService)PoderosaWorld.PluginManager.FindPlugin(
    ///     "org.poderosa.terminalsessions", typeof(ITerminalSessionsService));
    /// Debug.Assert(termservice != null);
    /// </code>
    /// </ja>
    /// <en>
    /// <para>
    /// This interface offers the function of a new Telnet/SSH/Cygwin connection. 
    /// </para>
    /// <para>
    /// It is offered by the TerminalSessionPlugin plug-in (plugin ID[org.poderosa.terminalsessions]) , and it is possible to get it as follows. 
    /// </para>
    /// <code>
    /// ITerminalSessionsService termservice = 
    ///  (ITerminalSessionsService)PoderosaWorld.PluginManager.FindPlugin(
    ///     "org.poderosa.terminalsessions", typeof(ITerminalSessionsService));
    /// Debug.Assert(termservice != null);
    /// </code>
    /// </en>
    /// </remarks>
    public interface ITerminalSessionsService : IAdaptable {
        /// <summary>
        /// <ja>
        /// VK^[~iÚ±ð·é½ßÌC^[tFCXð¦µÜ·B
        /// </ja>
        /// <en>
        /// The interface to connect a new terminal is shown. 
        /// </en>
        /// </summary>
        ITerminalSessionStartCommand TerminalSessionStartCommand {
            get;
        }
        /// <summary>
        /// <ja>
        /// Ú±R}hÌJeSð¦µÜ·B
        /// </ja>
        /// <en>
        /// The category of connected command is shown. 
        /// </en>
        /// </summary>
        ICommandCategory ConnectCommandCategory {
            get;
        }
    }

    /// <summary>
    /// <ja>
    /// VK^[~iÌÚ±@\ðñ·éC^[tFCXÅ·B
    /// </ja>
    /// <en>
    /// Interface that offers connected function of new terminal.
    /// </en>
    /// </summary>
    /// <remarks>
    /// <ja>±ÌC^[tFCXÍA<seealso cref="Poderosa.Sessions.ITerminalSessionsService">ITerminalSessionsServicen</seealso>Ì
    /// <see cref="Poderosa.Sessions.ITerminalSessionsService.TerminalSessionStartCommand">TerminalSessionStartCommandvpeB</see>
    /// ©çæ¾Å«Ü·B</ja>
    /// <en>This interface can be got from the <see cref="Poderosa.Sessions.ITerminalSessionsService.TerminalSessionStartCommand">TerminalSessionStartCommand property</see> of ITerminalSessionsServicen. </en>
    /// </remarks>
    public interface ITerminalSessionStartCommand : IPoderosaCommand {
        /// <summary>
        /// <ja>ù¶ÌÚ±ðp¢ÄVK^[~iZbVðJnµÜ·B</ja><en>A new terminal session is begun by using an existing connection. </en>
        /// </summary>
        /// <param name="target"><ja>^[~iÉÑÂ¯ér[Ü½ÍEBhE</ja><en>View or window that ties to terminal</en></param>
        /// <param name="existing_connection"><ja>ù¶ÌÚ±IuWFNg</ja><en>Existing connected object</en></param>
        /// <param name="settings"><ja>^[~iÝèªi[³ê½IuWFNg</ja><en>Object where terminal setting is stored</en></param>
        /// <returns><ja>Jn³ê½^[~iZbVªÔ³êÜ·</ja><en>The begun terminal session is returned. </en></returns>
        /// <overloads>
        /// <summary>
        /// <ja>VK^[~iÚ±ðJnµÜ·B</ja><en>Start a new terminal session.</en>
        /// </summary>
        /// </overloads>
        ITerminalSession StartTerminalSession(ICommandTarget target, ITerminalConnection existing_connection, ITerminalSettings settings);
        //ITerminalParameterÍATelnet/SSH/CygwinÌ¢¸ê©Å éKvª éB
        /// <summary>
        /// <ja>
        /// Ú±p[^ðp¢ÄVKÚ±ðµA»Ì^[~iZbVðJnµÜ·B
        /// </ja>
        /// <en>
        /// It newly connects by using connected parameter, and the terminal session is begun. 
        /// </en>
        /// </summary>
        /// <param name="target"><ja>^[~iÉÑÂ¯ér[Ü½ÍEBhE</ja><en>View or window that ties to terminal</en></param>
        /// <param name="destination">
        /// <ja>Ú±Ìp[^ªi[³ê½IuWFNgB
        /// <seealso cref="ICygwinParameter">ICygwinParameter</seealso>A
        /// <seealso cref="ISSHLoginParameter">ISSHLoginParameter</seealso>A
        /// <seealso cref="ITCPParameter">ITCPParameter</seealso>Ì¢¸ê©ÅÈ¯êÎÈèÜ¹ñB</ja>
        /// <en>
        /// Object where parameter when connecting it is stored. 
        /// It should be either <seealso cref="ICygwinParameter">ICygwinParameter</seealso>, <seealso cref="ISSHLoginParameter">ISSHLoginParameter</seealso> or <seealso cref="ITCPParameter">ITCPParameter</seealso>. </en>
        /// </param>
        /// <param name="settings"><ja>^[~iÝèªi[³ê½IuWFNg</ja><en>Object where terminal setting is stored</en></param>
        /// <returns><ja>Jn³ê½^[~iZbVªÔ³êÜ·</ja><en>The begun terminal session is returned. </en></returns>
        ITerminalSession StartTerminalSession(ICommandTarget target, ITerminalParameter destination, ITerminalSettings settings);

        /// <summary>
        /// <ja>ZbVÆÍ³ÖWÉÚ±¾¯J«Ü·</ja>
        /// <en>Opens not any session but connection</en>
        /// </summary>
        /// <exclude/>
        ITerminalConnection OpenConnection(IPoderosaMainWindow window, ITerminalParameter destination, ITerminalSettings settings);

        void OpenShortcutFile(ICommandTarget target, string filename);
    }

    //ITerminalParameterðCX^VG[gµÄITerminalConnectionÉ·éExtensionPointÌC^tF[X
    /// <summary>
    /// 
    /// </summary>
    /// <exclude/>
    public interface ITerminalConnectionFactory {
        bool IsSupporting(ITerminalParameter param, ITerminalSettings settings);
        ITerminalConnection EstablishConnection(IPoderosaMainWindow window, ITerminalParameter param, ITerminalSettings settings);
    }


    //OC_CAOÌg¢èüãpÌT|[g
    /// <summary>
    /// 
    /// </summary>
    /// <exclude/>
    public interface ITelnetSSHLoginDialogInitializeInfo : IAdaptable {
        //Ú±æóâ
        void AddHost(string value);
        void AddAccount(string value);
        void AddIdentityFile(string value);
        void AddPort(int value);
    }

    /// <summary>
    /// 
    /// </summary>
    /// <exclude/>
    public interface ITelnetSSHLoginDialogInitializer {
        void ApplyLoginDialogInfo(ITelnetSSHLoginDialogInitializeInfo info);
    }

    //Extension Pointªñ
    //ùÉi[³êÄ¢éîñÍó³È¢æ¤É·éÌª[
    /// <summary>
    /// 
    /// </summary>
    /// <exclude/>
    public interface ILoginDialogUISupport {
        //QÂÌßèlª éÌÅoutðg¤BadapterÍATerminalParameterÌíÞðwè·é½ßÌøBÎ·éàÌªÈ¢Æ«ÍnullðÔ·
        void FillTopDestination(Type adapter, out ITerminalParameter parameter, out ITerminalSettings settings);
        //zXg¼Åwè·é
        void FillCorrespondingDestination(Type adapter, string destination, out ITerminalParameter parameter, out ITerminalSettings settings);
    }

    //Terminal SessionÅLIvV
    /// <summary>
    /// 
    /// </summary>
    /// <exclude/>
    public interface ITerminalSessionOptions {
        bool AskCloseOnExit {
            get;
            set;
        }

        //preference editor only
        int TerminalEstablishTimeout {
            get;
        }
        string GetDefaultLoginDialogUISupportTypeName(string logintype);
    }

}
