class DiscussionsController < PostsController
  
  cattr_accessor :page_depth
  @@page_depth = 3
  
  def index
    @page_nbr = params[:page] || 1
    @posts_collection = Discussion.roots.order("#{@sort_on} #{@sort_order}").page(@page_nbr).per(10)
    @table_options = { :records => @posts_collection, :remote => true }
    render :layout => !request.xhr?
  end
  
  
  def show
    if (@options[:view] == 'linear')
      @post_tree = @post_instance.subtree.order("created_at asc").page(@page_nbr).per(50)
      @table_options = { :records => @post_tree, :remote => true }
      render :action => 'linear_show', :layout => !request.xhr?
    else
      @post_tree = Post.sort_by_ancestry(@post_instance.subtree(:to_depth => @@page_depth))
      @top_post_depth = @post_instance.ancestor_ids.length
      render :action => 'nested_show', :layout => !request.xhr?
    end
  end
  
  
  def create
    create_post
    redirect_to :action => :show, :id => @post_instance.root_id
  end
  
  
  def reply
    @parent_post = Discussion.find(params[:id])
    @post_ancestry = @parent_post.ancestor_ids.push(params[:id])
    @post_instance = Discussion.new(:ancestry => @post_ancestry.join("/"))
    render :layout => !request.xhr?
  end
  
  
  def edit
    begin
      @parent_post = Discussion.find(@post_instance.parent_id)
    rescue
      @parent_post = nil
    end
    render :layout => !request.xhr?
  end
  
  
  def update
    update_post
    redirect_to params[:request][:referer]
  end
  
  
  def destroy
    @post_instance.destroy
    if @post_instance.is_root?
      redirect_to :action => :index
    else
      redirect_to :action => :show, :id => @post_instance.root_id
    end
  end
  
end