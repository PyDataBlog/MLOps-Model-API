#!/usr/bin/env bash
# vim: fdm=marker
# Create kaldi lang from a pair of lexicon and phoneset
#***************************************************************************
# Copyright 2011-2015, cybeliak
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#***************************************************************************

# Part of this script is from the general design of the Kaldi project
# which is released with Apache 2.0 license
# http://kaldi.sourceforge.net/

sil_state=5
nonsil_state=3
sil_prob=0.3
oov="<unk>"
keep_disambig=true

source mpn_steps/common/include.sh || exit 7
if [[ $# != 3 ]]; then
   echo "Usage: $0 [options] <lex-dir> <pset-dir> <out-dir>";
   exit 1;
fi
lexdir=$1
psetdir=$2
dir=$3

tmpdir="${TMPROOT:-$dir}/tmp-$(basename $0)"
mkdir -p "$dir" "$tmpdir"

# Cleaning up
rm -rf $dir/dict $dir/*.fst

# The main part {{{

# Create dict/
lexagg="$(mpn_common_lex_get_lex "$lexdir")"
mkdir -p $dir/dict
install $psetdir/{*_phones,extra_questions,optional_silence}.txt $dir/dict/
eval "${lexagg//$'\n'/}" \
  | cut -d' ' -f1,2,4- > $dir/dict/lexiconp.txt

# Actually generate the lang
LC_ALL=C utils/prepare_lang.sh --num-sil-states $sil_state \
    --num-nonsil-states $nonsil_state --sil-prob $sil_prob \
    $dir/dict "$oov" "$tmpdir" $dir

# Delete L_disambig if needed
if ! $keep_disambig; then
  rm -f $dir/L_disambig.fst
fi
# }}}

if [[ -d "$tmpdir" && -n "$tmpdir" ]]; then rm -rf "$tmpdir"; fi
echo "Succeeded running $0 "; exit 0

## SEC ## display
printf "%s > %s" $(basename ${ARGS[0]}) $(basename ${ARGS[2]})
## ENDSEC ##
## SEC ## output
2 kaldilang
## ENDSEC ##
## SEC ## input
0 lex
1 phoneset
## ENDSEC ##
