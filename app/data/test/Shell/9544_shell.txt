# !/bin/sh
#

set -euo pipefail
trap "echo 'error: Script failed: see failed command above'" ERR

. $(dirname "$0")/../../../scripts/libs/utils.sh
use_red_green_echo 'Ruby Install'

VERSION="2.5"
MIN_VERSION=".1"
ROOT_DIR=$(dirname $0)
cd $ROOT_DIR

_compile_ruby(){
  tar -Jxf $1
  
  local rubySrcDir="ruby-src"
  utils_untar_to_dir "$1" "ruby-$VERSION$MIN_VERSION" $rubySrcDir 0
  
  # need install openssl first
  cd $rubySrcDir \
  && ./configure --prefix=$ROOT_DIR/ruby \
  --disable-install-doc \
  --with-opt-dir=/usr/local/opt/openssl \
  && make && make install
  
  rm -f $1
  rm -rf $rubySrcDir
  rm -rf ruby-$VERSION$MIN_VERSION
}

run(){
  if [ -d ruby ]; then
    green "Ruby v$VERSION already installed"
    exit 0
  fi
  
  local rubyFileName='ruby_src.tar.xz'
  utils_download_to_file $rubyFileName https://cache.ruby-lang.org/pub/ruby/$VERSION/ruby-$VERSION$MIN_VERSION.tar.xz
  (_compile_ruby $rubyFileName)
}

run


