#!/bin/sh

# cleans up temporary files
function cleanup () {
  rm -rf ${DIRNAME} ${TARBALL}
  cd ${PREVDIR}
}

PREVDIR="$(pwd)"
DIRNAME="avarice"
CODEDIR="${PREVDIR}/avarice-code"
OUTDIR="${PREVDIR}/${DIRNAME}"
SVNLOG="/tmp/svn.log"
CONFIGLOG="/tmp/configure.log"
MAKELOG="/tmp/make.log"

# don't make a mess in a directory we care about
cd /tmp

# download the source tarball
echo "Downloading avarice source..."
if [ -f "${PREVDIR}/${CODEDIR}" ]; then
  cp -r "${PREVDIR}/${CODEDIR}" ./
else
  svn checkout "svn://svn.code.sf.net/p/avarice/code/trunk/avarice" "${CODEDIR}" > "${SVNLOG}"
  if [ $? -gt 0 ]; then
    echo "ERROR: source download failed. See ${SVNLOG}"
    cleanup
    exit 1
  fi
fi

# configure build
echo "Configuring avarice build..."
cd "${CODEDIR}"
./Bootstrap > "${CONFIGLOG}"
./configure --prefix="${OUTDIR}" >> "${CONFIGLOG}"
if [ $? -gt 0 ]; then
  echo "ERROR: build configuration failed. See ${CONFIGLOG}"
  cleanup
  exit 2
fi

# build
echo "Building avarice..."
make > "${MAKELOG}"
if [ $? -gt 0 ]; then
  echo "ERROR: build failed. See ${MAKELOG}"
  cleanup
  exit 3
fi

# copy build products out
mkdir -p "${OUTDIR}"
make install >> "${MAKELOG}"
if [ $? -gt 0 ]; then
  echo "ERROR: install failed. See ${MAKELOG}"
  cleanup
  exit 4
fi

# cleanup
cleanup
rm -rf "${CONFIGLOG}" "${MAKELOG}"
echo "Done! Check ${OUTDIR}"

