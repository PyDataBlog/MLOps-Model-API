#!/bin/bash

# Copyright 2014 Ryan Warren
# 
# This file is part of Project Tools for Android.
# 
# Project Tools for Android is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# Project Tools for Android is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with Project Tools for Android.If not, see <http://www.gnu.org/licenses/>.

########################################
# @author ryancwarren@icloud.com
# @date Fri  4 Jul 2014 22:31:12 ADT
# project-build-android.sh [android target]
########################################
PROGRAM_NAME=$(basename $(pwd))
SOURCES=
TARGET=
if [ ! -e '.project-android' ]
then
    echo "error: Use $0 only on projects created with Project Tools for Android"
    exit 1
fi

if [ -z $ANDROID_HOME ]
then
    echo "error: \$ANDROID_HOME must be set."
    exit 1
fi

if [ -z $1 ]
then
    echo  "usage: $0 <android target>"
    echo "example: $0 android-16"
    exit 1
else
    TARGET=$1
fi

# Will overwrite R.java.
aapt package -v -f -m -S $(pwd)/res -J $(pwd)/src -M $(pwd)/AndroidManifest.xml -I "$ANDROID_HOME"/platforms/$TARGET/android.jar

for i in $(find src -type f -name *.java); do SOURCES+=" $(pwd)/$i" ; done

# Will overwrite class files.
javac -g -verbose -d $(pwd)/obj -classpath $ANDROID_HOME/platforms/$TARGET/android.jar:$(pwd)/obj $SOURCES

# Will overwrite dex file.
dx --dex --verbose --output=bin/classes.dex obj lib

# Does not overwrite the apk file.
rm bin/$PROGRAM_NAME-debug.unsigned.apk
aapt package -v -f -M AndroidManifest.xml -S res -I $ANDROID_HOME/platforms/$TARGET/android.jar -F bin/$PROGRAM_NAME-debug.unsigned.apk bin

# Will overwrite apk.
jarsigner -verbose -keystore $PROGRAM_NAME-debug.keystore -storepass password -keypass password -signedjar bin/$PROGRAM_NAME-debug.signed.apk bin/$PROGRAM_NAME-debug.unsigned.apk $PROGRAM_NAME-debug
