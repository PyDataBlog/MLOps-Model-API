#!/usr/bin/env bash
#
# pocky/travis/install.sh


_dir=$(readlink -f $(dirname ${BASH_SOURCE})/..)

function _install_lein()
{
    url_lein="https://raw.github.com/technomancy/leiningen/stable/bin/lein"
    echo -n && \
        mkdir -p ${1} && \
        curl -s -o ${1}/lein ${url_lein} && \
        chmod u+x ${1}/lein
}


function _add_to_path()
{
    for arg in ${@}
    do
        cmd="export PATH=${arg}:${PATH}"
        echo "$ ${cmd}" && eval ${cmd}
    done
}


which_lein2=$(which lein2)


if [[ -n ${which_lein2} ]]
then
    # this should only happen on travis
    which_lein=$(which lein)
    echo -n                                      && \
        sudo rm -vf ${which_lein}                && \
        sudo ln -vs ${which_lein2} ${which_lein} && \
        exit 0 || exit 1
fi


if [[ -z `which lein` ]]
then
    if [[ ! -x ${_dir}/bin/lein ]]
    then
        _install_lein ${_dir}/bin
    fi
    _add_to_path ${_dir}/bin
fi


lein_maj=$(lein version | awk '{print $2}' | awk -F'.' '{print $1}')


if [[ 2 > ${lein_maj} ]]
then
    _install_lein ${_dir}/bin
    _add_to_path ${_dir}/bin
fi
