#!/bin/bash

PROJECT_TARGET="xpbot"
PROJECT_FILES="`cd src && ls *.c* sha1/*.c sqlite/*.c* expat/*.c*`"
CXXFLAGS="-Os -pipe -march=native -mtune=native -g -fpermissive"
COMPILER="clang++"
INCLUDE="-Isrc/expat -Isrc/sha1 -Isrc/sqlite"
LIBS="-lsqlite3 -lexpat -lpcre -lstdc++"
DEFINE="-DUNIX"

for i in ${PROJECT_FILES}; do
	NAME=$(echo $i | sed -e 's/\.[^.]*$//' | sed -e 's/^[^/]*\///')
	COMMAND="${COMPILER} -Wall -c -I. ${INCLUDE} ${CXXFLAGS} ${DEFINE} -o ./build/${NAME}.o ./src/${i}"
	echo ${COMMAND}
	${COMMAND} || { echo "Failed to compile ${i}!"; exit 1; }
	PROJECT_OBJECT="${PROJECT_OBJECT} ./build/${NAME}.o"
done

COMMAND="${COMPILER} -o ./${PROJECT_TARGET} ${PROJECT_OBJECT} ${LIBS}"
echo ${COMMAND}
${COMMAND} || { echo "Failed to link executable!"; exit 1; }
