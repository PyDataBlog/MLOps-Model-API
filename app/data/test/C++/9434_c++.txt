//---------------------------------------------------------------------------
#include "Unit1.h"
//---------------------------------------------------------------------------

//#include <windows.h>
#pragma hdrstop
//#include <condefs.h>
//#include <stdio.h>
//#include <stdlib.h>
//#include <string.h>
//#include <mem.h>
#include <time.h>
#include "Uart.h"
#include "Uart.cpp"
USEUNIT("Uart.cpp");
#pragma argsused
TUart g_Uart;
BYTE GetStrByte( char *HexStr, int StartIndex );
int token(char *str1,char *str2,int pos);
char sb[10000];
int motorandphonebyte(char *HexStr);
#pragma package(smart_init)
#pragma resource "*.dfm"
TWebModule1 *WebModule1;
//¤Á°OUart.cpp¤£¥i¥[¤Jproject1.bpr¤§¤¤
//---------------------------------------------------------------------------
__fastcall TWebModule1::TWebModule1(TComponent* Owner)
	: TWebModule(Owner)
{
}
//---------------------------------------------------------------------------
void __fastcall TWebModule1::WebModule1WebActionItem1Action(
      TObject *Sender, TWebRequest *Request, TWebResponse *Response,
      bool &Handled)
{
 Response->Content=easzydown->Content();
}
//---------------------------------------------------------------------------
void __fastcall TWebModule1::WebModule1WebActionItem3Action(
      TObject *Sender, TWebRequest *Request, TWebResponse *Response,
      bool &Handled)
{
 start=clock();
 AnsiString cont=AnsiString("<HTML><TITLE>ªü¥°ªººôÆg¤§»·ºÝ¶Ç°T</TITLE>");//¦¹¦æ¥i¥Î¨Ó§@¤U¦C¦UÅÜ¼Æªº²£¥Í¤§¶}ÀY
 pos=0;HexTextLength=0;
 strcpy(ContentStr,Request->Content.c_str());
 while((pos=token(ContentStr,division,pos))!=-1)//§ì¨ú¦U§Oªº¼Æ­È
 {
  s=division;//°»¿ù®É¡A±Ncont=cont+AnsiString("**");¥[©óÅÜ¼Æ«e«á§Y¥i¤è«K°»¿ù
  oldtonew=s;
  size=oldtonew.Pos('-');
  if(!strncmp(division,"name=\"state\"",12))
   state=oldtonew.SubString(17,size-19);
  if(!strncmp(division,"name=\"data\"",11))
   data=oldtonew.SubString(16,size-18);
  if(!strncmp(division,"name=\"master\"",13))
   master=oldtonew.SubString(18,size-20);
  if(!strncmp(division,"name=\"phonenumber\"",18))
   phonenumber=oldtonew.SubString(23,size-25);
 }
 ////////////////////////////////////////////////////////////////////////
 if(StrToInt(state)==5 && data.Length()<3)//Á×§K¿ï²Ä¤@ª¬ªp¦ý¬O«o¨S¦³¶ñ¦ì²¾¶q
 {
  cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/warning.gif\" width=\"40\" height=\"40\">");
  cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
  cont=cont+AnsiString( "<FONT SIZE=4 COLOR=#FF0000>²¾°Ê¶qªº¶ñªÅ³B¦n¹³¤£¤Ó¹ï³á¡I°O±o­Y¬O¿ï¨ú¡§««ª½¡B¤ô¥­¶b©w¦ì±±¨î¡¨³o­Ó¿ï¶µ¡A½Ð±N¤ô¥­¼Æ­È½Õ¦Ü-389->389¤§¶¡¡A««ª½­È½Õ¦Ü-111->111¤§¶¡¡A¨Ã½Ð©ó¨â¼Æ­È¤§¶¡¥[¤@³r¸¹','¡C</FONT><BR>" );
  cont=cont+AnsiString( "<CENTER><H2><FONT SIZE=3>¦^¤W¤@­¶¥h¶ñ§a¡I</FONT></H2><HR><BR></HTML>" );
  cont=cont+AnsiString("<hr><center><FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
  Response->Content=cont;
  return;
 }   //trueªí¥Ü¨S¦³ªF¦è //Check phonenumber ¤Îmaster
 if((StrToInt(state)==9 || StrToInt(state)==10) && (master.IsEmpty() || phonenumber.IsEmpty()))
 { //¥u­nevent³o­Óradio button³Q¿ï¨ú¡A«h«e­±¨â­Óedit¥²¶·³£¶ñ¸ê®Æ¡C
  cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/questionmark.gif\" width=\"40\" height=\"40\">");
  cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
  cont=cont+AnsiString( "<FONT SIZE=4 COLOR=#FF0000>Man in Mirror?Do you like Michael Jackson?I love him so much.</FONT><BR>" );
  cont=cont+AnsiString( "<CENTER><H2><FONT SIZE=3>¦^¤W¤@­¶¥h¶ñ¼g¹q¸Ü¸¹½X¡B©e°U¤H©m¦W§a¡I</FONT></H2><HR><BR></HTML>" );
  cont=cont+AnsiString("<hr><center><FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
  Response->Content=cont;
  return;
 }
 if(g_Uart.Initialize(2,CBR_115200,8,0,0)==false)//¶}±Òport
 {
  cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/warning.gif\" width=\"40\" height=\"40\">");
  cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
  cont=cont+AnsiString( "<FONT SIZE=5 COLOR=#FF0000>²{¦b¤u§@°ð¥¿¦b¤u§@¡A½Ðµy¥Î¦A¸Õ¡C</FONT><BR></html>" );
  cont=cont+AnsiString("<hr><center><FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
  Response->Content=cont;
  return;
 }             //¥H¤U«K¬O­ì¨Óµ{¦¡°¨¹Fªº³¡¤À¡A¥Ø«e©³¤U²{¦b¬O¶ÇÂ²°Tªº³¡¥÷
 //g_Uart.ResetPLC();                       //­«¸m51
 g_Uart.SetParity((Byte)3);//³]©w°e¯¸¦Wªºparity¡A¤@¶}©l´N°eªº­ì¦]¬O¦]¬°¤U­±¥|­Ó³£»Ý­n
 switch((int)StrToInt(state))
 {
  case 5:
  {
   //¦b´ú¸Õªº®É­Ôª`·N¬O§_»Ý­n­«¸m51
   statecontent="««ª½¡B¤ô¥­¶b©w¦ì±±¨î";
   Byte sb[10];
   int i,j,index;
   long x_value,y_value;
   String x_valuecontent,y_valuecontent;
   g_Uart.WriteByte((Byte)5); Sleep(10); //Send StationNO 1
   String xyvalue=data;        //§ì¨údata¤Wªº¸ê®Æ
   xyvalue=xyvalue.Trim();           //§â©Ò¦³«e«áªºªÅ¥Õ³£¥h°£±¼
   if((index=xyvalue.Pos(','))==0) //½T©wdata¸Ì­±¦³','³o­ÓªF¦è¡C
   {
    cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/warning.gif\" width=\"40\" height=\"40\">");
    cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
    cont=cont+AnsiString( "<FONT SIZE=4 COLOR=#FF0000>²¾°Ê¶qªº¶ñªÅ³B¦n¹³¤£¤Ó¹ï³á¡I°O±o­Y¬O¿ï¨ú¡§««ª½¡B¤ô¥­¶b©w¦ì±±¨î¡¨³o­Ó¿ï¶µ¡A½Ð±N««ª½¼Æ­È½Õ¦Ü-200->200¤§¶¡¡A¤ô¥­­È½Õ¦Ü-389->389¤§¶¡¡A¨Ã½Ð©ó¨â¼Æ­È¤§¶¡¥[¤@³r¸¹','¡C</FONT><BR>" );
    cont=cont+AnsiString( "<CENTER><H2><FONT SIZE=3>¦^¤W¤@­¶¥h¶ñ§a¡I</FONT></H2><HR><BR></HTML>" );
    cont=cont+AnsiString("<hr><center><FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
    Response->Content=cont;
    return;
   }
   x_valuecontent=xyvalue.SubString(1,index-1);
   y_valuecontent=xyvalue.SubString(index+1,xyvalue.Length());
   for(int i=1;i<=x_valuecontent.Length();++i)   //X­ÈªºªºÀË´ú
   {  //³oÃä¬O°µÁ×§K¦³¤@¨Ç¶Ã¤C¤K¾Dªº­^¤å¦r¡A©Î¬O¤@¨Ç©_©Çªº²Å¸¹
    if(x_valuecontent.SubString(i,1)<'-' || x_valuecontent.SubString(i,1)=='.' || x_valuecontent.SubString(i,1)=='/' || x_valuecontent.SubString(i,1)>'9')
    {
     cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/warning.gif\" width=\"40\" height=\"40\">");
     cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
     cont=cont+AnsiString( "<FONT SIZE=4 COLOR=#FF0000>²¾°Ê¶qªº¶ñªÅ³B¦n¹³¤£¤Ó¹ï³á¡I°O±o­Y¬O¿ï¨ú¡§««ª½¡B¤ô¥­¶b©w¦ì±±¨î¡¨³o­Ó¿ï¶µ¡A½Ð±N««ª½¼Æ­È½Õ¦Ü-200->200¤§¶¡¡A¨Ã½Ð©ó¨â¼Æ­È¤§¶¡¥[¤@³r¸¹','¡C</FONT><BR>" );
     cont=cont+AnsiString( "<CENTER><H2><FONT SIZE=3>¦^¤W¤@­¶¥h¶ñ§a¡I</FONT></H2><HR><BR></HTML>" );
     cont=cont+AnsiString("<hr><center><FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
     Response->Content=cont;
     return;
    }
   }
   for(int i=1;i<=y_valuecontent.Length();++i)   //Y­ÈªºÀË´ú
   {  //³oÃä¬O°µÁ×§K¦³¤@¨Ç¶Ã¤C¤K¾Dªº­^¤å¦r¡A©Î¬O¤@¨Ç©_©Çªº²Å¸¹
    if(y_valuecontent.SubString(i,1)<'-' || y_valuecontent.SubString(i,1)=='.' || y_valuecontent.SubString(i,1)=='/' || y_valuecontent.SubString(i,1)>'9')
    {
     cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/warning.gif\" width=\"40\" height=\"40\">");
     cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
     cont=cont+AnsiString( "<FONT SIZE=4 COLOR=#FF0000>²¾°Ê¶qªº¶ñªÅ³B¦n¹³¤£¤Ó¹ï³á¡I°O±o­Y¬O¿ï¨ú¡§««ª½¡B¤ô¥­¶b©w¦ì±±¨î¡¨³o­Ó¿ï¶µ¡A½Ð±N¤ô¥­¼Æ­È½Õ¦Ü-389->389¤§¶¡¡A¨Ã½Ð©ó¨â¼Æ­È¤§¶¡¥[¤@³r¸¹','¡C</FONT><BR>" );
     cont=cont+AnsiString( "<CENTER><H2><FONT SIZE=3>¦^¤W¤@­¶¥h¶ñ§a¡I</FONT></H2><HR><BR></HTML>" );
     cont=cont+AnsiString("<hr><center><FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
     Response->Content=cont;
     return;
    }
   }
   x_value=StrToInt(x_valuecontent)*25/9;y_value=StrToInt(y_valuecontent)*225/9;
  /* if((x_value>-111 && x_value<111)==false || (y_value>-389 && y_value<389)==false)
   {
    if((x_value>-111 && x_value<111)==false)
    {
     cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/warning.gif\" width=\"40\" height=\"40\">");
     cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
     cont=cont+AnsiString( "<FONT SIZE=4 COLOR=#FF0000>²¾°Ê¶qªº¶ñªÅ³B¦n¹³¤£¤Ó¹ï³á¡I°O±o­Y¬O¿ï¨ú¡§««ª½¡B¤ô¥­¶b©w¦ì±±¨î¡¨³o­Ó¿ï¶µ¡A½Ð±N««ª½¼Æ­È½Õ¦Ü-111->111¤§¶¡¡A¨Ã½Ð©ó¨â¼Æ­È¤§¶¡¥[¤@³r¸¹','¡C</FONT><BR>" );
     cont=cont+AnsiString( "<CENTER><H2><FONT SIZE=3>¦^¤W¤@­¶¥h¶ñ§a¡I</FONT></H2><HR><BR></HTML>" );
     cont=cont+AnsiString("<hr><center><FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
     Response->Content=cont;
     return;
    }
    if((y_value>-389 && y_value<389)==false)
    {
     cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/warning.gif\" width=\"40\" height=\"40\">");
     cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
     cont=cont+AnsiString( "<FONT SIZE=4 COLOR=#FF0000>²¾°Ê¶qªº¶ñªÅ³B¦n¹³¤£¤Ó¹ï³á¡I°O±o­Y¬O¿ï¨ú¡§««ª½¡B¤ô¥­¶b©w¦ì±±¨î¡¨³o­Ó¿ï¶µ¡A½Ð±N¤ô¥­¼Æ­È½Õ¦Ü-389->389¤§¶¡¡A¨Ã½Ð©ó¨â¼Æ­È¤§¶¡¥[¤@³r¸¹','¡C</FONT><BR>" );
     cont=cont+AnsiString( "<CENTER><H2><FONT SIZE=3>¦^¤W¤@­¶¥h¶ñ§a¡I</FONT></H2><HR><BR></HTML>" );
     cont=cont+AnsiString("<hr><center><FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
     Response->Content=cont;
     return;
    }
   }    */
   for(i=3,j=7;i>=0;--i,--j)
   {
    sb[i]=x_value%256;    //X¶b¦û4²ÕByte¡A¥ý¨ú³Ì¦ì¼Æªº¾l¼Æ¡A
    x_value/=256;         //§â­ì­È§@256¤À³Î«áªº­È¡A§@¬°¤U¦¸ªº¾l¼Æ¨ú±o¡C
    if(x_valuecontent.ToInt()<0)//³o¤@ºØ±¡§Î¥u¦³µo¥Í¦b­tªº­È¡A¥¿ªº­È¤£»Ý­n¦p¦¹³B²z¡C
     x_value=x_value-1;
    sb[j]=y_value%256;              //Y¶b¦û4²ÕByte
    y_value/=256;
    if(y_valuecontent.ToInt()<0)
     y_value=y_value-1;
   }
   for(int i=0;i<=7;++i)
   {g_Uart.WriteByte((Byte)sb[i]);Sleep(10);}
   break;
  }
  case  6:statecontent="««ª½¡B¤ô¥­¶b¦ì¸mÂk¹s ";g_Uart.WriteByte((Byte)6);Sleep(10);break;
  case  7:statecontent="¥ú·½°lÁa¾¹±±¨î";g_Uart.WriteByte((Byte)7);Sleep(10);break;
  case  8:statecontent="¥ú·½¡B¥Ë´µ¼Æ­È";g_Uart.WriteByte((Byte)8);Sleep(10);break;
  case  9:
  case 10:
  {
   if(StrToInt(state)==9)
    statecontent="¹q¸Ü¼·¸Ü";
   else
    statecontent="¤õÄµ¹w§i";
   String remotenote=phonenumber;//¥H¤U«K¬O­ì¨Óµ{¦¡¤â¾÷ªº³¡¤À¡A¥Ø«e©³¤U²{¦b¬O¶ÇÂ²°Tªº³¡¥÷
   if(remotenote.Length()<=8)   //ÀË¬dªº°Ê§@¡A§C©ó¤K½X¤@«ß©Úµ´
   {
    cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/questionmark.gif\" width=\"40\" height=\"40\">");
    cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
    cont=cont+AnsiString( "<FONT SIZE=5 COLOR=#FF0000>§Aªº¹q¸Ü¸¹½X¦n¹³©Ç©Çªº¡C</FONT><BR></html>" );
    cont=cont+AnsiString("<hr><center><FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
    Response->Content=cont;
    return;
   }
   for(int i=1;i<=remotenote.Length();++i)//ÀË¬dªº°Ê§@¡A¥u¦³±µ¨ü¼Æ¥Ø¦r¡A­^¤å¦r¤£±µ¨ü
   {
    if(remotenote.SubString(i,1)<'0' || remotenote.SubString(i,1)>'9')
    {
     cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/warning.gif\" width=\"40\" height=\"40\">");
     cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
     cont=cont+AnsiString( "<FONT SIZE=5 COLOR=#FF0000>§Aªº¹q¸Ü¸¹½X¦n¹³©Ç©Çªº¡C</FONT><BR></html>" );
     cont=cont+AnsiString("<hr><center><FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
     Response->Content=cont;
     return;
    }
   }                             //Â²°Tµ{¦¡ªº¯u¥¿¶}©l°_ÀY
   String letterrealcode,lettermidcode,lettercode="1e000c02004000010001020007918896130000990000000011000000160a91b881201563a7000000000000d7b0dc9d769f432150cb98969741417658de6e010142";
   char tempmidcode[15],*s;
   int letterxoroddresult=0,letterxorevenresult=0,letterlen;
   swab(remotenote.c_str(),tempmidcode,10);
   tempmidcode[10]='\0';
   s=tempmidcode;
   lettermidcode=s;
   letterrealcode=lettercode.Insert(lettermidcode,63);
   for(int i=1;i<=letterrealcode.Length();i+=4)
   {
    String odd=letterrealcode.SubString(i,2);letterxoroddresult^=motorandphonebyte(odd.c_str());
    String even=letterrealcode.SubString(i+2,2);letterxorevenresult^=motorandphonebyte(even.c_str());
   }
   letterlen=strlen(tempmidcode);
/////////////////////////////////////////////////////////////////////////////////
   String dialmidcode=phonenumber;     //©³¤U¬O¼·¸¹³¡¥÷ªº­ìµ{¦¡½X¡C
   String dialrealcode,dialcode="1e000c010010001000100501010581010000010141";
   if(dialmidcode.Length()==9)                 //¤E½Xªº¬°¤E
   {dialcode.Insert('9',12);dialcode.Insert('9',22);dialcode.Insert("00",45);}//¦]¬°¬O¤E½X©Ò¥H³Ì«á­n´¡¤J00H
   else                                       //¤Q½Xªº¬°A
   {dialcode.Insert('a',12);dialcode.Insert('a',22);}
   int dialxoroddresult=0,dialxorevenresult=0,diallen=1+2*dialmidcode.Length();
   for(int i=1;i<diallen;i+=2)
   dialmidcode.Insert('3',i);
   dialrealcode=dialcode.Insert(dialmidcode,23);
   for(int i=1;i<=dialrealcode.Length();i+=4)
   {
    String odd=dialrealcode.SubString(i,2);dialxoroddresult^=motorandphonebyte(odd.c_str());
    String even=dialrealcode.SubString(i+2,2);dialxorevenresult^=motorandphonebyte(even.c_str());
   }
//////////////////////////////////////////////////////////////////////////
   g_Uart.WriteByte((Byte)StrToInt(state)); //°e¯¸¦W
   Sleep(10);
   for(int i=0;i<letterlen;i+=2)       //¥H¤U¶}©l°e    //¥H¤U¬OÂ²°Tªº³¡¥÷
   {
    Byte num=StrToInt(tempmidcode[i])*16+StrToInt(tempmidcode[i+1]);
    g_Uart.WriteByte((Byte)num);   Sleep(10);
   }
   g_Uart.WriteByte((Byte)letterxoroddresult);   Sleep(10);
   g_Uart.WriteByte((Byte)letterxorevenresult);  Sleep(10);
///////////////////////////////////////////////////////////////////////
   diallen=dialmidcode.Length();    //¥H¤U¬O¼·¸¹ªº³¡¥÷
   for(int i=1;i<=diallen;i+=2)
   {
    Byte num=StrToInt(dialmidcode.SubString(i,1))*16+StrToInt(dialmidcode.SubString(i+1,1));
    g_Uart.WriteByte(num);
    Sleep(10);
   }
   if(dialmidcode.Length()==18)
   {
    g_Uart.WriteByte((Byte)0);
    Sleep(10);
   }
   g_Uart.WriteByte((Byte)dialxoroddresult);  Sleep(10);
   g_Uart.WriteByte((Byte)dialxorevenresult); Sleep(10);
   g_Uart.WriteByte((Byte)dialmidcode.Length()/2);        Sleep(10);
   break;
  }
  case 11:statecontent="­«¸m°¨¹F±±¨î¾¹";g_Uart.WriteByte((Byte)11);Sleep(10);break;
 }
///////////////////////////////////////////////////////////////////////////
 end=clock();      //Dump Report Info
 totaltime=(end-start)/CLK_TCK;
 float money=totaltime*0.00167;
 cont=cont+AnsiString( "<img border=\"0\" src=\"/scriptsimages/ok.gif\" width=\"30\" height=\"30\">");
 cont=cont+AnsiString( "<FONT SIZE=3>¥D¤H¡I½Ð°ÝÁÙ¦³¤°»ò©R¥O¡I</FONT><BR>" );
 cont=cont+AnsiString( "<FONT SIZE=2>¨Ï¥ÎªÌ¦ì§} : </font>")+AnsiString("<font size=2 color=#ef0fef>")+AnsiString(Request->RemoteAddr)+AnsiString("</FONT><BR>");
 if(StrToInt(state)==9 || StrToInt(state)==10)
 {
  cont=cont+AnsiString( "<FONT SIZE=2>©e  °U  ¤H :</font> ")+AnsiString("<font size=2 color=#ef0fef>")+AnsiString(master)+AnsiString("</FONT><BR>");
  cont=cont+AnsiString( "<FONT SIZE=2>¹q¸Ü¸¹½X : </font>")+AnsiString("<font size=2 color=#ef0fef>")+AnsiString(phonenumber)+AnsiString("</FONT><BR>");
  cont=cont+AnsiString("<font size=2 color=#f0000>§Aª¾¹D¶Ü¡H</font><font size=2 color=#000000>­Y¬O¥H¤¤µØ¹q«Hªº»ù½X¨Óºâ¡A¤Wºôªº­p»ù¤è¦¡®t¤£¦h¬O10¤ÀÄÁ1¶ô¿ú¡A¤]´N¬O1¬íÄÁ0.00167¶ô¿ú¡A¦ý¬O²{¦b§A­è­è¤Wºô¤U¸üªº®É¶¡«o¥u»Ý­nªá");
  cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/money.gif\" width=\"15\" height=\"15\">")+AnsiString("<font size=2 color=#ef0fef>")+AnsiString(money)+AnsiString("</font>");
  cont=cont+AnsiString("¶ô¿ú¡A´N¥i¥H¥D°ÊÅý§O¤è¥´¹q¸Üµ¹§A¡A§A»¡³o¼Ë­n¤£­n±`¤W¡§ªü¥°ªººôÆg¡¨¨Ó¬Ù¿ú°Ú¡I</font><br>");
 }
 cont=cont+AnsiString( "<FONT SIZE=2>³B²zª¬ºA :</font> ")+AnsiString("<font size=2 color=#ef0fef>")+AnsiString(statecontent)+AnsiString("</FONT><BR>");
 if(StrToInt(state)==5)
  cont=cont+AnsiString("<font size=2>««ª½¡B¤ô¥­¶bªº²¾°Ê¶q¬O :</font> ")+AnsiString("<font size=2 color=#ef0fef>")+AnsiString(data)+AnsiString("</font><br>");
 cont=cont+AnsiString("<font size=2>¥H¤W¦øªA¯¸©Ò°õ¦æªº®É¶¡ : </font>")+AnsiString("<font size=2 color=#ef0fef>")+AnsiString(totaltime)+AnsiString("¬í</font><BR>");
 cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
 cont=cont+AnsiString("<FORM action=\"/scripts/project1.exe/event3\" encType=\"multipart/form-data\" method=post>");
 cont=cont+AnsiString("<FONT face=·s²Ó©úÅé lang=ZH-TW size=1>");
 cont=cont+AnsiString("<P><font color=#5050ff>»· ºÝ ·P ´ú ¨t²Î¡G</font><input type=\"radio\" name=\"state\" value=\"11\"><font color=#8f088f>­«¸m°¨¹F±±¨î¾¹<img border=\"0\" src=\"/scriptsimages/motortozero.gif\" width=\"25\" height=\"12\"></font> </P>");
 cont=cont+AnsiString("<P><font color=#5050ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font>");
 cont=cont+AnsiString("<input type=\"radio\" name=\"state\" checked value=\"5\"><font color=#8f088f>««ª½¡B¤ô¥­¶b©w¦ì±±¨î</font><input type=\"text\" name=\"data\" value=\"15,15\" size=\"7\" maxlength=\"9\">");
 cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/orientation.gif\" width=\"25\" height=\"28\"> </P>");
 cont=cont+AnsiString("<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
 cont=cont+AnsiString("<input type=\"radio\" name=\"state\" value=\"6\"><font color=#8f088f>««ª½¡B¤ô¥­¶b¦ì¸mÂk¹s</font>   <img border=\"0\" src=\"/scriptsimages/zero.GIF\"></P>");
 cont=cont+AnsiString("<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
 cont=cont+AnsiString("<input type=\"radio\" name=\"state\" value=\"7\"><font color=#8f088f>¥ú·½°lÁa¾¹±±¨î</font> <img border=\"0\" src=\"/scriptsimages/light.gif\" width=\"28\" height=\"28\"></P>");
 cont=cont+AnsiString("<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
 cont=cont+AnsiString("<input type=\"radio\" name=\"state\" value=\"8\"><font color=#8f088f>¥ú·½¡B¥Ë´µ¼Æ­È</font><img border=\"0\" src=\"/scriptsimages/number.gif\" width=\"28\" height=\"21\">  </P>");
 cont=cont+AnsiString("<P><font color=#5050ff>¤j­ô¤j¼·¸¹¨t²Î ¡G</font> </P>");
 cont=cont+AnsiString("<P>©e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;°U&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ¤H&nbsp;  ¡G<!--webbot   bot=\"Validation\"");
 cont=cont+AnsiString("S-Data-Type=\"String\" B-Allow-Letters=\"TRUE\" B-Value-Required=\"TRUE\"");
 cont=cont+AnsiString("I-Minimum-Length=\"1\" I-Maximum-Length=\"20\" --><INPUT name=\"master\" value=Allways size=\"20\" maxlength=\"20\">");
 cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/talking.gif\" width=\"32\" height=\"25\"> </P>");
 cont=cont+AnsiString("<P>¹q&nbsp;&nbsp;&nbsp; ¸Ü&nbsp;&nbsp;&nbsp; ¸¹&nbsp;&nbsp;&nbsp; ½X ¡G<!--webbot");
 cont=cont+AnsiString("bot=\"Validation\" S-Data-Type=\"Number\" S-Number-Separators=\"x.\"");
 cont=cont+AnsiString("B-Value-Required=\"TRUE\" I-Minimum-Length=\"9\" I-Maximum-Length=\"10\" --><INPUT name=\"phonenumber\" value=0939709036 size=\"20\" maxlength=\"10\">");
 cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/cellphone.gif\" width=\"28\" height=\"27\"> </P>");
 cont=cont+AnsiString("<P>³B&nbsp;&nbsp;&nbsp; ²z&nbsp;&nbsp;&nbsp; ¨Æ&nbsp;&nbsp;&nbsp; ¥ó ¡G<INPUT name=\"state\" type=radio value=9>");
 cont=cont+AnsiString("<font color=#8f088f>¹q¸Ü¼·¸¹</font><img border=\"0\" src=\"/scriptsimages/callsomebody.gif\" width=\"39\" height=\"30\"><INPUT name=\"state\" type=radio value=10>");
 cont=cont+AnsiString("<font color=#8f088f>¤õÄµ¹w§i</font><img border=\"0\" src=\"/scriptsimages/firealarm.gif\" width=\"53\" height=\"30\">");
 cont=cont+AnsiString("</P><P><INPUT type=submit value=¶}©l¶Ç°e><img border=\"0\" src=\"/scriptsimages/connecting.gif\" width=\"37\" height=\"25\"> </P></FONT></FORM></BODY>");
 cont=cont+AnsiString("</HTML>");
 Response->Content=cont;
 return;
}
//---------------------------------------------------------------------------
void __fastcall TWebModule1::WebModule1WebActionItem4Action(
      TObject *Sender, TWebRequest *Request, TWebResponse *Response,
      bool &Handled)
{
 start=clock();
 AnsiString cont=AnsiString("<HTML><TITLE>ªü¥°ªººôÆg¤§¾÷±ñ»y¨¥¤U¸ü8051ªO</TITLE>");//¦¹¦æ¥i¥Î¨Ó§@¤U¦C¦UÅÜ¼Æªº²£¥Í¤§¶}ÀY
 pos=0;HexTextLength=0;
 strcpy(ContentStr,Request->Content.c_str());
 while((pos=token(ContentStr,division,pos))!=-1)
 {
  //Read Filename
  if( !strcmp(division,"name=\"userfile\";"))
  {
   token(ContentStr,FilenameStr,pos);
   for( i = 0, j = 0; FilenameStr[i]!='\"'; i++ ) ;
   for( i++; FilenameStr[i]!='\"'; i++)
    FilenameStr[ j++ ] = FilenameStr[ i ];
   FilenameStr[ j ]='\0';
    //Read HexCode
   pos=token(ContentStr,HexTexttemp,pos);
   token(ContentStr,HexTexttemp,pos);
   s=HexTexttemp;
   HexTextStr=s;
   size=HexTextStr.Pos("--");
   HexTextStr=HexTextStr.SubString(30,size-34);
   HexTextStr=HexTextStr.Insert("-:",size-33);
   //cont=cont+AnsiString( HexTextStr );
   while((size=HexTextStr.Pos(':'))!=0)
   {
    HexTextStrDivision=HexTextStr.SubString(1,size-2);
    HexTextStrDivision=HexTextStrDivision.Insert(':',1);
    //cont=cont+AnsiString( HexTextStrDivision );//¥i¥Î¨ÓÆ[¹î¦UÅÜ¼Æªº§ì¨ú±¡§Î
    HexTextStr=HexTextStr.Delete(1,size);
    strcpy(Text,HexTextStrDivision.c_str());
    memcpy( ( (char*)( HexTextBuf + HexTextLength ) ), Text, strlen(Text) + 1 );
    HexTextLength += ( strlen(Text) + 1 );
   }
  }
  if(!strncmp(division,"name=\"COMPORT\"",14) || !strncmp(division,"name=\"DELAYTIME\"",16) || !strncmp(division, "name=\"STATIONNO\"",16))
  {
   number++;
   s=division;
   oldtonew=s;
   size=oldtonew.Pos('-');
   switch(number)
   {
    case 1:ComPortNo=oldtonew.SubString(19,size-21);break;    //Read ComPort
    case 2:DelayTimesStr=oldtonew.SubString(21,size-23);break;//Read DelayTimes
    case 3:StationNoStr=oldtonew.SubString(21,size-23);break; //Read StationNo
   }
  }
 }
 //AnsiString cont=AnsiString("<HTML><TITLE>ªü¥°ªººôÆg¤§¾÷±ñ»y¨¥¤U¸ü8051ªO</TITLE>");
  //Check HexFile Correction
 if( HexTextLength <=2 )
 {
  cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/questionmark.gif\" width=\"40\" height=\"40\">");
  cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
  cont=cont+AnsiString( "<FONT SIZE=5 COLOR=#FF0000>²£¥Í¿ù»~!</FONT><BR>" );
  cont=cont+AnsiString( "<FONT SIZE=3>¥i¯à¬OÀÉ®×ªº®æ¦¡¿ùÅý©Î¥¼¸ü¤JÀÉ®×¤£µM«K¬OÀÉ®×ªºªø«×¬ONULL¡A§A°Ý§ÚNULL¬O¤°»ò·N«ä¡H´N¬OªÅªÅ¦p¤]°Õ¡I</FONT><BR></HTML>" );
  cont=cont+AnsiString("<FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
  Response->Content=cont;
  return;
 }
   //Check StationNo Limited
 if(StationNoStr.ToInt()<0 || StationNoStr.ToInt()>255)
 {
  cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/warning.gif\" width=\"40\" height=\"40\">");
  cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
  cont=cont+AnsiString( "<FONT SIZE=5 COLOR=#FF0000>²£¥Í¿ù»~!</FONT><BR>" );
  cont=cont+AnsiString( "<FONT SIZE=3>µL«ü©w¯¸¦W</FONT><BR></HTML>");
  cont=cont+AnsiString("<FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
  Response->Content=cont;
  return;
 }
 StationNo=StationNoStr.ToInt();
 //Check DelayTimes Limited
 DelayTimes = DelayTimesStr.ToInt();
 if( DelayTimes < 0 || DelayTimes > 100001 )
 {
  cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/warning.gif\" width=\"40\" height=\"40\">");
  cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
  cont=cont+AnsiString( "<FONT SIZE=5 COLOR=#FF0000>²£¥Í¿ù»~!</FONT><BR>" );
  cont=cont+AnsiString( "<FONT SIZE=3>©µ¿ð®É¶¡¶W¥X½d³ò</FONT><BR></HTML>")+AnsiString(DelayTimes);
  cont=cont+AnsiString("<FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
  Response->Content=cont;
  return;
 }
 //Open and Check Serial port active
 if(ComPortNo.ToInt()==2)
  com=1;
 else
  com=0; //¥ªÃä³o¤@¦æ¬O¥¿½Tªºµ{¦¡½X¡A¤U­±³o¤@¦æ¬O¦]¬°§Úªºcom1µ¹·Æ¹«¥Î¤F¡A©Ò¥H¥u¦³com2¯à¤U¸ü¡C
 // com=1;
 if(g_Uart.Initialize( com, CBR_19200, 8, 0, 0 ) == false )
 {
  cont=cont+AnsiString("<img border=\"0\" src=\"scriptsimages/questionmark.gif\" width=\"40\" height=\"40\">");
  cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF000 BGCOLOR=#e8d088>");
  cont=cont+AnsiString( "<FONT SIZE=5 COLOR=#FF0000>²{¦b¤u§@°ð¥¿¦b¤u§@¡A½Ðµy¥Î¦A¸Õ¡C</FONT><BR></html>" );
  cont=cont+AnsiString("<FORM><INPUT Type=Button Value=\"ªð¦^¤W¤@­¶\" OnClick=\"history.back();\"></FORM></CENTER>");
  Response->Content=cont;
  return;
 }
 //Switch Ajon51-plc to DownLoad mode
 g_Uart.SetPLCMode( true );
 Sleep( 10 );
 g_Uart.ResetPLC();
 //Initialize HexCode Memory
 for( i = 0; i < HEXBUFSIZE; i++ )
  HexCodeBuf[ i ] = 0;
  //Transmite to Ajon51-plc
 if( HexTextLength > 0 )
 {
   //Convert HexText to HexCode
  HexTextPtr = HexTextBuf;
  for( HexCodeLength = 0, i = 0; i < HexTextLength; i += len )
  {
   Record_Count = GetStrByte( HexTextPtr, 1 );
   Record_Dph = GetStrByte( HexTextPtr, 3 );
   Record_Dpl = GetStrByte( HexTextPtr, 5 );
   Record_Dptr = (int) Record_Dph * 256 + Record_Dpl;
   HexCodeLength = max( HexCodeLength, ( Record_Dptr + Record_Count ) );
   for( j = 0; j < Record_Count; j++ )
    HexCodeBuf[ Record_Dptr + j ] = GetStrByte( HexTextPtr, (int) j * 2 + 9 );
   len = strlen( HexTextPtr ) + 1;
   HexTextPtr += len;
  }
  //Send StationNO to Ajon51-plc
  g_Uart.SetParity( 3 );
  g_Uart.WriteByte( (BYTE) StationNo );
  Sleep( 10 );
  g_Uart.SetParity( 4 );
  for( i = 0; i < HexCodeLength; i++ )
  {
   g_Uart.WriteByte( HexCodeBuf[ i ] );
   Sleep( DelayTimes );
  }
 }
  //Switch Ajon51-plc to Run mode
 g_Uart.SetPLCMode( false );
 Sleep(10);
 g_Uart.ResetPLC();

  //Dump Report Info
 cont=cont+AnsiString( "<img border=\"0\" src=\"/scriptsimages/ok.gif\" width=\"50\" height=\"50\">");
 cont=cont+AnsiString( "<FONT SIZE=4>¤U¸ü¦¨¥\¤FÅo¡I</FONT><BR>" );
 cont=cont+AnsiString( "<FONT SIZE=3>¨Ï¥ÎªÌ¦ì§} : ")+AnsiString(Request->RemoteAddr)+AnsiString("</FONT><BR>");
 cont=cont+AnsiString( "<FONT SIZE=3>¸ü¤JÀÉ®× : ")+AnsiString(FilenameStr)+AnsiString("</FONT><BR>");
 cont=cont+AnsiString( "<FONT SIZE=3>©µ¿ð®É¶¡ : ")+AnsiString(DelayTimes)+AnsiString("</FONT><BR>");
 cont=cont+AnsiString( "<FONT SIZE=3>¿é¥X¦ì¸m : COM")+AnsiString(ComPortNo)+AnsiString("</FONT><BR>");
 cont=cont+AnsiString( "<FONT SIZE=3>«ü©w¯¸¦W : ")+AnsiString(StationNo)+AnsiString("</FONT><BR>");
 cont=cont+AnsiString( "<FONT SIZE=3>ÀÉ®×¤º®e : ")+AnsiString(FilenameStr)+AnsiString("</FONT><BR>");
 if( HexTextLength > 0 )
 {
  for( HexTextPtr = HexTextBuf, i = 0; i < HexTextLength; i += len )
  {
   cont=cont+AnsiString("<FONT SIZE=3 COLOR=#FF0000>")+AnsiString(HexTextPtr)+AnsiString("</FONT><BR>");
   len = strlen( HexTextPtr ) + 1;
   HexTextPtr += len;
  }
 }
 end=clock();
 totaltime=(end-start)/CLK_TCK;
 cont=cont+AnsiString( "<H2>¥H¤W¦øªA¯¸©Ò°õ¦æªº®É¶¡ :")+AnsiString(totaltime)+AnsiString("¬í</h2><BR>");
 cont=cont+AnsiString("<BODY  TEXT=#008000 LINK=#000000 VLINK=#FF0000 BGCOLOR=#e8d088>");
 cont=cont+AnsiString("<H4>(1). ºô¸ô¸ü¤J</h4> <FORM ENCTYPE=\"multipart/form-data\" ACTION=\"/scripts/project1.exe/event4\" METHOD=post>");
 cont=cont+AnsiString("ÀÉ®×¦WºÙ(*.hex):<INPUT NAME=\"userfile\" TYPE=\"file\"SIZE=\"40\"><img border=\"0\" src=\"/scriptsimages/filename.gif\" width=\"30\" height=\"30\"><P>");
 cont=cont+AnsiString("¿é¥X¦ì¸m(¦øªAºÝ):<input type=\"radio\" NAME=\"COMPORT\" value=\"1\">COM1");
 cont=cont+AnsiString("<input type=\"radio\" checked NAME=\"COMPORT\" value=\"2\">COM2<img border=\"0\" src=\"/scriptsimages/port.gif\" width=\"55\" height=\"22\"><p>");
 cont=cont+AnsiString("©µ¡@¿ð¡@®É¡@¶¡:<INPUT NAME=\"DELAYTIME\" value=\"15\"><img border=\"0\" src=\"/scriptsimages/time.gif\" width=\"25\" height=\"25\"> ¹w³]­È¬O«ØÄ³­È¡A³Ì¦n¤£­n»´©ö§ó°Ê¡C<P>¯¸¡@¡@¡@¡@¦W¡@:<INPUT NAME=\"STATIONNO\" value=\"1\"><img border=\"0\" src=\"/scriptsimages/stationno.gif\" width=\"28\" height=\"26\"><P><P>");
 cont=cont+AnsiString("<INPUT TYPE=\"submit\" VALUE=\"¶}©l¶Ç¿é\" SIZE=\"40\">");
 cont=cont+AnsiString("<img border=\"0\" src=\"/scriptsimages/connecting.gif\" width=\"30\" height=\"25\"></FORM></body>");
 cont=cont+AnsiString("</html>");
 Response->Content=cont;
 return;
}
//---------------------------------------------------------------------------
BYTE GetStrByte( char *HexStr, int StartIndex )
{
   int i;
   BYTE StrByte, ch;
   for( StrByte = 0, i = StartIndex; i < StartIndex + 2; i++ )
   {
      StrByte *= (BYTE)16;
      ch = (BYTE) HexStr[ i ];
      if( (ch>='0') && (ch<='9') )
         StrByte += (BYTE) ( ch - '0' );
      else
         if( (ch>='a') && (ch<='z') )
            StrByte += (BYTE) ( ch - 'a' + 10 );
         else
            if( (ch>='A') && (ch<='Z') )
               StrByte += (BYTE) ( ch - 'A' + 10 );
   }
   return StrByte;
}
//-----------------------------------------------------------
int token(char *str1,char *str2,int pos)
{
 int i=pos,j;
 while(str1[i]==' ')
  i++;
 if(str1[i]!='\0')
 {
  j=0;
  while(str1[i]!='\0' && str1[i]!=' ')
  {str2[j]=str1[i];i++;j++;}
  str2[j]='\0';
  return i;
 }
 else
  return -1;
}
//---------------------------------------------------------------------------

void __fastcall TWebModule1::WebModule1WebActionItem2Action(
      TObject *Sender, TWebRequest *Request, TWebResponse *Response,
      bool &Handled)
{
 Response->Content=motorandphone->Content();
}
//---------------------------------------------------------------------------
void __fastcall TWebModule1::WebModule1WebActionItem5Action(
      TObject *Sender, TWebRequest *Request, TWebResponse *Response,
      bool &Handled)
{
 Response->Content=Request->Content;
}
//---------------------------------------------------------------------------
int motorandphonebyte(char *HexStr)
{
 int ch=0,StrByte=0;
 for(int i=0;i<2;++i)
 {
  ch=HexStr[i];
  if(ch>='0' && ch<='9')
   ch=ch-'0';
  if(ch>='a' && ch<='f')
   ch=(ch-'a')+10;
  if(ch>='A' && ch<='F')
   ch=(ch-'A')+10;
  if(!i)
   StrByte=ch*16;
  else
   StrByte=StrByte+ch;
 }
 return StrByte;
}
