%                                                         -*- coding: utf-8 -*-
%! \file    ~/utils/texttr.tex
%! \author  Jiří Kučera, <sanczes@gmail.com>
%! \stamp   2019-07-12 21:38:07 +0200
%! \project JK-TeX: Document typesetting macros for TeX.
%! \license MIT
%! \version See \JKTeXVersion.
%! \fdesc   Text transformation services.
%
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% Copyright (c) 2014 - 2019 Jiří Kučera.
%
% Permission is hereby granted, free of charge, to any person obtaining a copy
% of this software and associated documentation files (the "Software"), to deal
% in the Software without restriction, including without limitation the rights
% to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
% copies of the Software, and to permit persons to whom the Software is
% furnished to do so, subject to the following conditions:
%
% The above copyright notice and this permission notice shall be included in
% all copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
% IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
% FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
% AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
% LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
% OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
% IN THE SOFTWARE.
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\module{texttr}
  \author{Jiří Kučera, <sanczes@gmail.com>}
  \version\JKTeXVersion
  \license{MIT}

  \require{text}
  \require{fsm}

  % ===========================================================================
  % == 1) Common Utilities
  % ===========================================================================

  %%
  % \PackSymbolsAddExtra #1#2
  % ---------------------------------------------------------------------------
  % #1 - macro containing symbols
  % #2 - extra symbols
  % ---------------------------------------------------------------------------
  % Define #1 as `{<content of #1>}#2'.
  \gdef\PackSymbolsAddExtra #1#2{%
    \expandafter\def\expandafter#1\expandafter{\expandafter{#1}#2}%
  }

  %%
  % \PackSymbols #1
  % ---------------------------------------------------------------------------
  % #1 - macro containing symbols
  % ---------------------------------------------------------------------------
  % Define #1 as `{<content of #1>}'.
  \gdef\PackSymbols #1{%
    \PackSymbolsAddExtra#1{}%
  }

  %%
  % \SymbolsToUpper #1
  % ---------------------------------------------------------------------------
  % #1 - macro containing symbols
  % ---------------------------------------------------------------------------
  % Make symbols inside #1 upper case.
  \gdef\SymbolsToUpper #1{%
    \expandafter\DoSymbolsToUpper\expandafter#1\expandafter{#1}%
  }

  %%
  % \DoSymbolsToUpper #1#2
  % ---------------------------------------------------------------------------
  % #1 - where to store the result
  % #2 - symbols
  % ---------------------------------------------------------------------------
  % Auxiliary macro for \SymbolsToUpper.
  \gdef\DoSymbolsToUpper #1#2{%
    \uppercase{\def#1{#2}}%
  }

  %%
  % \SymbolsToLower #1
  % ---------------------------------------------------------------------------
  % #1 - macro containing symbols
  % ---------------------------------------------------------------------------
  % Make symbols inside #1 lower case.
  \gdef\SymbolsToLower #1{%
    \expandafter\DoSymbolsToLower\expandafter#1\expandafter{#1}%
  }

  %%
  % \DoSymbolsToLower #1#2
  % ---------------------------------------------------------------------------
  % #1 - where to store the result
  % #2 - symbols
  % ---------------------------------------------------------------------------
  % Auxiliary macro for \SymbolsToLower.
  \gdef\DoSymbolsToLower #1#2{%
    \lowercase{\def#1{#2}}%
  }

  %%
  % \TestIfAccented #1#2\\
  % ---------------------------------------------------------------------------
  % #1 - possible accent command
  % #2 - symbol(s)
  % ---------------------------------------------------------------------------
  % Test whether #1 is an accent command or not.
  \gdef\TestIfAccented #1#2\\{{%
    \global\infalse%
    \def\tempa{#1}%
    \def\do##1{{%
      \def\tempb{##1}%
      \ifx\tempa\tempb%
        \global\intrue%
      \fi%
    }}%
    \DoAccents%
  }}

  % ===========================================================================
  % == 2) Finite Automata for Text Processing
  % ===========================================================================

  %%
  % Finite automaton for text traversing.
  \FiniteAutomaton{TextTraverse}
    \FAErrorTransition{\start}{\sentinel}{Unexpected end of stream.}
    \FATransition{\start}{\bgroup}{FirstGroup}
    \FATransition{\start}{\spacetok}{FirstSpace}
    \FAErrorTransition{\start}{-}{Unexpected symbol.}
    \FAErrorTransition{\start}{/}{Unexpected symbol.}
    \FADefaultTransition{\start}{FirstSymbol}
    %%
    \FAAction{FirstGroup}#1{%
      \def\tempa{#1}%
      \TTOnFirstGroup\tempa%
      \TTXEmit\tempa%
      \FAMove{RestOfWord}%
    }
    \FAAction{FirstSpace}{%
      \FAMoveAfterSpace{\start}%
    }
    \FAAction{FirstSymbol}#1{%
      \def\tempa{#1}%
      \TTOnFirstSymbol\tempa%
      \TTXEmit\tempa%
      \FAMove{RestOfWord}%
    }
    %%
    \FATransition{RestOfWord}{\sentinel}{End}
    \FATransition{RestOfWord}{\bgroup}{Group}
    \FATransition{RestOfWord}{\spacetok}{Space}
    \FATransition{RestOfWord}{-}{Dash}
    \FATransition{RestOfWord}{/}{Slash}
    \FADefaultTransition{RestOfWord}{Symbol}
    %%
    \FAAction{Group}#1{%
      \def\tempa{#1}%
      \TTOnGroup\tempa%
      \TTXEmit\tempa%
      \FAMove{RestOfWord}%
    }
    \FAAction{Symbol}#1{%
      \def\tempa{#1}%
      \TTOnSymbol\tempa%
      \TTXEmit\tempa%
      \FAMove{RestOfWord}%
    }
    \FAAction{Space}{%
      \TTOnSpace\tempa%
      \TTXEmit\tempa%
      \FAMoveAfterSpace{\start}%
    }
    \FAAction{Dash}{%
      \TTOnDash\tempa%
      \TTXEmit\tempa%
      \FAMoveAfterToken{\start}%
    }
    \FAAction{Slash}{%
      \TTOnSlash\tempa%
      \TTXEmit\tempa%
      \FAMoveAfterToken{\start}%
    }
    %%
    \FAAction{End}#1\sentinel{%
      \TTOnEnd%
    }
  \EndFiniteAutomaton

  % ===========================================================================
  % == 3) Text Processing Finite Automata Hooks
  % ===========================================================================

  %%
  % \TTOnFirstGroup #1
  % ---------------------------------------------------------------------------
  % #1 - macro with group content
  % ---------------------------------------------------------------------------
  % Invoked by \TextTraverse when the first token of the word is a group.
  \gdef\TTOnFirstGroup #1{%
    \PackSymbols#1%
  }

  %%
  % \TTOnFirstSymbol #1
  % ---------------------------------------------------------------------------
  % #1 - macro with symbol
  % ---------------------------------------------------------------------------
  % Invoked by \TextTraverse when the first token of the word is a symbol.
  \gdef\TTOnFirstSymbol #1{%
  }

  %%
  % \TTOnGroup #1
  % ---------------------------------------------------------------------------
  % #1 - macro with group content
  % ---------------------------------------------------------------------------
  % Invoked by \TextTraverse when a non-first token of the word is a group.
  \gdef\TTOnGroup #1{%
    \PackSymbols#1%
  }

  %%
  % \TTOnSymbol #1
  % ---------------------------------------------------------------------------
  % #1 - macro with symbol
  % ---------------------------------------------------------------------------
  % Invoked by \TextTraverse when a non-first token of the word is a symbol.
  \gdef\TTOnSymbol #1{%
  }

  %%
  % \TTOnSpace #1
  % ---------------------------------------------------------------------------
  % #1 - control sequence with peeked token meaning
  % ---------------------------------------------------------------------------
  % Invoked by \TextTraverse when a space token is met.
  \gdef\TTOnSpace #1{%
    \def#1{\space}%
  }

  %%
  % \TTOnDash #1
  % ---------------------------------------------------------------------------
  % #1 - control sequence with peeked token meaning
  % ---------------------------------------------------------------------------
  % Invoked by \TextTraverse when a dash (`-') is met.
  \gdef\TTOnDash #1{%
    \def#1{-}%
  }

  %%
  % \TTOnSlash #1
  % ---------------------------------------------------------------------------
  % #1 - control sequence with peeked token meaning
  % ---------------------------------------------------------------------------
  % Invoked by \TextTraverse when a slash (`/') is met.
  \gdef\TTOnSlash #1{%
    \def#1{/}%
  }

  %%
  % \TTOnEnd
  % ---------------------------------------------------------------------------
  % Invoked by \TextTraverse when the end of input stream was reached.
  \gdef\TTOnEnd{%
  }

  %%
  % \TTEmit #1
  % ---------------------------------------------------------------------------
  % #1 - tokens
  % ---------------------------------------------------------------------------
  % Appends #1 to the end of macro stored in \tempb.
  \gdef\TTEmit #1{%
    \expandafter\addtok\tempb{#1}%
  }

  %%
  % \TTXEmit #1
  % ---------------------------------------------------------------------------
  % #1 - macro
  % ---------------------------------------------------------------------------
  % Appends the content of #1 to the end of macro stored in \tempb.
  \gdef\TTXEmit #1{%
    \expandafter\TTEmit\expandafter{#1}%
  }

  % ===========================================================================
  % == 4) Text Processors and Transformers
  % ===========================================================================

  %%
  % \TextTraverse #1<text>\sentinel
  % ---------------------------------------------------------------------------
  % #1 - where to store the result
  % ---------------------------------------------------------------------------
  % Traverse a text symbol by symbol, applying transformations specified by
  % \TT* callbacks on it. Uses \tempa and \tempb.
  \gdef\TextTraverse #1{%
    \def\tempb{#1}%
    \FAStart{TextTraverse}%
  }

  %%
  % \DotAfterInitialLetter #1
  % ---------------------------------------------------------------------------
  % #1 - `true' or `false'
  % ---------------------------------------------------------------------------
  % Allow (true) or forbid (false) placing the dot after initial letter in
  % \GetInitialLetters.
  \NewIf\DotAfterInitialLetter

  %%
  % \GetInitialLetters #1<text>\sentinel
  % ---------------------------------------------------------------------------
  % #1 - where to store the result
  % ---------------------------------------------------------------------------
  % Extracts initial letters from <text>, keeps dashes and spaces.
  \gdef\GetInitialLetters #1{%
    \def\TTOnFirstGroup ##1{%
      \IfDotAfterInitialLetter%
        \PackSymbolsAddExtra##1{.}%
      \else%
        \PackSymbols##1%
      \fi%
    }%
    \def\TTOnFirstSymbol ##1{%
      \IfDotAfterInitialLetter%
        \addtok##1{.}%
      \fi%
    }%
    \def\TTOnGroup ##1{%
      \def##1{}%
    }%
    \def\TTOnSymbol ##1{%
      \def##1{}%
    }%
    \def\TTOnSpace ##1{%
      \def##1{\space}%
    }%
    \def\TTOnDash ##1{%
      \def##1{-}%
    }%
    \def\TTOnSlash ##1{%
      \def##1{/}%
    }%
    \def\TTOnEnd{%
    }%
    \TextTraverse#1%
  }

  %%
  % \TextToUpper #1
  % ---------------------------------------------------------------------------
  % #1 - macro with text
  % ---------------------------------------------------------------------------
  % Makes letters in #1 upper case.
  \gdef\TextToUpper #1{%
    \def\TTOnFirstGroup ##1{%
      \expandafter\TestIfAccented##1\\%
      \ifin%
        \SymbolsToUpper##1%
      \fi%
      \PackSymbols##1%
    }%
    \def\TTOnFirstSymbol ##1{%
      \SymbolsToUpper##1%
    }%
    \def\TTOnGroup ##1{%
      \expandafter\TestIfAccented##1\\%
      \ifin%
        \SymbolsToUpper##1%
      \fi%
      \PackSymbols##1%
    }%
    \def\TTOnSymbol ##1{%
      \SymbolsToUpper##1%
    }%
    \def\TTOnSpace ##1{%
      \def##1{\space}%
    }%
    \def\TTOnDash ##1{%
      \def##1{-}%
    }%
    \def\TTOnSlash ##1{%
      \def##1{/}%
    }%
    \def\TTOnEnd{%
    }%
    \edef#1{\expandafter}\expandafter\TextTraverse\expandafter#1#1\sentinel%
  }

  %%
  % \TextToLower #1
  % ---------------------------------------------------------------------------
  % #1 - macro with text
  % ---------------------------------------------------------------------------
  % Makes letters in #1 lower case.
  \gdef\TextToLower #1{%
    \def\TTOnFirstGroup ##1{%
      \expandafter\TestIfAccented##1\\%
      \ifin%
        \SymbolsToLower##1%
      \fi%
      \PackSymbols##1%
    }%
    \def\TTOnFirstSymbol ##1{%
      \SymbolsToLower##1%
    }%
    \def\TTOnGroup ##1{%
      \expandafter\TestIfAccented##1\\%
      \ifin%
        \SymbolsToLower##1%
      \fi%
      \PackSymbols##1%
    }%
    \def\TTOnSymbol ##1{%
      \SymbolsToLower##1%
    }%
    \def\TTOnSpace ##1{%
      \def##1{\space}%
    }%
    \def\TTOnDash ##1{%
      \def##1{-}%
    }%
    \def\TTOnSlash ##1{%
      \def##1{/}%
    }%
    \def\TTOnEnd{%
    }%
    \edef#1{\expandafter}\expandafter\TextTraverse\expandafter#1#1\sentinel%
  }

  %%
  % \TextInitialsUpper #1<text>\sentinel
  % ---------------------------------------------------------------------------
  % #1 - where to store the result
  % ---------------------------------------------------------------------------
  % Makes the initial letter of each word upper and the rest lower.
  \gdef\TextInitialsUpper #1{%
    \def\TTOnFirstGroup ##1{%
      \expandafter\TestIfAccented##1\\%
      \ifin%
        \SymbolsToUpper##1%
      \fi%
      \PackSymbols##1%
    }%
    \def\TTOnFirstSymbol ##1{%
      \SymbolsToUpper##1%
    }%
    \def\TTOnGroup ##1{%
      \expandafter\TestIfAccented##1\\%
      \ifin%
        \SymbolsToLower##1%
      \fi%
      \PackSymbols##1%
    }%
    \def\TTOnSymbol ##1{%
      \SymbolsToLower##1%
    }%
    \def\TTOnSpace ##1{%
      \def##1{\space}%
    }%
    \def\TTOnDash ##1{%
      \def##1{-}%
    }%
    \def\TTOnSlash ##1{%
      \def##1{/}%
    }%
    \def\TTOnEnd{%
    }%
    \TextTraverse#1%
  }

  %%
  % \TextFirstUpper #1<text>\sentinel
  % ---------------------------------------------------------------------------
  % #1 - where to store the result
  % ---------------------------------------------------------------------------
  % Makes the first letter of text upper ant the rest lower.
  \gdef\TextFirstUpper #1{%
    \def\TTOnFirstGroup ##1{%
      \def\TTOnFirstGroup ####1{%
        \expandafter\TestIfAccented####1\\%
        \ifin%
          \SymbolsToLower####1%
        \fi%
        \PackSymbols####1%
      }%
      \def\TTOnFirstSymbol ####1{%
        \SymbolsToLower####1%
      }%
      \expandafter\TestIfAccented##1\\%
      \ifin%
        \SymbolsToUpper##1%
      \fi%
      \PackSymbols##1%
    }%
    \def\TTOnFirstSymbol ##1{%
      \def\TTOnFirstGroup ####1{%
        \expandafter\TestIfAccented####1\\%
        \ifin%
          \SymbolsToLower####1%
        \fi%
        \PackSymbols####1%
      }%
      \def\TTOnFirstSymbol ####1{%
        \SymbolsToLower####1%
      }%
      \SymbolsToUpper##1%
    }%
    \def\TTOnGroup ##1{%
      \expandafter\TestIfAccented##1\\%
      \ifin%
        \SymbolsToLower##1%
      \fi%
      \PackSymbols##1%
    }%
    \def\TTOnSymbol ##1{%
      \SymbolsToLower##1%
    }%
    \def\TTOnSpace ##1{%
      \def##1{\space}%
    }%
    \def\TTOnDash ##1{%
      \def##1{-}%
    }%
    \def\TTOnSlash ##1{%
      \def##1{/}%
    }%
    \def\TTOnEnd{%
    }%
    \TextTraverse#1%
  }

\endmodule
