param($folder="C:\TransportAgents")

Write-Host "Running Agent UnInstallation script"

#*********************************Functions***********************************************

Function SetFolderPermissions ($folder) {

Write-host "Giving NetworkService permissions on $folder"

$Acl = Get-Acl $folder
$Ar = New-Object  system.security.accesscontrol.filesystemaccessrule("NetworkService","FullControl", "ContainerInherit,ObjectInherit","None","Allow")

$Acl.AddAccessRule($Ar) 

#$Acl.SetAccessRule($Ar)
Set-Acl $folder $Acl

Write-host "Permissions set on $folder"

}

Function UnInstallAgent($folder) {

$dllpath = $folder + "\PI.PiNuxeoAgent.dll"
Write-host "UnInstalling agent $dllPath"

Add-PSSNapin Microsoft.Exchange.Management.PowerShell.SnapIn

UnInstall-TransportAgent "PiNuxeoAgent"

Restart-Service MSExchangeTransport

}

#*****************************************************************************************


#*********************************Main****************************************************

SetFolderPermissions($folder)
UnInstallAgent($folder)
