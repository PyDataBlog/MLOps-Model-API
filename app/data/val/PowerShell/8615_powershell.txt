#################################################
#
#  this script has two functions: 
#  1.export apps package from the apps web to local
#  2.import local apps package to the host web
#
#################################################

Add-PsSnapin Microsoft.SharePoint.PowerShell


$input = Read-Host "if you want to export app package, please input 1, else input 2 "
if($input -eq '1')
{
    $webUrl = Read-Host "please input the host web url "
    #get host web 
    $hostWeb = Get-SPWeb -Identity $webUrl

    $path = Read-Host "please input the  directory which apps are export to "    
    if(![System.IO.Directory]::Exists($path))
    {
        [System.IO.Directory]::CreateDirectory($path)
    }

    #get apps instances
    $appInstances = [Microsoft.SharePoint.Administration.SPAppCatalog]::GetAppInstances($hostWeb)

    Write-Host ([System.String]::Format("there are {0} apps in the web {1}",$appInstances.Count,$hostWeb.Title))

    #get apps
    foreach($instance in $appInstances)
    {
        $filePath = $path.Trim('"') + '\\' + $instance.Title +".app"
        #export apps package
        Export-SPAppPackage -App $instance.App -Path $filePath
    }
}
else
{ 
    $webUrl = Read-Host "please input the web url which you want to install app, like http://hostname/sites/team/subweb "
    $hostWeb = Get-SPWeb -Identity $webUrl    
    $path = Read-Host "please input the app file path or directory"
    if([System.IO.File]::Exists($path))
    {
        $spapp = Import-SPAppPackage -Path $filePath -Site $hostWeb.Site -Source ObjectModel
        Install-SPApp -Identity $spapp -Web $webUrl
    }
    if([System.IO.Directory]::Exists($path))
    {
        $files = [System.IO.Directory]::GetFiles($path)
        foreach($appFile in $files)
        {
            if($appFile.EndsWith(".app"))
            {
                $spapp = Import-SPAppPackage -Path $appFile -Site $hostWeb.Site -Source ObjectModel -Confirm:$false
                Install-SPApp -Identity $spapp -Web $webUrl
            }
        }
    }
}
