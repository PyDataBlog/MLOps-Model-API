workflow virtualMachine-Stop
{
    param (
        [Parameter(Mandatory=$true)]
        [PSCredential] 
        $automationUser,

        [Parameter(Mandatory=$true)]
        [string] 
        $subscriptionName,

        [Parameter(Mandatory=$true)]
        [string] 
        $virtualMachineName,
        
        [Parameter(Mandatory=$true)]
        [boolean]
        $forceStop = $true
    )
    
    Add-AzureAccount -Credential $automationUser
    
    InlineScript 
    {
        Write-Output "Running on subscription '$using:subscriptionName'"
        Select-AzureSubscription -SubscriptionName $using:subscriptionName
        
        $vm = Get-AzureVM | Where-Object -FilterScript { $_.Name -eq $using:virtualMachineName }
        if ($vm)
        {
            Write-Output "Stopping Virtual Machine '$using:virtualMachineName'"
            if ($using:forceStop -eq $true)
            {
                Stop-AzureVM -ServiceName $vm.ServiceName -Name $vm.Name -Force
            }
            else
            {
                Stop-AzureVM -ServiceName $vm.ServiceName -Name $vm.Name
            }
        }
        else
        {
            Write-Output "Virtual Machine '$using:virtualMachineName' not found"
        }
    }
}
