# test step:
#   make all install_k test 2>&1 | tee rl

#kernel module
obj-m += kernel_mmap.o

#user space
user_srcs = user_mmap.cc
user_objs = $(user_srcs:%.cc=%.o)

.PHONY: all clean

all: kernel_mmap user_mmap

user_mmap: $(user_objs)
	g++ -pthread -o $@ $<

%.o: %.cc
	g++ -std=c++11 -g -fpermissive -o $@ -c $^

kernel_mmap:
	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules

clean_kernel_mmap:
	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean

install_k:
	# We put a — in front of the rmmod command to tell make to ignore
	# an error in case the module isn’t loaded.
	-sudo rmmod kernel_mmap
	# Clear the kernel log without echo
	sudo dmesg -C
	# Insert the module
	sudo insmod kernel_mmap.ko
	# Display the kernel log
	dmesg

uninstall_k:
	-sudo rmmod kernel_mmap

test:
	#/dev/mymap is owned by root user, so have to run with sudo
	-sudo ./user_mmap
	#after execute user space program, print linux kernel log ringbuffer again
	-dmesg

