#
# glavi Makefile
#
 
CC:=$(CC)
B2C=../../out/tools/bin2c
CFLAGS:=$(CFLAGS) -c -I../include -std=c11 -fsanitize=address
ifeq ($(CONFIG), DEBUG)
	CFLAGS:=$(CFLAGS) -g -DDEBUG
else
	CFLAGS:=$(CFLAGS) -O3
endif
ifeq ($(PROFILE), TRUE)
	CFLAGS:=$(CFLAGS) -pg
endif
ifeq ($(MACHINE), RPI)
	CFLAGS:=$(CFLAGS) -march=armv6j -mtune=arm1176jzf-s -mfpu=vfp -mfloat-abi=hard
endif
ifeq ($(MACHINE), ATOM)
	CFLAGS:=$(CFLAGS) -march=atom -mtune=atom
endif
ifeq ($(MACHINE), C2D)
	CFLAGS:=$(CFLAGS) -march=core2 -mtune=core2
endif
ifeq ($(MACHINE), AUTO)
	CFLAGS:=$(CFLAGS) -march=native -mtune=native
endif
ifeq ($(SERDBG), TRUE)
	CFLAGS:=$(CFLAGS) -DSERDBG
endif
UNAME:=$(shell uname)
LDFLAGS:=$(LDFLAGS) -L../../out/lib -lglautils -lglaipc -ljansson -lssl -lcrypto -lcurses -lpam -lGL -lglfw -lGLEW -lasan
ifeq ($(UNAME), Linux)
	LDFLAGS:=$(LDFLAGS) -lcrypt
endif
ifneq ($(UNAME), QNX)
	LDFLAGS:=$(LDFLAGS) -lpthread
else
	LDFLAGS:=$(LDFLAGS) -lsocket
endif
ifeq ($(UNAME), SunOS)
	LDFLAGS:=$(LDFLAGS) -lsocket -lnsl
	CFLAGS:=$(CFLAGS) -DSUNOS
endif
ifeq ($(UNAME), Darwin)
	CFLAGS:=$(CFLAGS) -Wno-deprecated-declarations -DOSX
else
	LDFLAGS:=$(LDFLAGS) -luuid
endif
ifeq ($(USEPWD), TRUE)
	CFLAGS:=$(CFLAGS) -DUSEPWD
endif
ifeq ($(HTTPDBG), TRUE)
	CFLAGS:=$(CFLAGS) -DHTTPDBG
endif

ifeq ($(UUID_BUILTIN), TRUE)
	CFLAGS:=$(CFLAGS) -I../../opt/include/uuid
	LDFLAGS:=$(LDFLAGS) -L../../out/lib
endif

SOURCES=main.c engine.c
IMGFILES=img/icon.png img/nav.png img/nav_l.png img/nav_r.png img/exit.png img/refresh.png
ICOFILES=img/favicon.ico
IMGHDR=$(IMGFILES:.png=.h)
ICOHDR=$(ICOFILES:.ico=.h)
OBJECTS=$(SOURCES:.c=.o)
EXECUTABLE=glavi
.SUFFIXES: .png .h .ico

#all: obj_dir $(IMGHDR) $(ICOHDR) $(SOURCES) $(EXECUTABLE)


all: obj_dir $(SOURCES) $(EXECUTABLE)

run: all
	../../out/bin/glavi

obj_dir:
	mkdir -p ../../build/$(EXECUTABLE) ; mkdir -p ../../build/$(EXECUTABLE)/webui
 
$(EXECUTABLE): $(OBJECTS)
	$(CC) -o ../../out/bin/$@ $(addprefix ../../build/$(EXECUTABLE)/, $(OBJECTS)) $(LDFLAGS) 
	
.c.o: $(DEPS)
	$(CC) $(CFLAGS) $(SVNREV) $< -o ../../build/$(EXECUTABLE)/$@

#.png.h: $(DEPS)
#	$(B2C) $< $@

#.ico.h: $(DEPS)
#	$(B2C) $< $@

clean:
	rm -rf ../../build/$(EXECUTABLE) && rm -rf ../../out/bin/$(EXECUTABLE) ; rm -rf img/*.h


