// app/routes.js

module.exports = function(app, request, Lob) {
    var googleApiKey = 'AIzaSyAVcJflF_0GpUzioGph0e8edJQeatd-330';

    app.get('/', function(req, res) {
        res.sendfile('./public/index.html');
    });

    app.get('/api/getreps', function(req, res) {
        var zip = req.query.zip;
        var url = 'https://www.googleapis.com/civicinfo/v2/representatives?address='+ zip +'&key=' + googleApiKey
        request(url, function (error, response, body) {
            var bodyObj = JSON.parse(body);
            if (!error && response.statusCode == 200) {
                var officials = bodyObj.officials;
                var offices = bodyObj.offices;
                if(officials && offices) {
                    var resObj = {};
                    resObj.userCity = bodyObj.normalizedInput.city;
                    resObj.userState = bodyObj.normalizedInput.state;
                    resObj.userZip = bodyObj.normalizedInput.zip;
                    resObj.reps = [];

                    for(var i = 0; i < offices.length; i++) {
                        for(var j = 0; j < offices[i].officialIndices.length; j++) {
                            var officialIndex = offices[i].officialIndices[j];
                            if(officials[officialIndex].address) {
                                var official = officials[officialIndex];
                                var rep = {};
                                rep.officeName = offices[i].name;
                                rep.repName = official.name;
                                rep.address = official.address[0];
                                rep.photoUrl = official.photoUrl;
                                resObj.reps.push(rep);
                            }
                        }
                    }
                    res.send(resObj);
                } else {
                    res.send(resObj);
                }
                
            } else {
                if(bodyObj.error) {
                    res.status(bodyObj.error.code);
                    res.send(bodyObj);
                } else {
                    res.status(404);
                    res.send(false);
                }
            }
        });        
    });

    app.post('/api/sendletter', function(req, res) {
        var letter = req.body;
        
        Lob.letters.create(letter, function (loberr, lobres) {
          if(loberr) {
            console.log('loberr:', loberr);
            res.status(loberr.status_code);
            res.send(loberr);
          }
          res.send(lobres);
        });
    });
};
