#!/bin/zsh --extended-glob

typeset fromdir="$1" # $1 -> Current mail directory 
typeset destdir="$2" # $2 -> Archive directory

lotate() {

  folder="$1" # path of current processing MH folder.


  # processing mails.
  if [[ -n "$folder" ]]
  then
    if ruby -e 'Dir.glob(ARGV[0]) {|i| File.basename(i) =~ /^\./ ? next : File.basename(i) =~ /^[1-9][0-9]*$/ ? exit(0) : next }' -e "exit(1)" "$destdir/${folder:+$folder/}"'[0-9]*'
    then
      typeset -i lastindex="${$(print "$destdir"/"${folder:+$folder/}"<->(n[-1]) ):t}" #Get file name of largest number.
    else
      typeset -i lastindex=0
    fi
    

    if ruby -e 'Dir.glob(ARGV[0]) {|i| File.basename(i) =~ /^\./ ? next : File.basename(i) =~ /^[1-9][0-9]*$/ ? exit(0) : next }' -e "exit(1)" "$fromdir/${folder:+$folder/}"'[0-9]*'
    then
      for i in "$fromdir"/"${folder:+$folder/}"<->(.n) 
      do
        mv -v "$i" "$destdir"/"${folder:+$folder/}"$(( lastindex + ${i:t} )) #merge
      done
    fi
  fi
  

  # processing directories.
  if ruby -e 'Dir.glob(ARGV[0]) {|i| File.basename(i) =~ /^\./ ? next : File.directory?(i) ? exit(0) : next }' -e "exit(1)" "$fromdir/${folder:+$folder/*}"
  then
    for i in "$fromdir"/"${folder:+$folder/}"*(/)
    do
      #print $i
      if [[ -e "$destdir"/"${folder}" ]]
      then
        # Destination folder is already exist.
        # recursive.
        lotate "${i#"$fromdir/"}"
      else
        # Destination folder is not exist.
        # move it.
        mv -v "$i" "$destdir/$folder"
      fi
    done
  fi
  
}

lotate