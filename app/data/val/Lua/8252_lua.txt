--BT3-018 Meta-Rilldo, Form Perfected
local ds=require "expansions.utility_dbscg"
local scard,sid=ds.GetID()
function scard.initial_effect(c)
	ds.EnableBattleAttribute(c)
	ds.AddSetcode(c,SPECIAL_TRAIT_MACHINE_MUTANT,CHARACTER_GENERAL_RILLDO)
	ds.AddPlayProcedure(c,COLOR_RED,4,3)
	--ex-evolve
	ds.EnableEXEvolve(c,scard.evofilter,COLOR_RED,1,0,1)
	--double strike
	ds.EnableDoubleStrike(c)
	--draw
	ds.AddActivateMainSkill(c,0,DS_LOCATION_BATTLE,scard.drop,scard.drcost,scard.drtg,DS_EFFECT_FLAG_CARD_CHOOSE,nil,1)
end
scard.dragon_ball_super_card=true
scard.combo_cost=1
--ex-evolve
function scard.evofilter(c)
	return c:IsColor(COLOR_RED) and c:IsCharacter(CHARACTER_GENERAL_RILLDO) and c:IsEnergyAbove(5)
end
--draw
function scard.costfilter(c)
	return c:IsCode(CARD_PLANET_M2) and (c:IsFaceup() or c:IsLocation(LOCATION_HAND)) and c:IsAbleToDropAsCost()
end
function scard.drcost(e,tp,eg,ep,ev,re,r,rp,chk)
	if chk==0 then return Duel.IsExistingMatchingCard(scard.costfilter,tp,LOCATION_HAND+DS_LOCATION_BATTLE,0,1,nil) end
	Duel.Hint(HINT_SELECTMSG,tp,DS_HINTMSG_TODROP)
	local g=Duel.SelectMatchingCard(tp,scard.costfilter,tp,LOCATION_HAND+DS_LOCATION_BATTLE,0,1,1,nil)
	Duel.SendtoDrop(g,REASON_COST)
end
function scard.drtg(e,tp,eg,ep,ev,re,r,rp,chk)
	if chk==0 then return Duel.IsPlayerCanDraw(tp,1) or Duel.GetLeaderCard(1-tp) end
	Duel.Hint(HINT_OPSELECTED,1-tp,e:GetDescription())
end
function scard.drop(e,tp,eg,ep,ev,re,r,rp)
	Duel.Draw(tp,2,DS_REASON_SKILL)
	local c=e:GetHandler()
	Duel.Hint(HINT_SELECTMSG,tp,DS_HINTMSG_POWERDOWN)
	local tc1=Duel.SelectMatchingCard(tp,ds.LeaderAreaFilter(Card.IsCanBeSkillTarget),tp,0,DS_LOCATION_LEADER,1,1,nil,e):GetFirst()
	if tc1 then
		Duel.BreakEffect()
		Duel.SetTargetCard(tc1)
		--power down
		ds.GainSkillUpdatePower(c,tc1,1,-5000)
	end
	local ct=Duel.GetMatchingGroupCount(ds.BattleAreaFilter(),tp,0,DS_LOCATION_BATTLE,nil)
	Duel.Hint(HINT_SELECTMSG,tp,DS_HINTMSG_POWERDOWN)
	local g=Duel.SelectMatchingCard(tp,ds.BattleAreaFilter(Card.IsCanBeSkillTarget),tp,0,DS_LOCATION_BATTLE,ct,ct,nil,e)
	if g:GetCount()==0 then return end
	Duel.BreakEffect()
	Duel.SetTargetCard(g)
	for tc2 in aux.Next(g) do
		--power down
		ds.GainSkillUpdatePower(c,tc2,2,-10000)
	end
end
