<?php

include './conexion.php';

@session_start();
if (!empty($_SESSION['user'])) {
    include './securityPermisionHandle.php';
    if (!checkUserPermissions(array('matr'), $_SESSION['userid']))
    {
        /////// Accion de salida
        $respuesta['estado'] = "0";
        $respuesta['mensajelog'] = 'Error en la confirmacion de permisos';
        $respuesta['mensaje'] = "Ha ocurrido un error.";
        print json_encode($respuesta);
        exit;
    }
} else {
    /////// Accion de salida
    $respuesta['estado'] = "0";
    $respuesta['mensajelog'] = 'Error en la confirmacion de permisos';
    $respuesta['mensaje'] = "Ha ocurrido un error.";
    print json_encode($respuesta);
    exit;
}

 $conn = dbConnect();
 $ini= $_POST["ini"];
 $fini= $_POST["fini"];
 
 $isInputKeyWordSetted = false;
if (isset($_POST['inputKeyWord']))
{
    if ($_POST['inputKeyWord'] != '')
    {
        $isInputKeyWordSetted = true;
    }
}
 
        try 
        {
            if ($isInputKeyWordSetted)
            {
                $inKWord = '%'.$_POST['inputKeyWord'].'%';
                
                $stmt = $conn->prepare("CALL INTRUCTORgetpersonasSearchByPage(:ini, :fini, :pkword);");
                $stmt->bindParam(':ini', $ini);
                $stmt->bindParam(':fini', $fini);
                $stmt->bindParam(':pkword', $inKWord);
                $stmt->execute();
                $respuesta['estado'] = "1";
                $respuesta['mensajelog'] = "Consulta Exitosa (getAll)";
                $respuesta['mensaje'] = "Consulta Exitosa.";
                $respuesta['resultados'] = $stmt->fetchAll(PDO::FETCH_ASSOC);
                print json_encode($respuesta);
            }
            else
            {
                $stmt = $conn->prepare("CALL INTRUCTORgetpersonasByPage(:ini, :fini);");
                $stmt->bindParam(':ini', $ini);
                $stmt->bindParam(':fini', $fini);

                $stmt->execute();
                $respuesta['estado'] = "1";
                $respuesta['mensajelog'] = "Consulta Exitosa (getAll)";
                $respuesta['mensaje'] = "Consulta Exitosa.";
                $respuesta['resultados'] = $stmt->fetchAll(PDO::FETCH_ASSOC);
                print json_encode($respuesta);
            }
        } catch (PDOException $e) {

            $respuesta['estado'] = "0";
            $respuesta['mensajelog'] = $e->getMessage();
            $respuesta['mensaje'] = "Ha ocurrido un error.";
             print json_encode($respuesta);
        }
    
    ?>
