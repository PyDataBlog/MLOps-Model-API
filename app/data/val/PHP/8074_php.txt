<?php

require_once('milestone_services.php');

class block_milestone extends block_base {

    /**#@+
     * Modes
     */
    const MODE_OPERATIONS_MENU       = 1;
    const MODE_MILESTONE_TARGET_NEXT = 2;
    /**#@-*/

    /**
     * @return void
     */
    public function init() {
        $this->title = get_string('milestone', 'block_milestone');
    }

    /**
     * @return true
     */
    public function instance_allow_multiple() {
        return true;
    }

    /**
     * @return stdClass
     * @throws Exception
     */
    public function get_content() {

        if ($this->content !== null) {
            return $this->content;
        }

        $this->content = new stdClass;

        $mode = self::MODE_OPERATIONS_MENU;

        if (!empty($this->config->mode)) {
            $mode = $this->config->mode;
        }

        switch ($mode) {
            case self::MODE_OPERATIONS_MENU:
                $this->content->text = $this->get_content_operations_menu();
                break;
            case self::MODE_MILESTONE_TARGET_NEXT:
                $this->content->text = $this->get_content_milestone_target_next();
                break;
            default:
                throw new Exception("Invalid mode '{$mode}'");
        }

        return $this->content;
    }

    /**
     * @return string
     */
    protected function get_content_milestone_target_next() {

        global $COURSE, $USER;

        $out = '';

        $milestoneservices = new milestone_services();

        $milestone = $milestoneservices->get_milestone_target_next($COURSE->id);

        if ($milestone) {
            $out .= '<div>Target for ' . userdate($milestone->datewhen, '%D') . ":<br>" .
                html_writer::link(
                    course_get_url($COURSE->id, $milestone->section),
                    "Section {$milestone->section}: " . s($milestone->name)
                ) . '</div>';
        }

        $usercourseprogress = $milestoneservices->get_user_course_progress($USER->id, $COURSE->id);

        $out .= <<<HTML
            <div class="user-course-progress">
                Course Progress:<br>
                <div class="user-course-progress-bar">
                    <div class="progress" style="width: {$usercourseprogress}%;"></div>
                </div>
            </div>
HTML;

        return $out;
    }

    /**
     * @return string
     */
    protected function get_content_operations_menu() {

        global $COURSE;

        return html_writer::link(
            new moodle_url(
                '/blocks/milestone/index.php',
                array(
                    'courseid' => $COURSE->id,
                )
            ),
            get_string('milestone:viewcalendar', 'block_milestone')
        );
    }
}
